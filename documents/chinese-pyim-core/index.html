<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>chinese-pyim-core - Chinese-pyim</title>
    <meta charset="utf-8" />
    <meta name="author" content="Feng Shu" />
    <link rel="stylesheet" href="https://tumashu.github.io/chinese-pyim/media/css/main.css" type="text/css">
  </head>
<body class="container">
    <div>
      <header class="masthead">
        <h1 class="masthead-title"><a href="https://tumashu.github.io/chinese-pyim/">Chinese-pyim</a> <span class="subtitle">(一个 emacs 环境下的中文拼音输入法)</span></h1>
        <ul>
          <li><a href="https://tumashu.github.io/chinese-pyim/documents/">Documents</a></li>
          <li><a href="https://tumashu.github.io/chinese-pyim/snapshots/">Snapshots</a></li>
          <li><a href="https://tumashu.github.io/chinese-pyim/tags/">Tags</a></li>
          <li><a href="https://tumashu.github.io/chinese-pyim/about/">About</a></li>
          <li><a href="https://github.com/tumashu/chinese-pyim">GitHub</a></li>
          <li><a href="https://tumashu.github.io/chinese-pyim/rss.xml">RSS</a></li>
        </ul>
        <form method="get" id="searchform" action="http://www.google.com/search">
          <input type="text" class="field" name="q" id="s" placeholder="Search">
          <input type="hidden" name="as_sitesearch" value="tumashu.github.io/chinese-pyim">
        </form>
        <img class="avatar" src="https://tumashu.github.io/chinese-pyim/media/img/horse.jpg" />
      </header>
    </div>

<div class="content-and-footer">
<div>
<div class="post">
<h1 class="post-title">chinese-pyim-core</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org1747aa4">1. 说明文档&#xa0;&#xa0;&#xa0;<span class="tag"><span class="doc">doc</span></span></a></li>
<li><a href="#orga3bbb5a">2. 核心代码&#xa0;&#xa0;&#xa0;<span class="tag"><span class="code">code</span></span></a>
<ul>
<li><a href="#orgda778c8">2.1. require + defcustom + defvar</a></li>
<li><a href="#orgf08e726">2.2. 将变量转换为 local 变量</a></li>
<li><a href="#org8e793a7">2.3. 输入法启动和重启</a></li>
<li><a href="#org429a82b">2.4. 处理词库文件</a>
<ul>
<li><a href="#orgbd794a9">2.4.1. 自定义词库</a>
<ul>
<li><a href="#org5c248be">2.4.1.1. 词库文件格式</a></li>
</ul>
</li>
<li><a href="#orgb83d5a5">2.4.2. 从词库中搜索中文词条</a></li>
<li><a href="#org0adbcc3">2.4.3. 保存词条，删除词条以及调整词条位置</a>
<ul>
<li><a href="#orga2ffd30">2.4.3.1. 删词功能</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orge4a1450">2.5. 生成 `pyim-entered-code' 并插入 `pyim-dagger-str'</a>
<ul>
<li><a href="#org6360123">2.5.1. 生成拼音字符串 `pyim-entered-code'</a></li>
<li><a href="#orgb259e5b">2.5.2. 在待输入 buffer 中插入 `pyim-dagger-str'</a></li>
</ul>
</li>
<li><a href="#orgab536db">2.6. 处理拼音 code 字符串 `pyim-entered-code'</a>
<ul>
<li><a href="#org6f4d9dc">2.6.1. 拼音字符串 -&gt; 待选词列表</a>
<ul>
<li><a href="#org39410fd">2.6.1.1. 分解拼音字符串</a></li>
<li><a href="#org0e19db8">2.6.1.2. 获得词语拼音并进一步查询得到备选词列表</a></li>
</ul>
</li>
<li><a href="#org68275db">2.6.2. 核心函数：拼音字符串处理函数</a></li>
</ul>
</li>
<li><a href="#org0ae213d">2.7. 处理当前需要插入 buffer 的 dagger 字符串： `pyim-dagger-str'</a></li>
<li><a href="#org9c3044d">2.8. 显示和选择备选词条</a>
<ul>
<li><a href="#org88860a6">2.8.1. 构建词条菜单字符串</a></li>
<li><a href="#orgc4c00d5">2.8.2. 选择备选词</a></li>
</ul>
</li>
<li><a href="#org3073455">2.9. 处理标点符号</a></li>
<li><a href="#org63b8669">2.10. 处理特殊功能触发字符（单字符快捷键）</a></li>
<li><a href="#orgef70737">2.11. 与拼音输入相关的用户命令</a>
<ul>
<li><a href="#org521481e">2.11.1. 删除拼音字符串最后一个字符</a></li>
<li><a href="#orge98a9f4">2.11.2. 删除拼音字符串最后一个拼音</a></li>
<li><a href="#orge4ca8d9">2.11.3. 将光标前的 code 字符串转换为中文</a></li>
<li><a href="#org51e5547">2.11.4. 取消当前输入</a></li>
<li><a href="#org74eb93d">2.11.5. 字母上屏</a></li>
<li><a href="#orgb39504e">2.11.6. Chinese-pyim 取消激活</a></li>
<li><a href="#orga650279">2.11.7. 切换中英文输入模式</a></li>
<li><a href="#orgf6837d4">2.11.8. 为 isearch 添加拼音搜索功能</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org1747aa4" class="outline-2">
<h2 id="org1747aa4"><span class="section-number-2">1</span>说明文档&#xa0;&#xa0;&#xa0;<span class="tag"><span class="doc">doc</span></span></h2>
<div class="outline-text-2" id="text-1">
<p>
Chinese pyim 输入法的核心文件，包含了输入法的基本功能函数，比如：
</p>
<ol class="org-ol">
<li>加载和搜索词库</li>
<li>处理拼音字符串</li>
<li>处理备选词条</li>
<li>显示备选词条</li>
<li>其它</li>
</ol>
</div>
</div>



<div id="outline-container-orga3bbb5a" class="outline-2">
<h2 id="orga3bbb5a"><span class="section-number-2">2</span>核心代码&#xa0;&#xa0;&#xa0;<span class="tag"><span class="code">code</span></span></h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-orgda778c8" class="outline-3">
<h3 id="orgda778c8"><span class="section-number-3">2.1</span> require + defcustom + defvar</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">require</span> '<span style="color: #96CBFE;">cl-lib</span>)
(<span style="color: #4c83ff;">require</span> '<span style="color: #96CBFE;">help-mode</span>)
(<span style="color: #4c83ff;">require</span> '<span style="color: #96CBFE;">pos-tip</span>)
(<span style="color: #4c83ff;">require</span> '<span style="color: #96CBFE;">popup</span>)
(<span style="color: #4c83ff;">require</span> '<span style="color: #96CBFE;">async</span>)
(<span style="color: #4c83ff;">require</span> '<span style="color: #96CBFE;">chinese-pyim-pymap</span>)

(<span style="color: #4c83ff;">defgroup</span> <span style="color: #afd8af;">chinese-pyim</span> nil
  <span style="color: #FBDE2D;">"Chinese pinyin input method"</span>
  <span style="color: #4c83ff;">:group</span> 'leim)

(<span style="color: #4c83ff;">defcustom</span> <span style="color: #ff69b4;">pyim-directory</span> (locate-user-emacs-file <span style="color: #61CE3C;">"pyim/"</span>)
  <span style="color: #FBDE2D;">"&#19968;&#20010;&#30446;&#24405;&#65292;&#29992;&#20110;&#20445;&#23384;&#19982; Chinese-pyim &#30456;&#20851;&#30340;&#25991;&#20214;&#12290;"</span>
  <span style="color: #4c83ff;">:group</span> 'chinese-pyim)

(<span style="color: #4c83ff;">defcustom</span> <span style="color: #ff69b4;">pyim-dcache-directory</span> (locate-user-emacs-file <span style="color: #61CE3C;">"pyim/dcache"</span>)
  <span style="color: #FBDE2D;">"&#19968;&#20010;&#30446;&#24405;&#65292;&#29992;&#20110;&#20445;&#23384; Chinese-pyim &#35789;&#24211;&#23545;&#24212;&#30340; cache &#25991;&#20214;&#12290;"</span>
  <span style="color: #4c83ff;">:group</span> 'chinese-pyim)

(<span style="color: #4c83ff;">defcustom</span> <span style="color: #ff69b4;">pyim-dicts</span> nil
  <span style="color: #FBDE2D;">"&#19968;&#20010;&#21015;&#34920;&#65292;&#29992;&#20110;&#20445;&#23384; `</span><span style="color: #96CBFE;">Chinese-pyim</span><span style="color: #FBDE2D;">' &#30340;&#35789;&#24211;&#20449;&#24687;&#65292;&#27599;&#19968;&#20010; element &#37117;&#20195;&#34920;&#19968;&#26465;&#35789;&#24211;&#30340;&#20449;&#24687;&#12290;</span>
<span style="color: #FBDE2D;">&#29992;&#25143;&#21487;&#20197;&#20351;&#29992;&#35789;&#24211;&#31649;&#29702;&#21629;&#20196; `</span><span style="color: #96CBFE;">pyim-dicts-manager</span><span style="color: #FBDE2D;">' &#26469;&#28155;&#21152;&#35789;&#24211;&#20449;&#24687;&#65292;&#27599;&#19968;&#26465;&#35789;&#24211;&#20449;&#24687;&#37117;&#20351;&#29992;&#19968;&#20010;</span>
<span style="color: #FBDE2D;">plist &#26469;&#34920;&#31034;&#65292;&#27604;&#22914;&#65306;</span>

<span style="color: #FBDE2D;">    (:name \"100&#19975;&#22823;&#35789;&#24211;\" :file \"/path/to/pinyin-bigdict.txt\")</span>

<span style="color: #FBDE2D;">&#20854;&#20013;&#65306;</span>
<span style="color: #FBDE2D;">1. `</span><span style="color: #96CBFE;">:name</span><span style="color: #FBDE2D;">'      &#20195;&#34920;&#35789;&#24211;&#21517;&#31216;&#65292;&#29992;&#25143;&#21487;&#20197;&#25353;&#29031;&#21916;&#22909;&#26469;&#30830;&#23450;&#65288;&#21487;&#36873;&#39033;&#65289;&#12290;</span>
<span style="color: #FBDE2D;">2. `</span><span style="color: #96CBFE;">:file</span><span style="color: #FBDE2D;">'      &#34920;&#31034;&#35789;&#24211;&#25991;&#20214;&#65292;</span>

<span style="color: #FBDE2D;">&#21478;&#22806;&#19968;&#20010;&#19982;&#36825;&#20010;&#21464;&#37327;&#21151;&#33021;&#31867;&#20284;&#30340;&#21464;&#37327;&#26159;&#65306; `</span><span style="color: #96CBFE;">pyim-extra-dicts</span><span style="color: #FBDE2D;">', &#19987;&#38376;</span>
<span style="color: #FBDE2D;">&#29992;&#20110;&#21644; elpa &#26684;&#24335;&#30340;&#35789;&#24211;&#21253;&#38598;&#25104;&#12290;"</span>
  <span style="color: #4c83ff;">:group</span> 'chinese-pyim
  <span style="color: #4c83ff;">:type</span> 'list)

(<span style="color: #4c83ff;">defcustom</span> <span style="color: #ff69b4;">pyim-punctuation-dict</span>
  '((<span style="color: #61CE3C;">"'"</span> <span style="color: #61CE3C;">"&#8216;"</span> <span style="color: #61CE3C;">"&#8217;"</span>)
    (<span style="color: #61CE3C;">"\""</span> <span style="color: #61CE3C;">"&#8220;"</span> <span style="color: #61CE3C;">"&#8221;"</span>)
    (<span style="color: #61CE3C;">"_"</span> <span style="color: #61CE3C;">"&#8213;"</span>)
    (<span style="color: #61CE3C;">"^"</span> <span style="color: #61CE3C;">"&#8230;"</span>)
    (<span style="color: #61CE3C;">"]"</span> <span style="color: #61CE3C;">"&#12305;"</span>)
    (<span style="color: #61CE3C;">"["</span> <span style="color: #61CE3C;">"&#12304;"</span>)
    (<span style="color: #61CE3C;">"@"</span> <span style="color: #61CE3C;">"&#9678;"</span>)
    (<span style="color: #61CE3C;">"?"</span> <span style="color: #61CE3C;">"&#65311;"</span>)
    (<span style="color: #61CE3C;">"&gt;"</span> <span style="color: #61CE3C;">"&#12299;"</span>)
    (<span style="color: #61CE3C;">"="</span> <span style="color: #61CE3C;">"&#65309;"</span>)
    (<span style="color: #61CE3C;">"&lt;"</span> <span style="color: #61CE3C;">"&#12298;"</span>)
    (<span style="color: #61CE3C;">";"</span> <span style="color: #61CE3C;">"&#65307;"</span>)
    (<span style="color: #61CE3C;">":"</span> <span style="color: #61CE3C;">"&#65306;"</span>)
    (<span style="color: #61CE3C;">"/"</span> <span style="color: #61CE3C;">"&#12289;"</span>)
    (<span style="color: #61CE3C;">"."</span> <span style="color: #61CE3C;">"&#12290;"</span>)
    (<span style="color: #61CE3C;">"-"</span> <span style="color: #61CE3C;">"&#65293;"</span>)
    (<span style="color: #61CE3C;">","</span> <span style="color: #61CE3C;">"&#65292;"</span>)
    (<span style="color: #61CE3C;">"+"</span> <span style="color: #61CE3C;">"&#65291;"</span>)
    (<span style="color: #61CE3C;">"*"</span> <span style="color: #61CE3C;">"&#215;"</span>)
    (<span style="color: #61CE3C;">")"</span> <span style="color: #61CE3C;">"&#65289;"</span>)
    (<span style="color: #61CE3C;">"("</span> <span style="color: #61CE3C;">"&#65288;"</span>)
    (<span style="color: #61CE3C;">"&amp;"</span> <span style="color: #61CE3C;">"&#8251;"</span>)
    (<span style="color: #61CE3C;">"%"</span> <span style="color: #61CE3C;">"&#65285;"</span>)
    (<span style="color: #61CE3C;">"$"</span> <span style="color: #61CE3C;">"&#65509;"</span>)
    (<span style="color: #61CE3C;">"#"</span> <span style="color: #61CE3C;">"&#65283;"</span>)
    (<span style="color: #61CE3C;">"!"</span> <span style="color: #61CE3C;">"&#65281;"</span>)
    (<span style="color: #61CE3C;">"`"</span> <span style="color: #61CE3C;">"&#12539;"</span>)
    (<span style="color: #61CE3C;">"~"</span> <span style="color: #61CE3C;">"&#65374;"</span>)
    (<span style="color: #61CE3C;">"}"</span> <span style="color: #61CE3C;">"&#12303;"</span>)
    (<span style="color: #61CE3C;">"|"</span> <span style="color: #61CE3C;">"&#247;"</span>)
    (<span style="color: #61CE3C;">"{"</span> <span style="color: #61CE3C;">"&#12302;"</span>))
  <span style="color: #FBDE2D;">"&#26631;&#28857;&#31526;&#21495;&#34920;&#12290;"</span>
  <span style="color: #4c83ff;">:group</span> 'chinese-pyim
  <span style="color: #4c83ff;">:type</span> 'list)

(<span style="color: #4c83ff;">defcustom</span> <span style="color: #ff69b4;">pyim-default-scheme</span> 'quanpin
  <span style="color: #FBDE2D;">"&#35774;&#32622; Chinese-pyim &#20351;&#29992;&#21738;&#19968;&#31181;&#25340;&#38899;&#26041;&#26696;&#65292;&#40664;&#35748;&#20351;&#29992;&#20840;&#25340;&#36755;&#20837;&#12290;"</span>
  <span style="color: #4c83ff;">:group</span> 'chinese-pyim)

(<span style="color: #4c83ff;">defcustom</span> <span style="color: #ff69b4;">pyim-schemes</span>
  '((quanpin
     <span style="color: #4c83ff;">:document</span> <span style="color: #61CE3C;">"&#20840;&#25340;&#36755;&#20837;&#27861;&#26041;&#26696;&#65288;&#19981;&#21487;&#21024;&#38500;&#65289;&#12290;"</span>
     <span style="color: #4c83ff;">:class</span> quanpin
     <span style="color: #4c83ff;">:first-chars</span> <span style="color: #61CE3C;">"abcdefghjklmnopqrstwxyz"</span>
     <span style="color: #4c83ff;">:rest-chars</span> <span style="color: #61CE3C;">"vmpfwckzyjqdltxuognbhsrei'-a"</span>
     <span style="color: #4c83ff;">:prefer-trigger-chars</span> <span style="color: #61CE3C;">"v"</span>)
    (wubi
     <span style="color: #4c83ff;">:document</span> <span style="color: #61CE3C;">"&#20116;&#31508;&#36755;&#20837;&#27861;&#12290;"</span>
     <span style="color: #4c83ff;">:class</span> simple
     <span style="color: #4c83ff;">:first-chars</span> <span style="color: #61CE3C;">"abcdefghijklmnopqrstuvwxyz"</span>
     <span style="color: #4c83ff;">:rest-chars</span> <span style="color: #61CE3C;">"abcdefghijklmnopqrstuvwxyz"</span>
     <span style="color: #4c83ff;">:code-prefix</span> <span style="color: #61CE3C;">"."</span> <span style="color: #8B8989; font-style: italic;">;</span><span style="color: #8B8989; font-style: italic;">&#20116;&#31508;&#35789;&#24211;&#20013;&#25152;&#26377;&#30340; code &#37117;&#20197; "." &#24320;&#22836;&#65292;&#38450;&#27490;&#21644;&#25340;&#38899;&#35789;&#24211;&#20914;&#31361;&#12290;</span>
     <span style="color: #4c83ff;">:auto-select</span> t <span style="color: #8B8989; font-style: italic;">;</span><span style="color: #8B8989; font-style: italic;">&#21482;&#26377;&#19968;&#20010;&#20505;&#36873;&#35789;&#26102;&#65292;&#26159;&#21542;&#33258;&#21160;&#36873;&#25321;&#36825;&#20010;&#20505;&#36873;&#35789;&#12290;</span>
     <span style="color: #4c83ff;">:auto-select-minimum-input</span> 4 <span style="color: #8B8989; font-style: italic;">;</span><span style="color: #8B8989; font-style: italic;">&#33258;&#21160;&#36873;&#25321;&#20505;&#36873;&#35789;&#26102;&#35201;&#27714;&#30340;&#26368;&#23567;&#36755;&#20837;&#23383;&#31526;&#25968;&#37327;</span>
     <span style="color: #4c83ff;">:prefer-trigger-chars</span> nil)
    (pyim-shuangpin
     <span style="color: #4c83ff;">:document</span> <span style="color: #61CE3C;">"&#19982; Chinese-pyim &#37197;&#21512;&#33391;&#22909;&#30340;&#21452;&#25340;&#36755;&#20837;&#27861;&#26041;&#26696;&#65292;&#28304;&#33258;&#23567;&#40548;&#21452;&#25340;&#26041;&#26696;&#12290;"</span>
     <span style="color: #4c83ff;">:class</span> shuangpin
     <span style="color: #4c83ff;">:first-chars</span> <span style="color: #61CE3C;">"abcdefghijklmnpqrstuvwxyz"</span>
     <span style="color: #4c83ff;">:rest-chars</span> <span style="color: #61CE3C;">"abcdefghijklmnopqrstuvwxyz"</span>
     <span style="color: #4c83ff;">:prefer-trigger-chars</span> <span style="color: #61CE3C;">"o"</span>
     <span style="color: #4c83ff;">:keymaps</span>
     ((<span style="color: #61CE3C;">"a"</span> <span style="color: #61CE3C;">"a"</span> <span style="color: #61CE3C;">"a"</span>)
      (<span style="color: #61CE3C;">"b"</span> <span style="color: #61CE3C;">"b"</span> <span style="color: #61CE3C;">"in"</span>)
      (<span style="color: #61CE3C;">"c"</span> <span style="color: #61CE3C;">"c"</span> <span style="color: #61CE3C;">"ao"</span>)
      (<span style="color: #61CE3C;">"d"</span> <span style="color: #61CE3C;">"d"</span> <span style="color: #61CE3C;">"ai"</span>)
      (<span style="color: #61CE3C;">"e"</span> <span style="color: #61CE3C;">"e"</span> <span style="color: #61CE3C;">"e"</span>)
      (<span style="color: #61CE3C;">"f"</span> <span style="color: #61CE3C;">"f"</span> <span style="color: #61CE3C;">"en"</span>)
      (<span style="color: #61CE3C;">"g"</span> <span style="color: #61CE3C;">"g"</span> <span style="color: #61CE3C;">"eng"</span>)
      (<span style="color: #61CE3C;">"h"</span> <span style="color: #61CE3C;">"h"</span> <span style="color: #61CE3C;">"ang"</span>)
      (<span style="color: #61CE3C;">"i"</span> <span style="color: #61CE3C;">"ch"</span> <span style="color: #61CE3C;">"i"</span>)
      (<span style="color: #61CE3C;">"j"</span> <span style="color: #61CE3C;">"j"</span> <span style="color: #61CE3C;">"an"</span>)
      (<span style="color: #61CE3C;">"k"</span> <span style="color: #61CE3C;">"k"</span> <span style="color: #61CE3C;">"ing"</span> <span style="color: #61CE3C;">"uai"</span>)
      (<span style="color: #61CE3C;">"l"</span> <span style="color: #61CE3C;">"l"</span> <span style="color: #61CE3C;">"iang"</span> <span style="color: #61CE3C;">"uang"</span>)
      (<span style="color: #61CE3C;">"m"</span> <span style="color: #61CE3C;">"m"</span> <span style="color: #61CE3C;">"ian"</span>)
      (<span style="color: #61CE3C;">"n"</span> <span style="color: #61CE3C;">"n"</span> <span style="color: #61CE3C;">"iao"</span>)
      (<span style="color: #61CE3C;">"o"</span> <span style="color: #61CE3C;">"o"</span> <span style="color: #61CE3C;">"uo"</span> <span style="color: #61CE3C;">"o"</span>)
      (<span style="color: #61CE3C;">"p"</span> <span style="color: #61CE3C;">"p"</span> <span style="color: #61CE3C;">"ie"</span>)
      (<span style="color: #61CE3C;">"q"</span> <span style="color: #61CE3C;">"q"</span> <span style="color: #61CE3C;">"iu"</span>)
      (<span style="color: #61CE3C;">"r"</span> <span style="color: #61CE3C;">"r"</span> <span style="color: #61CE3C;">"uan"</span>)
      (<span style="color: #61CE3C;">"s"</span> <span style="color: #61CE3C;">"s"</span> <span style="color: #61CE3C;">"iong"</span> <span style="color: #61CE3C;">"ong"</span>)
      (<span style="color: #61CE3C;">"t"</span> <span style="color: #61CE3C;">"t"</span> <span style="color: #61CE3C;">"ue"</span> <span style="color: #61CE3C;">"ve"</span>)
      (<span style="color: #61CE3C;">"u"</span> <span style="color: #61CE3C;">"sh"</span> <span style="color: #61CE3C;">"u"</span>)
      (<span style="color: #61CE3C;">"v"</span> <span style="color: #61CE3C;">"zh"</span> <span style="color: #61CE3C;">"v"</span> <span style="color: #61CE3C;">"ui"</span>)
      (<span style="color: #61CE3C;">"w"</span> <span style="color: #61CE3C;">"w"</span> <span style="color: #61CE3C;">"ei"</span>)
      (<span style="color: #61CE3C;">"x"</span> <span style="color: #61CE3C;">"x"</span> <span style="color: #61CE3C;">"ia"</span> <span style="color: #61CE3C;">"ua"</span>)
      (<span style="color: #61CE3C;">"y"</span> <span style="color: #61CE3C;">"y"</span> <span style="color: #61CE3C;">"un"</span>)
      (<span style="color: #61CE3C;">"z"</span> <span style="color: #61CE3C;">"z"</span> <span style="color: #61CE3C;">"ou"</span>)
      (<span style="color: #61CE3C;">"aa"</span> <span style="color: #61CE3C;">"a"</span>)
      (<span style="color: #61CE3C;">"aj"</span> <span style="color: #61CE3C;">"an"</span>)
      (<span style="color: #61CE3C;">"ad"</span> <span style="color: #61CE3C;">"ai"</span>)
      (<span style="color: #61CE3C;">"ac"</span> <span style="color: #61CE3C;">"ao"</span>)
      (<span style="color: #61CE3C;">"ah"</span> <span style="color: #61CE3C;">"ang"</span>)
      (<span style="color: #61CE3C;">"ee"</span> <span style="color: #61CE3C;">"e"</span>)
      (<span style="color: #61CE3C;">"ew"</span> <span style="color: #61CE3C;">"ei"</span>)
      (<span style="color: #61CE3C;">"ef"</span> <span style="color: #61CE3C;">"en"</span>)
      (<span style="color: #61CE3C;">"er"</span> <span style="color: #61CE3C;">"er"</span>)
      (<span style="color: #61CE3C;">"eg"</span> <span style="color: #61CE3C;">"eng"</span>)
      (<span style="color: #61CE3C;">"ag"</span> <span style="color: #61CE3C;">"ng"</span>)
      (<span style="color: #61CE3C;">"ao"</span> <span style="color: #61CE3C;">"o"</span>)
      (<span style="color: #61CE3C;">"au"</span> <span style="color: #61CE3C;">"ou"</span>)))
    (microsoft-shuangpin
     <span style="color: #4c83ff;">:document</span> <span style="color: #61CE3C;">"&#24494;&#36719;&#21452;&#25340;&#26041;&#26696;&#12290;"</span>
     <span style="color: #4c83ff;">:class</span> shuangpin
     <span style="color: #4c83ff;">:first-chars</span> <span style="color: #61CE3C;">"abcdefghijklmnpqrstuvwxyz"</span>
     <span style="color: #4c83ff;">:rest-chars</span> <span style="color: #61CE3C;">"abcdefghijklmnopqrstuvwxyz;"</span>
     <span style="color: #4c83ff;">:prefer-trigger-chars</span> nil
     <span style="color: #4c83ff;">:keymaps</span>
     ((<span style="color: #61CE3C;">"a"</span> <span style="color: #61CE3C;">"a"</span> <span style="color: #61CE3C;">"a"</span>)
      (<span style="color: #61CE3C;">"b"</span> <span style="color: #61CE3C;">"b"</span> <span style="color: #61CE3C;">"ou"</span>)
      (<span style="color: #61CE3C;">"c"</span> <span style="color: #61CE3C;">"c"</span> <span style="color: #61CE3C;">"iao"</span>)
      (<span style="color: #61CE3C;">"d"</span> <span style="color: #61CE3C;">"d"</span> <span style="color: #61CE3C;">"uang"</span> <span style="color: #61CE3C;">"iang"</span>)
      (<span style="color: #61CE3C;">"e"</span> <span style="color: #61CE3C;">"e"</span> <span style="color: #61CE3C;">"e"</span>)
      (<span style="color: #61CE3C;">"f"</span> <span style="color: #61CE3C;">"f"</span> <span style="color: #61CE3C;">"en"</span>)
      (<span style="color: #61CE3C;">"g"</span> <span style="color: #61CE3C;">"g"</span> <span style="color: #61CE3C;">"eng"</span>)
      (<span style="color: #61CE3C;">"h"</span> <span style="color: #61CE3C;">"h"</span> <span style="color: #61CE3C;">"ang"</span>)
      (<span style="color: #61CE3C;">"i"</span> <span style="color: #61CE3C;">"ch"</span> <span style="color: #61CE3C;">"i"</span>)
      (<span style="color: #61CE3C;">"j"</span> <span style="color: #61CE3C;">"j"</span> <span style="color: #61CE3C;">"an"</span>)
      (<span style="color: #61CE3C;">"k"</span> <span style="color: #61CE3C;">"k"</span> <span style="color: #61CE3C;">"ao"</span>)
      (<span style="color: #61CE3C;">"l"</span> <span style="color: #61CE3C;">"l"</span> <span style="color: #61CE3C;">"ai"</span>)
      (<span style="color: #61CE3C;">"m"</span> <span style="color: #61CE3C;">"m"</span> <span style="color: #61CE3C;">"ian"</span>)
      (<span style="color: #61CE3C;">"n"</span> <span style="color: #61CE3C;">"n"</span> <span style="color: #61CE3C;">"in"</span>)
      (<span style="color: #61CE3C;">"o"</span> <span style="color: #61CE3C;">"o"</span> <span style="color: #61CE3C;">"uo"</span> <span style="color: #61CE3C;">"o"</span>)
      (<span style="color: #61CE3C;">"p"</span> <span style="color: #61CE3C;">"p"</span> <span style="color: #61CE3C;">"un"</span>)
      (<span style="color: #61CE3C;">"q"</span> <span style="color: #61CE3C;">"q"</span> <span style="color: #61CE3C;">"iu"</span>)
      (<span style="color: #61CE3C;">"r"</span> <span style="color: #61CE3C;">"r"</span> <span style="color: #61CE3C;">"uan"</span> <span style="color: #61CE3C;">"er"</span>)
      (<span style="color: #61CE3C;">"s"</span> <span style="color: #61CE3C;">"s"</span> <span style="color: #61CE3C;">"iong"</span> <span style="color: #61CE3C;">"ong"</span>)
      (<span style="color: #61CE3C;">"t"</span> <span style="color: #61CE3C;">"t"</span> <span style="color: #61CE3C;">"ue"</span>)
      (<span style="color: #61CE3C;">"u"</span> <span style="color: #61CE3C;">"sh"</span> <span style="color: #61CE3C;">"u"</span>)
      (<span style="color: #61CE3C;">"v"</span> <span style="color: #61CE3C;">"zh"</span> <span style="color: #61CE3C;">"ve"</span> <span style="color: #61CE3C;">"ui"</span>)
      (<span style="color: #61CE3C;">"w"</span> <span style="color: #61CE3C;">"w"</span> <span style="color: #61CE3C;">"ia"</span> <span style="color: #61CE3C;">"ua"</span>)
      (<span style="color: #61CE3C;">"x"</span> <span style="color: #61CE3C;">"x"</span> <span style="color: #61CE3C;">"ie"</span>)
      (<span style="color: #61CE3C;">"y"</span> <span style="color: #61CE3C;">"y"</span> <span style="color: #61CE3C;">"uai"</span> <span style="color: #61CE3C;">"v"</span>)
      (<span style="color: #61CE3C;">"z"</span> <span style="color: #61CE3C;">"z"</span> <span style="color: #61CE3C;">"ei"</span>)
      (<span style="color: #61CE3C;">";"</span> <span style="color: #61CE3C;">";"</span> <span style="color: #61CE3C;">"ing"</span>)
      (<span style="color: #61CE3C;">"oa"</span> <span style="color: #61CE3C;">"a"</span>)
      (<span style="color: #61CE3C;">"oj"</span> <span style="color: #61CE3C;">"an"</span>)
      (<span style="color: #61CE3C;">"ol"</span> <span style="color: #61CE3C;">"ai"</span>)
      (<span style="color: #61CE3C;">"ok"</span> <span style="color: #61CE3C;">"ao"</span>)
      (<span style="color: #61CE3C;">"oh"</span> <span style="color: #61CE3C;">"ang"</span>)
      (<span style="color: #61CE3C;">"oe"</span> <span style="color: #61CE3C;">"e"</span>)
      (<span style="color: #61CE3C;">"oz"</span> <span style="color: #61CE3C;">"ei"</span>)
      (<span style="color: #61CE3C;">"of"</span> <span style="color: #61CE3C;">"en"</span>)
      (<span style="color: #61CE3C;">"or"</span> <span style="color: #61CE3C;">"er"</span>)
      (<span style="color: #61CE3C;">"og"</span> <span style="color: #61CE3C;">"eng"</span>)
      (<span style="color: #61CE3C;">"oo"</span> <span style="color: #61CE3C;">"o"</span>)
      (<span style="color: #61CE3C;">"ob"</span> <span style="color: #61CE3C;">"ou"</span>)))
    (xiaohe-shuangpin
     <span style="color: #4c83ff;">:document</span> <span style="color: #61CE3C;">"&#23567;&#40548;&#21452;&#25340;&#36755;&#20837;&#27861;&#26041;&#26696;&#12290;"</span>
     <span style="color: #4c83ff;">:class</span> shuangpin
     <span style="color: #4c83ff;">:first-chars</span> <span style="color: #61CE3C;">"abcdefghijklmnopqrstuvwxyz"</span>
     <span style="color: #4c83ff;">:rest-chars</span> <span style="color: #61CE3C;">"abcdefghijklmnopqrstuvwxyz"</span>
     <span style="color: #4c83ff;">:prefer-trigger-chars</span> nil
     <span style="color: #4c83ff;">:keymaps</span>
     ((<span style="color: #61CE3C;">"a"</span> <span style="color: #61CE3C;">"a"</span> <span style="color: #61CE3C;">"a"</span>)
      (<span style="color: #61CE3C;">"b"</span> <span style="color: #61CE3C;">"b"</span> <span style="color: #61CE3C;">"in"</span>)
      (<span style="color: #61CE3C;">"c"</span> <span style="color: #61CE3C;">"c"</span> <span style="color: #61CE3C;">"ao"</span>)
      (<span style="color: #61CE3C;">"d"</span> <span style="color: #61CE3C;">"d"</span> <span style="color: #61CE3C;">"ai"</span>)
      (<span style="color: #61CE3C;">"e"</span> <span style="color: #61CE3C;">"e"</span> <span style="color: #61CE3C;">"e"</span>)
      (<span style="color: #61CE3C;">"f"</span> <span style="color: #61CE3C;">"f"</span> <span style="color: #61CE3C;">"en"</span>)
      (<span style="color: #61CE3C;">"g"</span> <span style="color: #61CE3C;">"g"</span> <span style="color: #61CE3C;">"eng"</span>)
      (<span style="color: #61CE3C;">"h"</span> <span style="color: #61CE3C;">"h"</span> <span style="color: #61CE3C;">"ang"</span>)
      (<span style="color: #61CE3C;">"i"</span> <span style="color: #61CE3C;">"ch"</span> <span style="color: #61CE3C;">"i"</span>)
      (<span style="color: #61CE3C;">"j"</span> <span style="color: #61CE3C;">"j"</span> <span style="color: #61CE3C;">"an"</span>)
      (<span style="color: #61CE3C;">"k"</span> <span style="color: #61CE3C;">"k"</span> <span style="color: #61CE3C;">"ing"</span> <span style="color: #61CE3C;">"uai"</span>)
      (<span style="color: #61CE3C;">"l"</span> <span style="color: #61CE3C;">"l"</span> <span style="color: #61CE3C;">"iang"</span> <span style="color: #61CE3C;">"uang"</span>)
      (<span style="color: #61CE3C;">"m"</span> <span style="color: #61CE3C;">"m"</span> <span style="color: #61CE3C;">"ian"</span>)
      (<span style="color: #61CE3C;">"n"</span> <span style="color: #61CE3C;">"n"</span> <span style="color: #61CE3C;">"iao"</span>)
      (<span style="color: #61CE3C;">"o"</span> <span style="color: #61CE3C;">"o"</span> <span style="color: #61CE3C;">"uo"</span> <span style="color: #61CE3C;">"o"</span>)
      (<span style="color: #61CE3C;">"p"</span> <span style="color: #61CE3C;">"p"</span> <span style="color: #61CE3C;">"ie"</span>)
      (<span style="color: #61CE3C;">"q"</span> <span style="color: #61CE3C;">"q"</span> <span style="color: #61CE3C;">"iu"</span>)
      (<span style="color: #61CE3C;">"r"</span> <span style="color: #61CE3C;">"r"</span> <span style="color: #61CE3C;">"uan"</span>)
      (<span style="color: #61CE3C;">"s"</span> <span style="color: #61CE3C;">"s"</span> <span style="color: #61CE3C;">"iong"</span> <span style="color: #61CE3C;">"ong"</span>)
      (<span style="color: #61CE3C;">"t"</span> <span style="color: #61CE3C;">"t"</span> <span style="color: #61CE3C;">"ue"</span> <span style="color: #61CE3C;">"ve"</span>)
      (<span style="color: #61CE3C;">"u"</span> <span style="color: #61CE3C;">"sh"</span> <span style="color: #61CE3C;">"u"</span>)
      (<span style="color: #61CE3C;">"v"</span> <span style="color: #61CE3C;">"zh"</span> <span style="color: #61CE3C;">"v"</span> <span style="color: #61CE3C;">"ui"</span>)
      (<span style="color: #61CE3C;">"w"</span> <span style="color: #61CE3C;">"w"</span> <span style="color: #61CE3C;">"ei"</span>)
      (<span style="color: #61CE3C;">"x"</span> <span style="color: #61CE3C;">"x"</span> <span style="color: #61CE3C;">"ia"</span> <span style="color: #61CE3C;">"ua"</span>)
      (<span style="color: #61CE3C;">"y"</span> <span style="color: #61CE3C;">"y"</span> <span style="color: #61CE3C;">"un"</span>)
      (<span style="color: #61CE3C;">"z"</span> <span style="color: #61CE3C;">"z"</span> <span style="color: #61CE3C;">"ou"</span>)
      (<span style="color: #61CE3C;">"aa"</span> <span style="color: #61CE3C;">"a"</span>)
      (<span style="color: #61CE3C;">"aj"</span> <span style="color: #61CE3C;">"an"</span>)
      (<span style="color: #61CE3C;">"ad"</span> <span style="color: #61CE3C;">"ai"</span>)
      (<span style="color: #61CE3C;">"ac"</span> <span style="color: #61CE3C;">"ao"</span>)
      (<span style="color: #61CE3C;">"ah"</span> <span style="color: #61CE3C;">"ang"</span>)
      (<span style="color: #61CE3C;">"ee"</span> <span style="color: #61CE3C;">"e"</span>)
      (<span style="color: #61CE3C;">"ew"</span> <span style="color: #61CE3C;">"ei"</span>)
      (<span style="color: #61CE3C;">"ef"</span> <span style="color: #61CE3C;">"en"</span>)
      (<span style="color: #61CE3C;">"er"</span> <span style="color: #61CE3C;">"er"</span>)
      (<span style="color: #61CE3C;">"eg"</span> <span style="color: #61CE3C;">"eng"</span>)
      (<span style="color: #61CE3C;">"og"</span> <span style="color: #61CE3C;">"ng"</span>)
      (<span style="color: #61CE3C;">"oo"</span> <span style="color: #61CE3C;">"o"</span>)
      (<span style="color: #61CE3C;">"ou"</span> <span style="color: #61CE3C;">"ou"</span>))))
  <span style="color: #FBDE2D;">"Chinese-pyim &#25903;&#25345;&#30340;&#25152;&#26377;&#25340;&#38899;&#26041;&#26696;&#12290;"</span>)

(<span style="color: #4c83ff;">defcustom</span> <span style="color: #ff69b4;">pyim-translate-trigger-char</span> <span style="color: #61CE3C;">"v"</span>
  <span style="color: #FBDE2D;">"&#29992;&#20110;&#35302;&#21457;&#29305;&#27530;&#25805;&#20316;&#30340;&#23383;&#31526;&#65292;&#30456;&#24403;&#19982;&#21333;&#23383;&#24555;&#25463;&#38190;&#12290;</span>

<span style="color: #FBDE2D;">Chinese-pyim &#20869;&#24314;&#30340;&#21151;&#33021;&#26377;&#65306;</span>
<span style="color: #FBDE2D;">1. &#20809;&#26631;&#21069;&#38754;&#30340;&#23383;&#31526;&#20026;&#26631;&#28857;&#31526;&#21495;&#26102;&#65292;&#25353;&#36825;&#20010;&#23383;&#31526;&#21487;&#20197;&#20999;&#25442;&#21069;&#38754;&#30340;&#26631;</span>
<span style="color: #FBDE2D;">   &#28857;&#31526;&#21495;&#30340;&#26679;&#24335;&#65288;&#21322;&#35282;/&#20840;&#35282;&#65289;</span>
<span style="color: #FBDE2D;">2. &#24403;&#20809;&#26631;&#21069;&#38754;&#20026;&#20013;&#25991;&#23383;&#31526;&#20018;&#26102;&#65292;&#36755;&#20837; &lt;num&gt;v &#21487;&#20197;&#29992;&#20110;&#20445;&#23384;&#33258;&#23450;&#20041;&#35789;&#26465;&#12290;</span>
<span style="color: #FBDE2D;">3. &#20854;&#23427;&#12290;</span>

<span style="color: #FBDE2D;">&#27880;&#24847;&#65306;&#21333;&#23383;&#24555;&#25463;&#38190;&#21463;&#21040;&#25340;&#38899;&#26041;&#26696;&#30340;&#38480;&#21046;&#65292;&#27604;&#22914;&#65306;&#20840;&#25340;&#36755;&#20837;&#27861;&#21487;&#20197;&#23558;&#20854;&#35774;&#32622;&#20026;v,</span>
<span style="color: #FBDE2D;">&#20294;&#21452;&#25340;&#36755;&#20837;&#27861;&#19979;&#35774;&#32622; v &#21487;&#33021;&#23601;&#19981;&#34892;&#65292;&#25152;&#20197;&#65292;Chinese-pyim &#39318;&#20808;&#20250;&#26816;&#26597;</span>
<span style="color: #FBDE2D;">&#24403;&#21069;&#25340;&#38899;&#26041;&#26696;&#19979;&#65292;&#36825;&#20010;&#24555;&#25463;&#38190;&#35774;&#32622;&#26159;&#21542;&#21512;&#29702;&#26377;&#25928;&#65292;&#22914;&#26524;&#19981;&#26159;&#19968;&#20010;&#21512;&#29702;&#30340;&#35774;&#32622;&#65292;</span>
<span style="color: #FBDE2D;">&#21017;&#20351;&#29992;&#25340;&#38899;&#26041;&#26696;&#40664;&#35748;&#30340; :prefer-trigger-chars &#12290;</span>

<span style="color: #FBDE2D;">&#20855;&#20307;&#35831;&#21442;&#32771; `</span><span style="color: #96CBFE;">pyim-translate-get-trigger-char</span><span style="color: #FBDE2D;">' &#12290;"</span>
  <span style="color: #4c83ff;">:group</span> 'chinese-pyim
  <span style="color: #4c83ff;">:type</span> 'character)

(<span style="color: #4c83ff;">defcustom</span> <span style="color: #ff69b4;">pyim-fuzzy-pinyin-alist</span>
  '((<span style="color: #61CE3C;">"en"</span> <span style="color: #61CE3C;">"eng"</span>)
    (<span style="color: #61CE3C;">"in"</span> <span style="color: #61CE3C;">"ing"</span>)
    (<span style="color: #61CE3C;">"un"</span> <span style="color: #61CE3C;">"ong"</span>))
  <span style="color: #FBDE2D;">"&#35774;&#23450;&#31970;&#31946;&#38899;"</span>
  <span style="color: #4c83ff;">:group</span> 'chinese-pyim)

(<span style="color: #4c83ff;">defcustom</span> <span style="color: #ff69b4;">pyim-backends</span>
  '(dcache-personal dcache-common pinyin-chars pinyin-shortcode pinyin-znabc)
  <span style="color: #FBDE2D;">"pyim &#35789;&#35821;&#33719;&#21462; backends &#65292;&#24403;&#21069;&#25903;&#25345;&#65306;</span>

<span style="color: #FBDE2D;">1. `</span><span style="color: #96CBFE;">dcache-personal</span><span style="color: #FBDE2D;">'     &#20174; `</span><span style="color: #96CBFE;">pyim-dcache-icode2word</span><span style="color: #FBDE2D;">' &#20013;&#33719;&#21462;&#35789;&#26465;&#12290;</span>
<span style="color: #FBDE2D;">2. `</span><span style="color: #96CBFE;">dcache-common</span><span style="color: #FBDE2D;">'       &#20174; `</span><span style="color: #96CBFE;">pyim-dcache-code2word</span><span style="color: #FBDE2D;">' &#20013;&#33719;&#21462;&#35789;&#26465;&#12290;</span>
<span style="color: #FBDE2D;">3. `</span><span style="color: #96CBFE;">pinyin-chars</span><span style="color: #FBDE2D;">'        &#36880;&#19968;&#33719;&#21462;&#19968;&#20010;&#25340;&#38899;&#23545;&#24212;&#30340;&#22810;&#20010;&#27721;&#23383;&#12290;</span>
<span style="color: #FBDE2D;">4. `</span><span style="color: #96CBFE;">pinyin-shortcode</span><span style="color: #FBDE2D;">'    &#33719;&#21462;&#31616;&#25340;&#23545;&#24212;&#30340;&#35789;&#26465;&#65292;</span>
<span style="color: #FBDE2D;">    &#22914;&#26524;&#36755;&#20837; \"ni-hao\" &#65292;&#37027;&#20040;&#21516;&#26102;&#25628;&#32034; code &#20026; \"n-h\" &#30340;&#35789;&#26465;&#12290;</span>
<span style="color: #FBDE2D;">5. `</span><span style="color: #96CBFE;">pinyin-znabc</span><span style="color: #FBDE2D;">'        &#31867;&#20284;&#26234;&#33021;ABC&#30340;&#35789;&#35821;&#33719;&#21462;&#26041;&#24335;(&#28304;&#20110; emacs-eim)."</span>
  <span style="color: #4c83ff;">:group</span> 'chinese-pyim)

(<span style="color: #4c83ff;">defcustom</span> <span style="color: #ff69b4;">pyim-isearch-enable-pinyin-search</span> nil
  <span style="color: #FBDE2D;">"&#35774;&#32622;&#26159;&#21542;&#24320;&#21551; isearch &#20013;&#25991;&#25340;&#38899;&#25628;&#32034;&#21151;&#33021;&#12290;"</span>
  <span style="color: #4c83ff;">:group</span> 'chinese-pyim
  <span style="color: #4c83ff;">:type</span> 'boolean)

(<span style="color: #4c83ff;">defface</span> <span style="color: #ff69b4;">pyim-dagger-face</span> '((t (<span style="color: #4c83ff;">:underline</span> t)))
  <span style="color: #FBDE2D;">"dagger &#23383;&#31526;&#20018;&#30340; face"</span>
  <span style="color: #4c83ff;">:group</span> 'chinese-pyim)

(<span style="color: #4c83ff;">defcustom</span> <span style="color: #ff69b4;">pyim-english-input-switch-functions</span> nil
  <span style="color: #FBDE2D;">"&#36825;&#20010;&#21464;&#37327;&#30340;&#21462;&#20540;&#20026;&#19968;&#20010;&#20989;&#25968;&#21015;&#34920;&#65292;&#36825;&#20010;&#20989;&#25968;&#21015;&#34920;&#20013;&#30340;&#20219;&#24847;&#19968;&#20010;&#20989;&#25968;&#30340;&#36816;&#34892;&#32467;&#26524;&#20026; t &#26102;&#65292;</span>
<span style="color: #FBDE2D;">Chinese-pyim &#20063;&#24320;&#21551;&#33521;&#25991;&#36755;&#20837;&#21151;&#33021;&#12290;"</span>
  <span style="color: #4c83ff;">:group</span> 'chinese-pyim)

(<span style="color: #4c83ff;">defcustom</span> <span style="color: #ff69b4;">pyim-punctuation-half-width-functions</span> nil
  <span style="color: #FBDE2D;">"&#21462;&#20540;&#20026;&#19968;&#20010;&#20989;&#25968;&#21015;&#34920;&#65292;&#36825;&#20010;&#20989;&#25968;&#21015;&#34920;&#20013;&#30340;&#20219;&#24847;&#19968;&#20010;&#20989;&#25968;&#30340;&#36816;&#34892;&#32467;&#26524;&#20026; t &#26102;&#65292;</span>
<span style="color: #FBDE2D;">Chinese-pyim &#36755;&#20837;&#21322;&#35282;&#26631;&#28857;&#65292;&#20989;&#25968;&#21015;&#34920;&#20013;&#27599;&#20010;&#20989;&#25968;&#37117;&#26377;&#19968;&#20010;&#21442;&#25968;&#65306;char &#65292;&#34920;&#31034;</span>
<span style="color: #FBDE2D;">&#26368;&#21518;&#36755;&#20837;&#30340;&#19968;&#20010;&#23383;&#31526;&#65292;&#20855;&#20307;&#35265;: `</span><span style="color: #96CBFE;">pyim-translate</span><span style="color: #FBDE2D;">' &#12290;"</span>
  <span style="color: #4c83ff;">:group</span> 'chinese-pyim)

(<span style="color: #4c83ff;">defcustom</span> <span style="color: #ff69b4;">pyim-wash-function</span> 'pyim-wash-current-line-function
  <span style="color: #FBDE2D;">"&#36825;&#20010;&#20989;&#25968;&#19982;&#12302;&#21333;&#23383;&#24555;&#25463;&#38190;&#37197;&#21512;&#20351;&#29992;&#12303;&#65292;&#24403;&#20809;&#26631;&#21069;&#38754;&#30340;&#23383;&#31526;&#20026;&#27721;&#23383;&#23383;&#31526;&#26102;&#65292;</span>
<span style="color: #FBDE2D;">&#25353; `</span><span style="color: #96CBFE;">pyim-translate-trigger-char</span><span style="color: #FBDE2D;">' &#23545;&#24212;&#23383;&#31526;&#65292;&#21487;&#20197;&#35843;&#29992;&#36825;&#20010;&#20989;&#25968;&#26469;&#28165;&#27927;</span>
<span style="color: #FBDE2D;">&#20809;&#26631;&#21069;&#38754;&#30340;&#25991;&#23383;&#20869;&#23481;&#12290;"</span>
  <span style="color: #4c83ff;">:group</span> 'chinese-pyim
  <span style="color: #4c83ff;">:type</span> 'function)

(<span style="color: #4c83ff;">defcustom</span> <span style="color: #ff69b4;">pyim-page-length</span> 5
  <span style="color: #FBDE2D;">"&#27599;&#39029;&#26174;&#31034;&#30340;&#35789;&#26465;&#25968;&#30446;"</span>
  <span style="color: #4c83ff;">:group</span> 'chinese-pyim
  <span style="color: #4c83ff;">:type</span> 'number)

(<span style="color: #4c83ff;">defcustom</span> <span style="color: #ff69b4;">pyim-page-tooltip</span> 'popup
  <span style="color: #FBDE2D;">"&#22914;&#20309;&#32472;&#21046; Chinese-pyim &#36873;&#35789;&#26694;&#12290;</span>

<span style="color: #FBDE2D;">1. &#24403;&#36825;&#20010;&#21464;&#37327;&#21462;&#20540;&#20026; t &#25110;&#32773; 'popup &#26102;&#65292;&#20351;&#29992; popup-el &#21253;&#26469;&#32472;&#21046;&#36873;&#35789;&#26694;&#65307;</span>
<span style="color: #FBDE2D;">2. &#24403;&#21462;&#20540;&#20026; pos-tip &#26102;&#65292;&#20351;&#29992; pos-tip &#21253;&#26469;&#32472;&#21046;&#36873;&#35789;&#26694;&#65307;</span>
<span style="color: #FBDE2D;">3. &#24403;&#21462;&#20540;&#20026; minibuffer &#25110;&#32773; nil &#26102;&#65292;&#20351;&#29992; minibuffer &#20570;&#20026;&#36873;&#35789;&#26694;&#65307;"</span>
  <span style="color: #4c83ff;">:group</span> 'chinese-pyim)

(<span style="color: #4c83ff;">defcustom</span> <span style="color: #ff69b4;">pyim-page-style</span> 'two-lines
  <span style="color: #FBDE2D;">"&#36825;&#20010;&#21464;&#37327;&#29992;&#26469;&#25511;&#21046;&#36873;&#35789;&#26694;&#30340;&#26684;&#24335;&#12290;</span>

<span style="color: #FBDE2D;">pyim &#20869;&#24314;&#30340;&#26377;&#19977;&#31181;&#36873;&#35789;&#26694;&#26684;&#24335;&#65306;</span>

<span style="color: #FBDE2D;">1. one-line  &#21333;&#34892;&#36873;&#35789;&#26694;</span>
<span style="color: #FBDE2D;">2. two-lines &#21452;&#34892;&#36873;&#35789;&#26694;</span>
<span style="color: #FBDE2D;">3. vertial   &#22402;&#30452;&#36873;&#35789;&#26694;"</span>
  <span style="color: #4c83ff;">:group</span> 'chinese-pyim
  <span style="color: #4c83ff;">:type</span> 'symbol)

(<span style="color: #4c83ff;">defcustom</span> <span style="color: #ff69b4;">pyim-page-select-finish-hook</span> nil
  <span style="color: #FBDE2D;">"Chinese-pyim &#36873;&#35789;&#23436;&#25104;&#26102;&#36816;&#34892;&#30340; hook&#12290;"</span>
  <span style="color: #4c83ff;">:group</span> 'chinese-pyim
  <span style="color: #4c83ff;">:type</span> 'hook)

(<span style="color: #4c83ff;">defface</span> <span style="color: #ff69b4;">pyim-page-selected-word-face</span> '((t (<span style="color: #4c83ff;">:background</span> <span style="color: #61CE3C;">"gray40"</span>)))
  <span style="color: #FBDE2D;">"&#36873;&#35789;&#26694;&#20013;&#24050;&#36873;&#35789;&#26465;&#30340; face</span>

<span style="color: #FBDE2D;">&#27880;&#24847;&#65306;&#24403;&#20351;&#29992; minibuffer &#20026;&#36873;&#35789;&#26694;&#26102;&#65292;&#36825;&#20010;&#36873;&#39033;&#25165;&#26377;&#29992;&#22788;&#12290;"</span>
  <span style="color: #4c83ff;">:group</span> 'chinese-pyim)

(<span style="color: #4c83ff;">defcustom</span> <span style="color: #ff69b4;">pyim-page-tooltip-width-adjustment</span> 1.2
  <span style="color: #FBDE2D;">"&#26657;&#27491; tooltip &#36873;&#35789;&#26694;&#23485;&#24230;&#30340;&#25968;&#20540;&#65292;&#34920;&#31034;&#26657;&#27491;&#21518;&#30340;&#23485;&#24230;&#26159;&#26410;&#26657;&#27491;&#21069;&#23485;&#24230;&#30340;&#20493;&#25968;&#12290;</span>

<span style="color: #FBDE2D;">&#30001;&#20110;&#23383;&#20307;&#35774;&#32622;&#31561;&#21407;&#22240;&#65292;pos-tip &#36873;&#35789;&#26694;&#23454;&#38469;&#23485;&#24230;&#20250;&#27604; *&#39044;&#26399;&#23485;&#24230;* &#20559;&#22823;&#25110;&#32773;&#20559;&#23567;&#65292;</span>
<span style="color: #FBDE2D;">&#36825;&#26102;&#65292;&#26377;&#21487;&#33021;&#20250;&#20986;&#29616;&#36873;&#35789;&#26694;&#35789;&#26465;&#26174;&#31034;&#19981;&#20840;&#25110;&#32773;&#36873;&#35789;&#26694;&#24377;&#20986;&#20301;&#32622;&#19981;&#21512;&#29702;&#31561;&#38382;&#39064;&#12290;&#29992;&#25143;&#21487;&#20197;&#36890;&#36807;</span>
<span style="color: #FBDE2D;">&#22686;&#22823;&#25110;&#32773;&#20943;&#23567;&#36825;&#20010;&#21464;&#37327;&#26469;&#25913;&#21464; tooltip &#36873;&#35789;&#26694;&#30340;&#23485;&#24230;&#65292;&#21462;&#20540;&#22823;&#27010;&#22312; 0.5 ~ 2.0 &#33539;&#22260;&#20043;&#20869;&#12290;</span>

<span style="color: #FBDE2D;">&#27880;&#65306;&#36825;&#20010;&#36873;&#39033;&#21482;&#36866;&#29992;&#20110; `</span><span style="color: #96CBFE;">pyim-page-tooltip</span><span style="color: #FBDE2D;">' &#21462;&#20540;&#20026; 'pos-tip &#30340;&#26102;&#20505;&#12290;"</span>
  <span style="color: #4c83ff;">:group</span> 'chinese-pyim)

(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-debug</span> nil)
(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-title</span> <span style="color: #61CE3C;">"&#28789;&#36890;"</span> <span style="color: #FBDE2D;">"Chinese-pyim &#22312; mode-line &#20013;&#26174;&#31034;&#30340;&#21517;&#31216;&#12290;"</span>)
(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-extra-dicts</span> nil <span style="color: #FBDE2D;">"&#19982; `</span><span style="color: #96CBFE;">pyim-dicts</span><span style="color: #FBDE2D;">' &#31867;&#20284;, &#29992;&#20110;&#21644; elpa &#26684;&#24335;&#30340;&#35789;&#24211;&#21253;&#38598;&#25104;&#12290;"</span>)

(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-pinyin-shen-mu</span>
  '(<span style="color: #61CE3C;">"b"</span> <span style="color: #61CE3C;">"p"</span> <span style="color: #61CE3C;">"m"</span> <span style="color: #61CE3C;">"f"</span> <span style="color: #61CE3C;">"d"</span> <span style="color: #61CE3C;">"t"</span> <span style="color: #61CE3C;">"n"</span> <span style="color: #61CE3C;">"l"</span> <span style="color: #61CE3C;">"g"</span> <span style="color: #61CE3C;">"k"</span> <span style="color: #61CE3C;">"h"</span>
    <span style="color: #61CE3C;">"j"</span> <span style="color: #61CE3C;">"q"</span> <span style="color: #61CE3C;">"x"</span> <span style="color: #61CE3C;">"z"</span> <span style="color: #61CE3C;">"c"</span> <span style="color: #61CE3C;">"s"</span> <span style="color: #61CE3C;">"zh"</span> <span style="color: #61CE3C;">"ch"</span> <span style="color: #61CE3C;">"sh"</span> <span style="color: #61CE3C;">"r"</span> <span style="color: #61CE3C;">"y"</span> <span style="color: #61CE3C;">"w"</span>))

(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-pinyin-yun-mu</span>
  '(<span style="color: #61CE3C;">"a"</span> <span style="color: #61CE3C;">"o"</span> <span style="color: #61CE3C;">"e"</span> <span style="color: #61CE3C;">"i"</span> <span style="color: #61CE3C;">"u"</span> <span style="color: #61CE3C;">"v"</span> <span style="color: #61CE3C;">"ai"</span> <span style="color: #61CE3C;">"ei"</span> <span style="color: #61CE3C;">"ui"</span> <span style="color: #61CE3C;">"ao"</span> <span style="color: #61CE3C;">"ou"</span> <span style="color: #61CE3C;">"iu"</span>
    <span style="color: #61CE3C;">"ie"</span> <span style="color: #61CE3C;">"ia"</span> <span style="color: #61CE3C;">"ua"</span> <span style="color: #61CE3C;">"ve"</span> <span style="color: #61CE3C;">"er"</span> <span style="color: #61CE3C;">"an"</span> <span style="color: #61CE3C;">"en"</span> <span style="color: #61CE3C;">"in"</span> <span style="color: #61CE3C;">"un"</span> <span style="color: #61CE3C;">"vn"</span> <span style="color: #61CE3C;">"ang"</span> <span style="color: #61CE3C;">"iong"</span>
    <span style="color: #61CE3C;">"eng"</span> <span style="color: #61CE3C;">"ing"</span> <span style="color: #61CE3C;">"ong"</span> <span style="color: #61CE3C;">"uan"</span> <span style="color: #61CE3C;">"uang"</span> <span style="color: #61CE3C;">"ian"</span> <span style="color: #61CE3C;">"iang"</span> <span style="color: #61CE3C;">"iao"</span> <span style="color: #61CE3C;">"ue"</span>
    <span style="color: #61CE3C;">"uai"</span> <span style="color: #61CE3C;">"uo"</span>))

(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-pinyin-valid-yun-mu</span>
  '(<span style="color: #61CE3C;">"a"</span> <span style="color: #61CE3C;">"o"</span> <span style="color: #61CE3C;">"e"</span> <span style="color: #61CE3C;">"ai"</span> <span style="color: #61CE3C;">"ei"</span> <span style="color: #61CE3C;">"ui"</span> <span style="color: #61CE3C;">"ao"</span> <span style="color: #61CE3C;">"ou"</span> <span style="color: #61CE3C;">"er"</span> <span style="color: #61CE3C;">"an"</span> <span style="color: #61CE3C;">"en"</span>
    <span style="color: #61CE3C;">"ang"</span> <span style="color: #61CE3C;">"eng"</span>))

(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-entered-code</span> <span style="color: #61CE3C;">""</span>
  <span style="color: #FBDE2D;">"&#29992;&#25143;&#24050;&#32463;&#36755;&#20837;&#30340; code&#65292;&#30001;&#29992;&#25143;&#36755;&#20837;&#30340;&#23383;&#31526;&#36830;&#25509;&#32780;&#25104;&#12290;"</span>)

(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-dagger-str</span> <span style="color: #61CE3C;">""</span>
  <span style="color: #FBDE2D;">"&#36755;&#20837;&#27861;&#36816;&#34892;&#30340;&#26102;&#20505;&#65292;&#20250;&#22312;&#20809;&#26631;&#22788;&#20250;&#25554;&#20837;&#19968;&#20010;&#24102;&#19979;&#21010;&#32447;&#23383;&#31526;&#20018;&#65292;&#36825;&#20010;&#23383;&#31526;&#20018;</span>
<span style="color: #FBDE2D;">&#25552;&#31034;&#29992;&#25143;&#24403;&#21069;&#36873;&#25321;&#30340;&#35789;&#26465;&#25110;&#32773;&#24403;&#21069;&#36755;&#20837;&#30340; code &#31561;&#35768;&#22810;&#26377;&#29992;&#30340;&#20449;&#24687;&#12290;</span>
<span style="color: #FBDE2D;">chinese-pyim &#31216;&#36825;&#20010;&#23383;&#31526;&#20018;&#20026; \"dragger string\", &#21521; \"&#21269;&#39318;\" &#19968;&#26679;&#25554;&#20837;</span>
<span style="color: #FBDE2D;">&#24403;&#21069; buffer &#30340;&#20809;&#26631;&#22788;&#12290;"</span>)

(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-input-ascii</span> nil  <span style="color: #FBDE2D;">"&#26159;&#21542;&#24320;&#21551; Chinese-pyim &#33521;&#25991;&#36755;&#20837;&#27169;&#24335;&#12290;"</span>)
(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-force-input-chinese</span> nil <span style="color: #FBDE2D;">"&#26159;&#21542;&#24378;&#21046;&#24320;&#21551;&#20013;&#25991;&#36755;&#20837;&#27169;&#24335;&#12290;"</span>)

(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-current-choices</span> nil
  <span style="color: #FBDE2D;">"&#25152;&#26377;&#21487;&#36873;&#30340;&#35789;&#26465;&#65292;&#26159;&#19968;&#20010;list&#12290;</span>
<span style="color: #FBDE2D;">1. CAR &#37096;&#20221;&#26159;&#21487;&#36873;&#30340;&#35789;&#26465;&#65292;&#19968;&#33324;&#26159;&#19968;&#20010;&#23383;&#31526;&#20018;&#21015;&#34920;&#12290;</span>
<span style="color: #FBDE2D;">   &#20063;&#21487;&#20197;&#21547;&#26377;list&#12290;&#20294;&#26159;&#21253;&#21547;&#30340;list&#31532;&#19968;&#20010;&#20803;&#32032;&#24517;&#39035;&#26159;&#23558;&#35201;&#25554;&#20837;&#30340;&#23383;&#31526;&#20018;&#12290;</span>
<span style="color: #FBDE2D;">2. CDR &#37096;&#20998;&#26159;&#19968;&#20010; Association list&#12290;&#36890;&#24120;&#21547;&#26377;&#36825;&#26679;&#30340;&#20869;&#23481;&#65306;</span>
<span style="color: #FBDE2D;">   1. pos &#19978;&#27425;&#36873;&#25321;&#30340;&#20301;&#32622;</span>
<span style="color: #FBDE2D;">   2. completion &#19979;&#19968;&#20010;&#21487;&#33021;&#30340;&#23383;&#27597;&#65288;&#22914;&#26524; pyim-do-completion &#20026; t&#65289;"</span>)

(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-translating</span> nil <span style="color: #FBDE2D;">"&#35760;&#24405;&#26159;&#21542;&#22312;&#36716;&#25442;&#29366;&#24577;"</span>)

(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-dagger-overlay</span> nil <span style="color: #FBDE2D;">"&#29992;&#20110;&#20445;&#23384; dagger &#30340; overlay"</span>)

(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-code-position</span> nil)
(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-scode-list</span> nil
  <span style="color: #FBDE2D;">"Chinese-pyim &#20250;&#23558;&#19968;&#20010; code &#20998;&#35299;&#20026;&#19968;&#20010;&#25110;&#32773;&#22810;&#20010; scode &#65288;splited code&#65289;,</span>
<span style="color: #FBDE2D;">&#36825;&#20010;&#21464;&#37327;&#29992;&#20110;&#20445;&#23384;&#20998;&#35299;&#24471;&#21040;&#30340;&#32467;&#26524;&#12290;"</span>)

(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-current-pos</span> nil <span style="color: #FBDE2D;">"&#24403;&#21069;&#36873;&#25321;&#30340;&#35789;&#26465;&#22312; pyim-current-choices &#20013;&#30340;&#20301;&#32622;"</span>)

(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-load-hook</span> nil)
(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-active-hook</span> nil)

(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-punctuation-translate-p</span> '(auto yes no)
  <span style="color: #FBDE2D;">"The car of its value will control the translation of punctuation."</span>)

(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-punctuation-pair-status</span>
  '((<span style="color: #61CE3C;">"\""</span> nil) (<span style="color: #61CE3C;">"'"</span> nil))
  <span style="color: #FBDE2D;">"&#25104;&#23545;&#26631;&#28857;&#31526;&#21495;&#20999;&#25442;&#29366;&#24577;"</span>)

(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-punctuation-escape-list</span> (number-sequence ?0 ?9)
  <span style="color: #FBDE2D;">"Punctuation will not insert after this characters.</span>
<span style="color: #FBDE2D;">If you don't like this funciton, set the variable to nil"</span>)

<span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">Pyim &#35789;&#24211;&#32531;&#23384;&#25991;&#20214;&#65292;&#27880;&#24847;&#65306;&#21464;&#37327;&#21517;&#31216;&#20013;&#19981;&#33021;&#20986;&#29616; ":" &#31561;</span>
<span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#19981;&#33021;&#20316;&#20026;&#25991;&#20214;&#21517;&#31216;&#30340;&#23383;&#31526;&#12290;</span>
(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-dcache-code2word</span> nil)
(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-dcache-code2word-md5</span> nil)
(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-dcache-word2code</span> nil)
(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-dcache-word2count</span> nil)
(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-dcache-shortcode2word</span> nil)
(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-dcache-icode2word</span> nil)
(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-dcache-iword2count</span> nil)
(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-dcache-ishortcode2word</span> nil)

(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-dcache-update:shortcode2word</span> nil)

(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-dcache-update:icode2word</span> nil)
(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-dcache-update:ishortcode2word</span> nil)

(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-mode-map</span>
  (<span style="color: #4c83ff;">let</span> ((map (make-sparse-keymap))
        (i ?\ ))
    (<span style="color: #4c83ff;">while</span> (&lt; i 127)
      (define-key map (char-to-string i) 'pyim-self-insert-command)
      (<span style="color: #4c83ff;">setq</span> i (1+ i)))
    (<span style="color: #4c83ff;">setq</span> i 128)
    (<span style="color: #4c83ff;">while</span> (&lt; i 256)
      (define-key map (vector i) 'pyim-self-insert-command)
      (<span style="color: #4c83ff;">setq</span> i (1+ i)))
    (<span style="color: #4c83ff;">dolist</span> (i (number-sequence ?1 ?9))
      (define-key map (char-to-string i) 'pyim-page-select-word-by-number))
    (define-key map <span style="color: #61CE3C;">" "</span> 'pyim-page-select-word)
    (define-key map [backspace] 'pyim-delete-last-char)
    (define-key map [delete] 'pyim-delete-last-char)
    (define-key map [M-backspace] 'pyim-backward-kill-py)
    (define-key map [M-delete] 'pyim-backward-kill-py)
    (define-key map [C-backspace] 'pyim-backward-kill-py)
    (define-key map [C-delete] 'pyim-backward-kill-py)
    (define-key map <span style="color: #61CE3C;">"\177"</span> 'pyim-delete-last-char)
    (define-key map <span style="color: #61CE3C;">"\C-n"</span> 'pyim-page-next-page)
    (define-key map <span style="color: #61CE3C;">"\C-p"</span> 'pyim-page-previous-page)
    (define-key map <span style="color: #61CE3C;">"\C-f"</span> 'pyim-page-next-word)
    (define-key map <span style="color: #61CE3C;">"\C-b"</span> 'pyim-page-previous-word)
    (define-key map <span style="color: #61CE3C;">"="</span> 'pyim-page-next-page)
    (define-key map <span style="color: #61CE3C;">"-"</span> 'pyim-page-previous-page)
    (define-key map <span style="color: #61CE3C;">"\M-n"</span> 'pyim-page-next-page)
    (define-key map <span style="color: #61CE3C;">"\M-p"</span> 'pyim-page-previous-page)
    (define-key map <span style="color: #61CE3C;">"\C-m"</span> 'pyim-quit-no-clear)
    (define-key map [return] 'pyim-quit-no-clear)
    (define-key map <span style="color: #61CE3C;">"\C-c"</span> 'pyim-quit-clear)
    map)
  <span style="color: #FBDE2D;">"Keymap"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf08e726" class="outline-3">
<h3 id="orgf08e726"><span class="section-number-3">2.2</span>将变量转换为 local 变量</h3>
<div class="outline-text-3" id="text-2-2">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">defvar</span> <span style="color: #ff69b4;">pyim-local-variable-list</span>
  '(pyim-entered-code
    pyim-dagger-str
    pyim-current-choices
    pyim-current-pos
    pyim-input-ascii
    pyim-english-input-switch-functions
    pyim-punctuation-half-width-functions
    pyim-translating
    pyim-dagger-overlay

    pyim-load-hook
    pyim-active-hook

    input-method-function
    inactivate-current-input-method-function
    describe-current-input-method-function

    pyim-punctuation-translate-p
    pyim-punctuation-pair-status
    pyim-punctuation-escape-list

    pyim-scode-list
    pyim-code-position)
  <span style="color: #FBDE2D;">"A list of buffer local variable"</span>)

(<span style="color: #4c83ff;">dolist</span> (var pyim-local-variable-list)
  (make-variable-buffer-local var)
  (put var 'permanent-local t))
</pre>
</div>
</div>
</div>
<div id="outline-container-org8e793a7" class="outline-3">
<h3 id="org8e793a7"><span class="section-number-3">2.3</span>输入法启动和重启</h3>
<div class="outline-text-3" id="text-2-3">
<p>
Chinese-pyim 使用 emacs 官方自带的输入法框架来启动输入法和重启输入法。所以我们首先需要使用 emacs 自带的命令 `register-input-method' 注册一个输入法。
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #8B8989; font-style: italic;">;;; </span><span style="color: #8B8989; font-style: italic;">&#27880;&#20876;&#36755;&#20837;&#27861;</span>
(register-input-method <span style="color: #61CE3C;">"chinese-pyim"</span> <span style="color: #61CE3C;">"euc-cn"</span> 'pyim-start pyim-title)
</pre>
</div>

<p>
真正启动 Chinese-pyim 的命令是 `pyim-start' ，这个命令做如下工作：
</p>
<ol class="org-ol">
<li>重置 `pyim-local-variable-list' 中所有的 local 变量。</li>
<li>使用 `pyim-cchar2pinyin-create-cache' 创建汉字到拼音的 hash table 。</li>
<li>运行hook： `pyim-load-hook'。</li>
<li>将 `pyim-dcache-save-caches' 命令添加到 `kill-emacs-hook' , emacs 关闭之前将 `pyim-dcache-icode2word' 和 `pyim-dcache-iword2count'
保存到文件，供以后使用。</li>
<li>设定变量：
<ol class="org-ol">
<li>`input-method-function'</li>
<li>`deactivate-current-input-method-function'</li>
</ol></li>
<li>运行 `pyim-active-hook'</li>
</ol>

<p>
`pyim-start' 先后会运行两个 hook，所以我们需要事先定义：
</p>

<p>
`pyim-restart' 用于重启 Chinese-pyim，其过程和 `pyim-start' 类似，只是在输入法重启之前，询问用户，是否保存个人词频信息。
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-start</span> (name <span style="color: #afd8af;">&amp;optional</span> active-func restart save-personal-dcache refresh-common-dcache)
  (<span style="color: #4c83ff;">interactive</span>)
  (mapc 'kill-local-variable pyim-local-variable-list)
  (mapc 'make-local-variable pyim-local-variable-list)
  (<span style="color: #4c83ff;">when</span> (<span style="color: #4c83ff;">and</span> restart save-personal-dcache)
    (pyim-dcache-save-caches))
  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#35774;&#32622;&#20110; dcache &#30456;&#20851;&#30340;&#20960;&#20010;&#21464;&#37327;&#12290;</span>
  (pyim-dcache-init-variables)
  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#20351;&#29992; pyim-dcache-iword2count &#20013;&#30340;&#20449;&#24687;&#23545; personal &#32531;&#23384;&#20013;&#30340;&#35789;&#39057;&#36827;&#34892;&#35843;&#25972;&#12290;</span>
  (pyim-dcache-update:icode2word restart)
  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#21019;&#24314;&#31616;&#25340;&#32531;&#23384;&#65292; &#27604;&#22914; "ni-hao" -&gt; "n-h"</span>
  (pyim-dcache-update:ishortcode2word restart)
  (pyim-cchar2pinyin-cache-create)
  (pyim-pinyin2cchar-cache-create)
  (run-hooks 'pyim-load-hook)
  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#22914;&#26524; `</span><span style="color: #96CBFE; font-style: italic;">pyim-dicts</span><span style="color: #8B8989; font-style: italic;">' &#26377;&#21464;&#21270;&#65292;&#37325;&#26032;&#29983;&#25104; `</span><span style="color: #96CBFE; font-style: italic;">pyim-dcache-code2word</span><span style="color: #8B8989; font-style: italic;">' &#32531;&#23384;&#12290;</span>
  (pyim-dcache-update:code2word refresh-common-dcache)
  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#36825;&#20010;&#21629;&#20196; *&#24403;&#21069;* &#20027;&#35201;&#29992;&#20110;&#20116;&#31508;&#36755;&#20837;&#27861;&#12290;</span>
  (pyim-dcache-update:shortcode2word restart)
  (<span style="color: #4c83ff;">unless</span> (member 'pyim-dcache-save-caches kill-emacs-hook)
    (add-to-list 'kill-emacs-hook 'pyim-dcache-save-caches))
  (<span style="color: #4c83ff;">setq</span> input-method-function 'pyim-input-method)
  (<span style="color: #4c83ff;">setq</span> deactivate-current-input-method-function 'pyim-inactivate)
  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">(setq describe-current-input-method-function 'pyim-help)</span>
  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">If we are in minibuffer, turn off the current input method</span>
  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">before exiting.</span>
  (<span style="color: #4c83ff;">when</span> (eq (selected-window) (minibuffer-window))
    (add-hook 'minibuffer-exit-hook 'pyim-exit-from-minibuffer))
  (run-hooks 'pyim-active-hook)
  (<span style="color: #4c83ff;">when</span> restart
    (message <span style="color: #61CE3C;">"Chinese-pyim &#37325;&#21551;&#23436;&#25104;&#12290;"</span>))
  nil)

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-exit-from-minibuffer</span> ()
  (deactivate-input-method)
  (<span style="color: #4c83ff;">when</span> (&lt;= (minibuffer-depth) 1)
    (remove-hook 'minibuffer-exit-hook 'quail-exit-from-minibuffer)))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-restart</span> ()
  <span style="color: #FBDE2D;">"&#37325;&#21551; Chinese-pyim&#65292;&#19981;&#24314;&#35758;&#29992;&#20110;&#32534;&#31243;&#29615;&#22659;&#12290;"</span>
  (<span style="color: #4c83ff;">interactive</span>
   (<span style="color: #4c83ff;">let</span> ((save-personal-dcache
          (yes-or-no-p <span style="color: #61CE3C;">"&#37325;&#21551; Chinese-pyim &#21069;&#65292;&#38656;&#35201;&#20445;&#23384;&#20010;&#20154;&#35789;&#39057;&#20449;&#24687;&#21527;&#65311; "</span>))
         (refresh-common-dcache
          (yes-or-no-p <span style="color: #61CE3C;">"&#38656;&#35201;&#24378;&#21046;&#21047;&#26032;&#35789;&#24211;&#32531;&#23384;&#21527;&#65311; "</span>)))
     (pyim-restart-1 save-personal-dcache refresh-common-dcache))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-restart-1</span> (<span style="color: #afd8af;">&amp;optional</span> save-personal-dcache refresh-common-dcache)
  <span style="color: #FBDE2D;">"&#37325;&#21551; Chinese-pyim&#65292;&#29992;&#20110;&#32534;&#31243;&#29615;&#22659;&#12290;"</span>
  (pyim-start <span style="color: #61CE3C;">"Chinese-pyim"</span> nil t
              save-personal-dcache refresh-common-dcache))
</pre>
</div>
</div>
</div>
<div id="outline-container-org429a82b" class="outline-3">
<h3 id="org429a82b"><span class="section-number-3">2.4</span>处理词库文件</h3>
<div class="outline-text-3" id="text-2-4">
</div><div id="outline-container-orgbd794a9" class="outline-4">
<h4 id="orgbd794a9"><span class="section-number-4">2.4.1</span>自定义词库</h4>
<div class="outline-text-4" id="text-2-4-1">
</div><div id="outline-container-org5c248be" class="outline-5">
<h5 id="org5c248be"><span class="section-number-5">2.4.1.1</span>词库文件格式</h5>
<div class="outline-text-5" id="text-2-4-1-1">
<p>
Chinese-pyim 使用的词库文件是简单的文本文件，编码<b>强制</b>为 'utf-8-unix,
结构类似：
</p>

<pre class="example">
ni-bu-hao 你不好
ni-hao  你好 妮好 你豪
</pre>

<p>
第一个空白字符之前的内容为 code，空白字符之后为中文词条列表。词库<b>不处理</b>中文标点符号。
</p>

<p>
我们使用变量 `pyim-dicts' 和 `pyim-extra-dicts' 来设定词库文件的信息：
</p>

<ol class="org-ol">
<li>`:name' 用户给词库设定的名称（可选项）。</li>
<li>`:file' 词库文件的绝对路径。</li>
</ol>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-dcache-update:code2word</span> (<span style="color: #afd8af;">&amp;optional</span> force)
  <span style="color: #FBDE2D;">"&#35835;&#21462; `</span><span style="color: #96CBFE;">pyim-dicts</span><span style="color: #FBDE2D;">' &#21644; `</span><span style="color: #96CBFE;">pyim-extra-dicts</span><span style="color: #FBDE2D;">' &#37324;&#38754;&#30340;&#35789;&#24211;&#25991;&#20214;&#65292;&#29983;&#25104;&#23545;&#24212;&#30340;&#35789;&#24211;&#32531;&#20914;&#25991;&#20214;&#12290;</span>
<span style="color: #FBDE2D;">&#28982;&#21518;&#21152;&#36733;&#35789;&#24211;&#32531;&#23384;&#12290;"</span>
  (<span style="color: #4c83ff;">interactive</span>)
  (<span style="color: #4c83ff;">let*</span> ((version <span style="color: #61CE3C;">"v1"</span>) <span style="color: #8B8989; font-style: italic;">;</span><span style="color: #8B8989; font-style: italic;">&#24403;&#38656;&#35201;&#24378;&#21046;&#26356;&#26032; dict &#32531;&#23384;&#26102;&#65292;&#26356;&#25913;&#36825;&#20010;&#23383;&#31526;&#20018;&#12290;</span>
         (dict-files (mapcar #'(lambda (x)
                                 (<span style="color: #4c83ff;">unless</span> (plist-get x <span style="color: #4c83ff;">:disable</span>)
                                   (plist-get x <span style="color: #4c83ff;">:file</span>)))
                             `(,@pyim-dicts ,@pyim-extra-dicts)))
         (dicts-md5 (md5 (prin1-to-string
                          (mapcar #'(lambda (file)
                                      (list version file (nth 5 (file-attributes file 'string))))
                                  dict-files))))
         (code2word-file (pyim-dcache-get-path 'pyim-dcache-code2word))
         (word2code-file (pyim-dcache-get-path 'pyim-dcache-word2code))
         (code2word-md5-file (pyim-dcache-get-path 'pyim-dcache-code2word-md5)))
    (<span style="color: #4c83ff;">when</span> (<span style="color: #4c83ff;">or</span> force (not (equal dicts-md5 (pyim-dcache-get-value-from-file code2word-md5-file))))
      (async-start
       `(<span style="color: #4c83ff;">lambda</span> ()
          ,(async-inject-variables <span style="color: #61CE3C;">"^load-path$"</span>)
          ,(async-inject-variables <span style="color: #61CE3C;">"^exec-path$"</span>)
          ,(async-inject-variables <span style="color: #61CE3C;">"^pyim-.+?directory$"</span>)
          (<span style="color: #4c83ff;">require</span> '<span style="color: #96CBFE;">chinese-pyim-core</span>)
          (<span style="color: #4c83ff;">let</span> ((dcache (pyim-dcache-generate-dcache-file ',dict-files ,code2word-file)))
            (pyim-dcache-generate-word2code-dcache-file dcache ,word2code-file))
          (pyim-dcache-save-value-to-file ',dicts-md5 ,code2word-md5-file))
       `(<span style="color: #4c83ff;">lambda</span> (result)
          (pyim-dcache-set-variable 'pyim-dcache-code2word t)
          (pyim-dcache-set-variable 'pyim-dcache-word2code t))))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-dcache-update:ishortcode2word</span> (<span style="color: #afd8af;">&amp;optional</span> force)
  <span style="color: #FBDE2D;">"&#35835;&#21462; pyim-dcache-icode2word &#20013;&#30340;&#35789;&#24211;&#65292;&#21019;&#24314; *&#31616;&#25340;* &#32531;&#23384;&#65292;&#28982;&#21518;&#21152;&#36733;&#36825;&#20010;&#32531;&#23384;&#12290;"</span>
  (<span style="color: #4c83ff;">interactive</span>)
  (<span style="color: #4c83ff;">when</span> (<span style="color: #4c83ff;">or</span> force (not pyim-dcache-update:ishortcode2word))
    (async-start
     `(<span style="color: #4c83ff;">lambda</span> ()
        ,(async-inject-variables <span style="color: #61CE3C;">"^load-path$"</span>)
        ,(async-inject-variables <span style="color: #61CE3C;">"^exec-path$"</span>)
        ,(async-inject-variables <span style="color: #61CE3C;">"^pyim-.+?directory$"</span>)
        (<span style="color: #4c83ff;">require</span> '<span style="color: #96CBFE;">chinese-pyim-core</span>)
        (pyim-dcache-set-variable 'pyim-dcache-icode2word)
        (pyim-dcache-set-variable 'pyim-dcache-iword2count)
        (<span style="color: #4c83ff;">setq</span> pyim-dcache-ishortcode2word
              (make-hash-table <span style="color: #4c83ff;">:test</span> #'equal))
        (maphash
         #'(lambda (key value)
             (<span style="color: #4c83ff;">let</span> ((newkey (mapconcat
                            #'(lambda (x)
                                (substring x 0 1))
                            (split-string key <span style="color: #61CE3C;">"-"</span>) <span style="color: #61CE3C;">"-"</span>)))
               (puthash newkey
                        (delete-dups
                         `(,@value
                           ,@(gethash newkey pyim-dcache-ishortcode2word)))
                        pyim-dcache-ishortcode2word)))
         pyim-dcache-icode2word)
        (maphash
         #'(lambda (key value)
             (puthash key (pyim-dcache-sort-words value)
                      pyim-dcache-ishortcode2word))
         pyim-dcache-ishortcode2word)
        (pyim-dcache-save-variable 'pyim-dcache-ishortcode2word))
     `(<span style="color: #4c83ff;">lambda</span> (result)
        (<span style="color: #4c83ff;">setq</span> pyim-dcache-create-abbrev-dcache-p t)
        (pyim-dcache-set-variable 'pyim-dcache-ishortcode2word t)))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-dcache-update:icode2word</span> (<span style="color: #afd8af;">&amp;optional</span> force)
  <span style="color: #FBDE2D;">"&#20351;&#29992; pyim-dcache-icode2count &#20013;&#35760;&#24405;&#30340;&#35789;&#39057;&#20449;&#24687;&#65292;</span>
<span style="color: #FBDE2D;">&#23545; personal &#32531;&#23384;&#20013;&#30340;&#35789;&#26465;&#36827;&#34892;&#25490;&#24207;&#65292;&#21152;&#36733;&#25490;&#24207;&#21518;&#30340;&#32467;&#26524;&#12290;"</span>
  (<span style="color: #4c83ff;">interactive</span>)
  (<span style="color: #4c83ff;">when</span> (<span style="color: #4c83ff;">or</span> force (not pyim-dcache-update:icode2word))
    (async-start
     `(<span style="color: #4c83ff;">lambda</span> ()
        ,(async-inject-variables <span style="color: #61CE3C;">"^load-path$"</span>)
        ,(async-inject-variables <span style="color: #61CE3C;">"^exec-path$"</span>)
        ,(async-inject-variables <span style="color: #61CE3C;">"^pyim-.+?directory$"</span>)
        (<span style="color: #4c83ff;">require</span> '<span style="color: #96CBFE;">chinese-pyim-core</span>)
        (pyim-dcache-set-variable 'pyim-dcache-icode2word)
        (pyim-dcache-set-variable 'pyim-dcache-iword2count)
        (maphash
         #'(lambda (key value)
             (puthash key (pyim-dcache-sort-words value)
                      pyim-dcache-icode2word))
         pyim-dcache-icode2word)
        (pyim-dcache-save-variable 'pyim-dcache-icode2word)
        nil)
     `(<span style="color: #4c83ff;">lambda</span> (result)
        (<span style="color: #4c83ff;">setq</span> pyim-dcache-update:icode2word t)
        (pyim-dcache-set-variable 'pyim-dcache-icode2word t)))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-dcache-update:shortcode2word</span> (<span style="color: #afd8af;">&amp;optional</span> force)
  <span style="color: #FBDE2D;">"&#20351;&#29992; pyim-dcache-code2word &#20013;&#30340;&#35789;&#26465;&#65292;&#21019;&#24314; &#31616;&#20889;code &#35789;&#24211;&#32531;&#23384;&#24182;&#21152;&#36733;&#12290; "</span>
  (<span style="color: #4c83ff;">interactive</span>)
  (<span style="color: #4c83ff;">when</span> (<span style="color: #4c83ff;">or</span> force (not pyim-dcache-update:shortcode2word))
    (async-start
     `(<span style="color: #4c83ff;">lambda</span> ()
        ,(async-inject-variables <span style="color: #61CE3C;">"^load-path$"</span>)
        ,(async-inject-variables <span style="color: #61CE3C;">"^exec-path$"</span>)
        ,(async-inject-variables <span style="color: #61CE3C;">"^pyim-.+?directory$"</span>)
        (<span style="color: #4c83ff;">require</span> '<span style="color: #96CBFE;">chinese-pyim-core</span>)
        (pyim-dcache-set-variable 'pyim-dcache-code2word)
        (pyim-dcache-set-variable 'pyim-dcache-iword2count)
        (<span style="color: #4c83ff;">setq</span> pyim-dcache-shortcode2word
              (make-hash-table <span style="color: #4c83ff;">:test</span> #'equal))
        (maphash
         #'(lambda (key value)
             (<span style="color: #4c83ff;">dolist</span> (x (pyim-dcache-return-shortcode key))
               (puthash x
                        (mapcar
                         #'(lambda (word)
                             <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#36825;&#20010;&#22320;&#26041;&#30340;&#20195;&#30721;&#29992;&#20110;&#23454;&#29616;&#20116;&#31508; code &#33258;&#21160;&#25552;&#31034;&#21151;&#33021;&#65292;</span>
                             <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#27604;&#22914;&#36755;&#20837; 'aa' &#21518;&#24471;&#21040;&#36873;&#35789;&#26694;&#65306;</span>
                             <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">----------------------</span>
                             <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">| 1. &#33665;aa 2.&#21302;wv ... |</span>
                             <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">----------------------</span>
                             (<span style="color: #4c83ff;">if</span> (string-match-p <span style="color: #61CE3C;">":"</span>  word)
                                 word
                               (concat word <span style="color: #61CE3C;">":"</span> (substring key (length x)))))
                         (delete-dups `(,@value ,@(gethash x pyim-dcache-shortcode2word))))
                        pyim-dcache-shortcode2word)))
         pyim-dcache-code2word)
        (maphash
         #'(lambda (key value)
             (puthash key (pyim-dcache-sort-words value)
                      pyim-dcache-shortcode2word))
         pyim-dcache-shortcode2word)
        (pyim-dcache-save-variable 'pyim-dcache-shortcode2word)
        nil)
     `(<span style="color: #4c83ff;">lambda</span> (result)
        (<span style="color: #4c83ff;">setq</span> pyim-dcache-update:shortcode2word t)
        (pyim-dcache-set-variable 'pyim-dcache-shortcode2word t)))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-dcache-return-shortcode</span> (code)
  <span style="color: #FBDE2D;">"&#33719;&#21462;&#19968;&#20010; code &#30340;&#25152;&#26377;&#31616;&#20889;&#12290;</span>

<span style="color: #FBDE2D;">&#27604;&#22914;&#65306;.nihao -&gt; .nihao .niha .nih .ni .n"</span>
  (<span style="color: #4c83ff;">when</span> (<span style="color: #4c83ff;">and</span> (&gt; (length code) 0)
             (not (string-match-p <span style="color: #61CE3C;">"-"</span> code))
             (pyim-string-match-p <span style="color: #61CE3C;">"^[[:punct:]]"</span> code))
    (<span style="color: #4c83ff;">let*</span> ((code1 (substring code 1))
           (prefix (substring code 0 1))
           (n (length code1))
           results)
      (<span style="color: #4c83ff;">dotimes</span> (i n)
        (<span style="color: #4c83ff;">when</span> (&gt; i 1)
          (<span style="color: #4c83ff;">push</span> (concat prefix (substring code1 0 i)) results)))
      results)))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-dcache-sort-words</span> (words-list)
  <span style="color: #FBDE2D;">"&#20351;&#29992; `</span><span style="color: #96CBFE;">pyim-dcache-icode2count</span><span style="color: #FBDE2D;">' &#20013;&#35760;&#24405;&#30340;&#35789;&#39057;&#20449;&#24687;&#65292;</span>
<span style="color: #FBDE2D;">&#23545; `</span><span style="color: #96CBFE;">words-list</span><span style="color: #FBDE2D;">' &#25490;&#24207;&#65292;&#35789;&#39057;&#22823;&#30340;&#25490;&#22312;&#21069;&#38754;&#12290;"</span>
  (sort words-list
        #'(lambda (a b)
            (<span style="color: #4c83ff;">let</span> ((a (car (split-string a <span style="color: #61CE3C;">":"</span>)))
                  (b (car (split-string b <span style="color: #61CE3C;">":"</span>))))
              (&gt; (<span style="color: #4c83ff;">or</span> (gethash a pyim-dcache-iword2count) 0)
                 (<span style="color: #4c83ff;">or</span> (gethash b pyim-dcache-iword2count) 0))))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-dcache-get-path</span> (variable)
  <span style="color: #FBDE2D;">"&#33719;&#21462;&#20445;&#23384; `</span><span style="color: #96CBFE;">variable</span><span style="color: #FBDE2D;">' &#21462;&#20540;&#30340;&#25991;&#20214;&#30340;&#36335;&#24452;&#12290;"</span>
  (<span style="color: #4c83ff;">when</span> (symbolp variable)
    (concat (file-name-as-directory pyim-dcache-directory)
            (symbol-name variable))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-dcache-init-variables</span> ()
  <span style="color: #FBDE2D;">"&#21021;&#22987;&#21270; dcache &#32531;&#23384;&#30456;&#20851;&#21464;&#37327;&#12290;"</span>
  (pyim-dcache-set-variable 'pyim-dcache-code2word)
  (pyim-dcache-set-variable 'pyim-dcache-word2count)
  (pyim-dcache-set-variable 'pyim-dcache-word2code)
  (pyim-dcache-set-variable 'pyim-dcache-shortcode2word)
  (pyim-dcache-set-variable 'pyim-dcache-icode2word)
  (pyim-dcache-set-variable 'pyim-dcache-iword2count)
  (pyim-dcache-set-variable 'pyim-dcache-ishortcode2word))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-dcache-set-variable</span> (variable <span style="color: #afd8af;">&amp;optional</span> force-restore fallback-value)
  <span style="color: #FBDE2D;">"&#22914;&#26524; `</span><span style="color: #96CBFE;">variable</span><span style="color: #FBDE2D;">' &#30340;&#20540;&#20026; nil, &#21017;&#20351;&#29992; `</span><span style="color: #96CBFE;">pyim-dcache-directory</span><span style="color: #FBDE2D;">' &#20013;&#23545;&#24212;&#25991;&#20214;&#30340;&#20869;&#23481;&#26469;&#35774;&#32622;</span>
<span style="color: #FBDE2D;">`</span><span style="color: #96CBFE;">variable</span><span style="color: #FBDE2D;">' &#21464;&#37327;&#65292;`</span><span style="color: #96CBFE;">force-restore</span><span style="color: #FBDE2D;">' &#35774;&#32622;&#20026; t &#26102;&#65292;&#24378;&#21046;&#24674;&#22797;&#65292;&#21464;&#37327;&#21407;&#26469;&#30340;&#20540;&#23558;&#20002;&#22833;&#12290;"</span>
  (<span style="color: #4c83ff;">when</span> (<span style="color: #4c83ff;">or</span> force-restore (not (symbol-value variable)))
    (<span style="color: #4c83ff;">let</span> ((file (concat (file-name-as-directory pyim-dcache-directory)
                        (symbol-name variable))))
      (set variable (<span style="color: #4c83ff;">or</span> (pyim-dcache-get-value-from-file file)
                        fallback-value
                        (make-hash-table <span style="color: #4c83ff;">:test</span> #'equal))))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-dcache-get-value-from-file</span> (file)
  <span style="color: #FBDE2D;">"&#35835;&#21462;&#20445;&#23384;&#21040; FILE &#37324;&#38754;&#30340; value&#12290;"</span>
  (<span style="color: #4c83ff;">when</span> (file-exists-p file)
    (<span style="color: #4c83ff;">with-temp-buffer</span>
      (insert-file-contents file)
      (eval (read (current-buffer))))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-dcache-save-variable</span> (variable)
  <span style="color: #FBDE2D;">"&#23558; `</span><span style="color: #96CBFE;">variable</span><span style="color: #FBDE2D;">' &#21464;&#37327;&#30340;&#21462;&#20540;&#20445;&#23384;&#21040; `</span><span style="color: #96CBFE;">pyim-dcache-directory</span><span style="color: #FBDE2D;">' &#20013;&#23545;&#24212;&#25991;&#20214;&#20013;&#12290;"</span>
  (<span style="color: #4c83ff;">let</span> ((file (concat (file-name-as-directory pyim-dcache-directory)
                      (symbol-name variable)))
        (value (symbol-value variable)))
    (pyim-dcache-save-value-to-file value file)))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-dcache-save-value-to-file</span> (value file)
  <span style="color: #FBDE2D;">"&#23558; `</span><span style="color: #96CBFE;">value</span><span style="color: #FBDE2D;">' &#20445;&#23384;&#21040; `</span><span style="color: #96CBFE;">file</span><span style="color: #FBDE2D;">' &#25991;&#20214;&#20013;&#12290;"</span>
  (<span style="color: #4c83ff;">when</span> value
    (<span style="color: #4c83ff;">with-temp-buffer</span>
      (insert <span style="color: #61CE3C;">";; Auto generated by `</span><span style="color: #96CBFE;">pyim-dcache-save-variable-to-file</span><span style="color: #61CE3C;">', don't edit it by hand!\n"</span>)
      (insert (format <span style="color: #61CE3C;">";; Build time: %s\n\n"</span> (current-time-string)))
      (insert (prin1-to-string value))
      (insert <span style="color: #61CE3C;">"\n</span>
<span style="color: #61CE3C;">;; Local Variables&#58;</span>
<span style="color: #61CE3C;">;; coding: utf-8-unix</span>
<span style="color: #61CE3C;">;; End:"</span>)
      (make-directory (file-name-directory file) t)
      (write-file file))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-dcache-generate-dcache-file</span> (dict-files dcache-file)
  <span style="color: #FBDE2D;">"&#35835;&#21462;&#35789;&#24211;&#25991;&#20214;&#21015;&#34920;&#65306; `</span><span style="color: #96CBFE;">dict-files</span><span style="color: #FBDE2D;">', &#29983;&#25104;&#19968;&#20010;&#35789;&#24211;&#32531;&#20914;&#25991;&#20214; `</span><span style="color: #96CBFE;">dcache-file</span><span style="color: #FBDE2D;">'. "</span>
  (<span style="color: #4c83ff;">let</span> ((hashtable (make-hash-table <span style="color: #4c83ff;">:size</span> 1000000 <span style="color: #4c83ff;">:test</span> #'equal)))
    (<span style="color: #4c83ff;">dolist</span> (file dict-files)
      (<span style="color: #4c83ff;">with-temp-buffer</span>
        (<span style="color: #4c83ff;">let</span> ((coding-system-for-read 'utf-8-unix))
          (insert-file-contents file))
        (goto-char (point-min))
        (forward-line 1)
        (<span style="color: #4c83ff;">while</span> (not (eobp))
          (<span style="color: #4c83ff;">let</span> ((code (pyim-code-at-point))
                (content (pyim-line-content)))
            (<span style="color: #4c83ff;">when</span> (<span style="color: #4c83ff;">and</span> code content)
              (puthash code
                       (delete-dups `(,@content ,@(gethash code hashtable)))
                       hashtable)))
          (forward-line 1))))
    (pyim-dcache-save-value-to-file hashtable dcache-file)
    hashtable))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-dcache-generate-word2code-dcache-file</span> (dcache file)
  <span style="color: #FBDE2D;">"`</span><span style="color: #96CBFE;">dcache</span><span style="color: #FBDE2D;">' &#26159;&#19968;&#20010; code -&gt; words &#30340; hashtable, &#26681;&#25454;&#36825;&#20010;&#34920;&#30340;</span>
<span style="color: #FBDE2D;">&#20869;&#23481;&#65292;&#29983;&#25104;&#19968;&#20010; word -&gt; code &#30340;&#21453;&#21521;&#26597;&#35810;&#34920;&#12290;"</span>
  (<span style="color: #4c83ff;">when</span> (hash-table-p dcache)
    (<span style="color: #4c83ff;">let</span> ((hashtable (make-hash-table <span style="color: #4c83ff;">:size</span> 1000000 <span style="color: #4c83ff;">:test</span> #'equal)))
      (maphash
       #'(lambda (code words)
           (<span style="color: #4c83ff;">unless</span> (pyim-string-match-p <span style="color: #61CE3C;">"-"</span> code)
             (<span style="color: #4c83ff;">dolist</span> (word words)
               (<span style="color: #4c83ff;">let</span> ((value (gethash word hashtable)))
                 (puthash word
                          (<span style="color: #4c83ff;">if</span> value
                              `(,code ,@value)
                            (list code))
                          hashtable)))))
       dcache)
      (pyim-dcache-save-value-to-file hashtable file))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-code-at-point</span> ()
  <span style="color: #FBDE2D;">"Get code in the current line."</span>
  (<span style="color: #4c83ff;">save-excursion</span>
    (beginning-of-line)
    (<span style="color: #4c83ff;">if</span> (re-search-forward <span style="color: #61CE3C;">"[ \t:]"</span> (line-end-position) t)
        (buffer-substring-no-properties (line-beginning-position) (1- (point))))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-line-content</span> (<span style="color: #afd8af;">&amp;optional</span> seperaters)
  <span style="color: #FBDE2D;">"&#29992; SEPERATERS &#20998;&#35299;&#24403;&#21069;&#34892;&#65292;&#25152;&#26377;&#21442;&#25968;&#20256;&#36882;&#32473; split-string &#20989;&#25968;&#12290;"</span>
  (<span style="color: #4c83ff;">let*</span> ((begin (line-beginning-position))
         (end (line-end-position))
         (items (cdr (split-string
                      (buffer-substring-no-properties begin end)
                      seperaters))))
    items))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-dcache-save-caches</span> ()
  <span style="color: #FBDE2D;">"&#23558; `</span><span style="color: #96CBFE;">pyim-dcache-icode2word</span><span style="color: #FBDE2D;">' &#21644; `</span><span style="color: #96CBFE;">pyim-dcache-iword2count</span><span style="color: #FBDE2D;">' &#21462;&#20540;</span>
<span style="color: #FBDE2D;">&#20445;&#23384;&#21040;&#23427;&#20204;&#23545;&#24212;&#30340;&#25991;&#20214;&#20013;&#12290;</span>

<span style="color: #FBDE2D;">&#36825;&#20010;&#20989;&#25968;&#40664;&#35748;&#20316;&#20026; `</span><span style="color: #96CBFE;">kill-emacs-hook</span><span style="color: #FBDE2D;">' &#20351;&#29992;&#12290;"</span>
  (<span style="color: #4c83ff;">interactive</span>)
  (pyim-dcache-save-variable 'pyim-dcache-icode2word)
  (pyim-dcache-save-variable 'pyim-dcache-iword2count)
  t)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb83d5a5" class="outline-4">
<h4 id="orgb83d5a5"><span class="section-number-4">2.4.2</span>从词库中搜索中文词条</h4>
<div class="outline-text-4" id="text-2-4-2">
<p>
当词库文件加载完成后， Chinese-pyim 就可以从词库缓存中搜索某个
code 对应的中文词条了，这个工作由函数 `pyim-dcache-get' 完成。
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-dcache-get</span> (code <span style="color: #afd8af;">&amp;optional</span> dcache-list)
  (<span style="color: #4c83ff;">let</span> ((dcache-list (<span style="color: #4c83ff;">or</span> (<span style="color: #4c83ff;">if</span> (listp dcache-list)
                             dcache-list
                           (list dcache-list))
                         (list pyim-dcache-icode2word pyim-dcache-code2word)))
        result)
    (<span style="color: #4c83ff;">dolist</span> (cache dcache-list)
      (<span style="color: #4c83ff;">let</span> ((value (gethash code cache)))
        (<span style="color: #4c83ff;">when</span> value
          (<span style="color: #4c83ff;">setq</span> result (append result value)))))
    `(,@result ,@(pyim-pinyin2cchar-get code t t))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-string-match-p</span> (regexp string <span style="color: #afd8af;">&amp;optional</span> start)
  (<span style="color: #4c83ff;">and</span> (stringp regexp)
       (stringp string)
       (string-match-p regexp string start)))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-pinyin-build-regexp</span> (pinyin <span style="color: #afd8af;">&amp;optional</span> match-beginning first-equal all-equal)
  <span style="color: #FBDE2D;">"&#20174; `</span><span style="color: #96CBFE;">pinyin</span><span style="color: #FBDE2D;">' &#26500;&#24314;&#19968;&#20010; regexp&#65292;&#29992;&#20110;&#25628;&#32034;&#32852;&#24819;&#35789;&#65292;</span>
<span style="color: #FBDE2D;">&#27604;&#22914;&#65306;ni-hao-si-j --&gt; ^ni-hao[a-z]*-si[a-z]*-j[a-z]* , when `</span><span style="color: #96CBFE;">first-equal</span><span style="color: #FBDE2D;">' set to `t'</span>
<span style="color: #FBDE2D;">                  --&gt; ^ni[a-z]*-hao[a-z]*-si[a-z]*-j[a-z]* , when `</span><span style="color: #96CBFE;">first-equal</span><span style="color: #FBDE2D;">' set to `</span><span style="color: #96CBFE;">nil</span><span style="color: #FBDE2D;">'"</span>
  (<span style="color: #4c83ff;">when</span> (<span style="color: #4c83ff;">and</span> pinyin (stringp pinyin))
    (<span style="color: #4c83ff;">let</span> ((pinyin-list (split-string pinyin <span style="color: #61CE3C;">"-"</span>))
          (count 0))
      (concat (<span style="color: #4c83ff;">if</span> match-beginning <span style="color: #61CE3C;">"^"</span> <span style="color: #61CE3C;">""</span>)
              (mapconcat
               #'(lambda (x)
                   (<span style="color: #4c83ff;">setq</span> count (+ count 1))
                   (<span style="color: #4c83ff;">if</span> (<span style="color: #4c83ff;">or</span> (not first-equal) (&gt; count 1))
                       (<span style="color: #4c83ff;">if</span> all-equal
                           x
                         (concat x <span style="color: #61CE3C;">"[a-z]*"</span>))
                     x))
               pinyin-list <span style="color: #61CE3C;">"-"</span>)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org0adbcc3" class="outline-4">
<h4 id="org0adbcc3"><span class="section-number-4">2.4.3</span>保存词条，删除词条以及调整词条位置</h4>
<div class="outline-text-4" id="text-2-4-3">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">defmacro</span> <span style="color: #ff1493;">pyim-dcache-put</span> (cache code <span style="color: #afd8af;">&amp;rest</span> body)
  (<span style="color: #4c83ff;">declare</span> (indent 0))
  (<span style="color: #4c83ff;">let</span> ((key (make-symbol <span style="color: #61CE3C;">"key"</span>))
        (table (make-symbol <span style="color: #61CE3C;">"table"</span>))
        (new-value (make-symbol <span style="color: #61CE3C;">"new-value"</span>)))
    `(<span style="color: #4c83ff;">let*</span> ((,key ,code)
            (,table ,cache)
            (orig-value (gethash ,key ,table))
            ,new-value)
       (<span style="color: #4c83ff;">setq</span> ,new-value (<span style="color: #4c83ff;">progn</span> ,@body))
       (<span style="color: #4c83ff;">unless</span> (equal orig-value ,new-value)
         (puthash ,key ,new-value ,table)))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-create-or-rearrange-word</span> (word <span style="color: #afd8af;">&amp;optional</span> rearrange-word)
  <span style="color: #FBDE2D;">"&#23558;&#20013;&#25991;&#35789;&#26465; `</span><span style="color: #96CBFE;">word</span><span style="color: #FBDE2D;">' &#28155;&#21152;&#25340;&#38899;&#21518;&#65292;&#20445;&#23384;&#21040; `</span><span style="color: #96CBFE;">pyim-dcache-icode2word</span><span style="color: #FBDE2D;">' &#20013;&#65292;</span>
<span style="color: #FBDE2D;">&#35789;&#26465; `</span><span style="color: #96CBFE;">word</span><span style="color: #FBDE2D;">' &#20250;&#36861;&#21152;&#21040;&#24050;&#26377;&#35789;&#26465;&#30340;&#21518;&#38754;&#12290;</span>

<span style="color: #FBDE2D;">`</span><span style="color: #96CBFE;">pyim-create-or-rearrange-word</span><span style="color: #FBDE2D;">' &#20250;&#35843;&#29992; `</span><span style="color: #96CBFE;">pyim-hanzi2pinyin</span><span style="color: #FBDE2D;">' &#26469;&#33719;&#21462;&#20013;&#25991;&#35789;&#26465;</span>
<span style="color: #FBDE2D;">&#30340;&#25340;&#38899; code&#12290;</span>

<span style="color: #FBDE2D;">BUG&#65306;&#26080;&#27861;&#26377;&#25928;&#30340;&#22788;&#29702;&#22810;&#38899;&#23383;&#12290;"</span>
  (<span style="color: #4c83ff;">when</span> (<span style="color: #4c83ff;">and</span> (&gt; (length word) 0)
             (not (pyim-string-match-p <span style="color: #61CE3C;">"\\CC"</span> word)))
    (<span style="color: #4c83ff;">let*</span> ((pinyins (pyim-hanzi2pinyin word nil <span style="color: #61CE3C;">"-"</span> t nil t))) <span style="color: #8B8989; font-style: italic;">;</span><span style="color: #8B8989; font-style: italic;">&#20351;&#29992;&#20102;&#22810;&#38899;&#23383;&#26657;&#27491;</span>
      <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#20445;&#23384;&#23545;&#24212;&#35789;&#26465;&#30340;&#35789;&#39057;</span>
      (<span style="color: #4c83ff;">when</span> (&gt; (length word) 0)
        (<span style="color: #4c83ff;">pyim-dcache-put</span>
          pyim-dcache-iword2count word
          (+ (<span style="color: #4c83ff;">or</span> orig-value 0) 1)))
      <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#28155;&#21152;&#35789;&#26465;&#21040;&#20010;&#20154;&#32531;&#23384;</span>
      (<span style="color: #4c83ff;">dolist</span> (py pinyins)
        (<span style="color: #4c83ff;">unless</span> (pyim-string-match-p <span style="color: #61CE3C;">"[</span><span style="color: #61CE3C;">^</span><span style="color: #61CE3C;"> a-z-]"</span> py)
          (<span style="color: #4c83ff;">pyim-dcache-put</span>
            pyim-dcache-icode2word py
            (<span style="color: #4c83ff;">if</span> rearrange-word
                (pyim-list-merge word orig-value)
              (pyim-list-merge orig-value word))))))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-list-merge</span> (a b)
  <span style="color: #FBDE2D;">"Join list A and B to a new list, then delete dups."</span>
  (<span style="color: #4c83ff;">let</span> ((a (<span style="color: #4c83ff;">if</span> (listp a)
               a
             (list a)))
        (b (<span style="color: #4c83ff;">if</span> (listp b)
               b
             (list b))))
    (delete-dups `(,@a ,@b))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-cstring-at-point</span> (<span style="color: #afd8af;">&amp;optional</span> number)
  <span style="color: #FBDE2D;">"&#33719;&#21462;&#20809;&#26631;&#19968;&#20010;&#20013;&#25991;&#23383;&#31526;&#20018;&#65292;&#23383;&#31526;&#25968;&#37327;&#20026;&#65306;`</span><span style="color: #96CBFE;">number</span><span style="color: #FBDE2D;">'"</span>
  (<span style="color: #4c83ff;">save-excursion</span>
    (<span style="color: #4c83ff;">let*</span> ((point (point))
           (begin (- point number))
           (begin (<span style="color: #4c83ff;">if</span> (&gt; begin 0)
                      begin
                    (point-min)))
           (string (buffer-substring-no-properties
                    point begin)))
      (<span style="color: #4c83ff;">when</span> (<span style="color: #4c83ff;">and</span> (stringp string)
                 (= (length string) number)
                 (not (pyim-string-match-p <span style="color: #61CE3C;">"\\CC"</span> string)))
        string))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-create-word-at-point</span> (<span style="color: #afd8af;">&amp;optional</span> number silent)
  <span style="color: #FBDE2D;">"&#23558;&#20809;&#26631;&#21069;&#23383;&#31526;&#25968;&#20026; `</span><span style="color: #96CBFE;">number</span><span style="color: #FBDE2D;">' &#30340;&#20013;&#25991;&#23383;&#31526;&#20018;&#28155;&#21152;&#21040;&#20010;&#20154;&#35789;&#24211;&#20013;</span>
<span style="color: #FBDE2D;">&#24403; `</span><span style="color: #96CBFE;">silent</span><span style="color: #FBDE2D;">' &#35774;&#32622;&#20026; t &#26159;&#65292;&#19981;&#26174;&#31034;&#25552;&#37266;&#20449;&#24687;&#12290;"</span>
  (<span style="color: #4c83ff;">let*</span> ((string (pyim-cstring-at-point (<span style="color: #4c83ff;">or</span> number 2))))
    (<span style="color: #4c83ff;">when</span> string
      (pyim-create-or-rearrange-word string)
      (<span style="color: #4c83ff;">unless</span> silent
        (message <span style="color: #61CE3C;">"&#23558;&#35789;&#26465;: \"%s\" &#21152;&#20837; personal &#32531;&#20914;&#12290;"</span> string)))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-create-word-at-point:2char</span> ()
  <span style="color: #FBDE2D;">"&#23558;&#20809;&#26631;&#21069;2&#20010;&#20013;&#25991;&#23383;&#31526;&#32452;&#25104;&#30340;&#23383;&#31526;&#20018;&#21152;&#20837;&#20010;&#20154;&#35789;&#24211;&#12290;"</span>
  (<span style="color: #4c83ff;">interactive</span>)
  (pyim-create-word-at-point 2))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-create-word-at-point:3char</span> ()
  <span style="color: #FBDE2D;">"&#23558;&#20809;&#26631;&#21069;3&#20010;&#20013;&#25991;&#23383;&#31526;&#32452;&#25104;&#30340;&#23383;&#31526;&#20018;&#21152;&#20837;&#20010;&#20154;&#35789;&#24211;&#12290;"</span>
  (<span style="color: #4c83ff;">interactive</span>)
  (pyim-create-word-at-point 3))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-create-word-at-point:4char</span> ()
  <span style="color: #FBDE2D;">"&#23558;&#20809;&#26631;&#21069;4&#20010;&#20013;&#25991;&#23383;&#31526;&#32452;&#25104;&#30340;&#23383;&#31526;&#20018;&#21152;&#20837;&#20010;&#20154;&#35789;&#24211;&#12290;"</span>
  (<span style="color: #4c83ff;">interactive</span>)
  (pyim-create-word-at-point 4))
</pre>
</div>
</div>

<div id="outline-container-orga2ffd30" class="outline-5">
<h5 id="orga2ffd30"><span class="section-number-5">2.4.3.1</span>删词功能</h5>
<div class="outline-text-5" id="text-2-4-3-1">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-create-word-from-selection</span> ()
  <span style="color: #FBDE2D;">"Add the selected text as a Chinese word into the personal dictionary."</span>
  (<span style="color: #4c83ff;">interactive</span>)
  (<span style="color: #4c83ff;">when</span> (region-active-p)
    (<span style="color: #4c83ff;">let</span> ((string (buffer-substring-no-properties (region-beginning) (region-end))))
      (<span style="color: #4c83ff;">if</span> (&gt; (length string) 6)
          (<span style="color: #ff69b4;">error</span> <span style="color: #61CE3C;">"&#35789;&#26465;&#22826;&#38271;"</span>)
        (<span style="color: #4c83ff;">if</span> (not (string-match-p <span style="color: #61CE3C;">"^\\cc+\\'"</span> string))
            (<span style="color: #ff69b4;">error</span> <span style="color: #61CE3C;">"&#19981;&#26159;&#32431;&#20013;&#25991;&#23383;&#31526;&#20018;"</span>)
          (pyim-create-or-rearrange-word string)
          (message <span style="color: #61CE3C;">"&#23558;&#35789;&#26465;: %S &#25554;&#20837; personal file&#12290;"</span> string))))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-search-word-code</span> ()
  <span style="color: #FBDE2D;">"&#36873;&#25321;&#35789;&#26465;&#65292;&#28982;&#21518;&#21453;&#26597;&#23427;&#30340; code. &#36825;&#20010;&#21151;&#33021;&#23545;&#20116;&#31508;&#29992;&#25143;&#26377;&#29992;&#12290;"</span>
  (<span style="color: #4c83ff;">interactive</span>)
  (<span style="color: #4c83ff;">when</span> (region-active-p)
    (<span style="color: #4c83ff;">let</span> ((string (buffer-substring-no-properties (region-beginning) (region-end)))
          code)
      (<span style="color: #4c83ff;">if</span> (not (string-match-p <span style="color: #61CE3C;">"^\\cc+\\'"</span> string))
          (<span style="color: #ff69b4;">error</span> <span style="color: #61CE3C;">"&#19981;&#26159;&#32431;&#20013;&#25991;&#23383;&#31526;&#20018;"</span>)
        (<span style="color: #4c83ff;">setq</span> code (gethash string pyim-dcache-word2code))
        (<span style="color: #4c83ff;">if</span> code
            (message <span style="color: #61CE3C;">"%S -&gt; %S "</span> string code)
          (message <span style="color: #61CE3C;">"&#27809;&#26377;&#25214;&#21040; %S &#23545;&#24212;&#30340;&#32534;&#30721;&#12290;"</span> string))))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-delete-word</span> ()
  <span style="color: #FBDE2D;">"&#23558;&#39640;&#20142;&#36873;&#25321;&#30340;&#35789;&#26465;&#20174; `</span><span style="color: #96CBFE;">pyim-dcache-icode2word</span><span style="color: #FBDE2D;">' &#20013;&#21024;&#38500;&#12290;"</span>
  (<span style="color: #4c83ff;">interactive</span>)
  (<span style="color: #4c83ff;">if</span> mark-active
      (<span style="color: #4c83ff;">let</span> ((string (buffer-substring-no-properties
                     (region-beginning) (region-end))))
        (<span style="color: #4c83ff;">when</span> (<span style="color: #4c83ff;">and</span> (&lt; (length string) 6)
                   (&gt; (length string) 0))
          (pyim-delete-word-1 string)
          (message <span style="color: #61CE3C;">"&#23558;&#35789;&#26465;: %S &#20174; personal &#32531;&#20914;&#20013;&#21024;&#38500;&#12290;"</span> string)))
    (message <span style="color: #61CE3C;">"&#35831;&#39318;&#20808;&#39640;&#20142;&#36873;&#25321;&#38656;&#35201;&#21024;&#38500;&#30340;&#35789;&#26465;&#12290;"</span>)))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-delete-word-1</span> (word)
  <span style="color: #FBDE2D;">"&#23558;&#20013;&#25991;&#35789;&#26465; `</span><span style="color: #96CBFE;">word</span><span style="color: #FBDE2D;">' &#20174; `</span><span style="color: #96CBFE;">pyim-dcache-icode2word</span><span style="color: #FBDE2D;">' &#20013;&#21024;&#38500;"</span>
  (<span style="color: #4c83ff;">let*</span> ((pinyins (pyim-hanzi2pinyin word nil <span style="color: #61CE3C;">"-"</span> t))
         (pinyins-szm (mapcar
                       #'(lambda (pinyin)
                           (mapconcat #'(lambda (x)
                                          (substring x 0 1))
                                      (split-string pinyin <span style="color: #61CE3C;">"-"</span>) <span style="color: #61CE3C;">"-"</span>))
                       pinyins)))
    (<span style="color: #4c83ff;">dolist</span> (pinyin pinyins)
      (<span style="color: #4c83ff;">unless</span> (pyim-string-match-p <span style="color: #61CE3C;">"[</span><span style="color: #61CE3C;">^</span><span style="color: #61CE3C;"> a-z-]"</span> pinyin)
        (<span style="color: #4c83ff;">pyim-dcache-put</span>
          pyim-dcache-icode2word pinyin
          (remove word orig-value))))
    (<span style="color: #4c83ff;">dolist</span> (pinyin pinyins-szm)
      (<span style="color: #4c83ff;">unless</span> (pyim-string-match-p <span style="color: #61CE3C;">"[</span><span style="color: #61CE3C;">^</span><span style="color: #61CE3C;"> a-z-]"</span> pinyin)
        (<span style="color: #4c83ff;">pyim-dcache-put</span>
          pyim-dcache-icode2word pinyin
          (remove word orig-value))))))
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-orge4a1450" class="outline-3">
<h3 id="orge4a1450"><span class="section-number-3">2.5</span>生成 `pyim-entered-code' 并插入 `pyim-dagger-str'</h3>
<div class="outline-text-3" id="text-2-5">
</div><div id="outline-container-org6360123" class="outline-4">
<h4 id="org6360123"><span class="section-number-4">2.5.1</span>生成拼音字符串 `pyim-entered-code'</h4>
<div class="outline-text-4" id="text-2-5-1">
<p>
Chinese-pyim 使用函数 `pyim-start' 启动输入法的时候，会将变量
`input-method-function' 设置为 `pyim-input-method' ，这个变量会影响 `read-event' 的行为。
</p>

<p>
当输入字符时，`read-event' 会被调用，`read-event' 调用的过程中，会执行 `pyim-input-method' 这个函数。`pyim-input-method' 又调用函数
`pyim-start-translation'
</p>

<p>
`pyim-start-translation' 这个函数较复杂，作许多低层工作，但它的一个重要流程是：
</p>
<ol class="org-ol">
<li>使用函数 `read-key-sequence' 得到 key-sequence</li>
<li>使用函数 `lookup-key' 查询 pyim-mode-map 中，上述 key-sequence 对应的命令。</li>
<li>如果查询得到的命令是 'pyim-self-insert-command' 时，
`pyim-start-translation' 会调用这个函数。</li>
</ol>

<p>
`pyim-self-insert-command' 这个函数的核心工作就是将用户输入的字符，组合成 code 字符串并保存到变量 `pyim-entered-code' 中。
</p>

<p>
中英文输入模式切换功能也是在 'pyim-self-insert-command' 中实现。
</p>

<p>
这个部份的代码涉及许多 emacs 低层函数，相对复杂，不容易理解，有兴趣的朋友可以参考：
</p>
<ol class="org-ol">
<li>`quail-input-method' 相关函数。</li>
<li>elisp 手册相关章节:
<ol class="org-ol">
<li>Invoking the Input Method</li>
<li>Input Methods</li>
<li>Miscellaneous Event Input Features</li>
<li>Reading One Event</li>
</ol></li>
</ol>
</div>
</div>

<div id="outline-container-orgb259e5b" class="outline-4">
<h4 id="orgb259e5b"><span class="section-number-4">2.5.2</span>在待输入 buffer 中插入 `pyim-dagger-str'</h4>
<div class="outline-text-4" id="text-2-5-2">
<p>
`pyim-self-insert-command' 会调用 `pyim-handle-entered-code' 来处理
`pyim-entered-code'，并相应的得到对应的 `pyim-dagger-str'，然后，
`pyim-start-translation' 返回 `pyim-dagger-str' 的取值。
</p>

<p>
在 `pyim-input-method' 函数内部，`pyim-start-translation' 返回值分解为
event list。
</p>

<p>
最后，emacs 低层函数 read-event 将这个 list 插入<b>待输入buffer</b>。
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-input-method</span> (key-or-string)
  (<span style="color: #4c83ff;">if</span> (<span style="color: #4c83ff;">or</span> buffer-read-only
          overriding-terminal-local-map
          overriding-local-map)
      (<span style="color: #4c83ff;">if</span> (characterp key-or-string)
          (list key-or-string)
        (mapcar 'identity key-or-string))
    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">(message "call with key: %S" key-or-string)</span>
    (pyim-dagger-setup-overlay)
    (<span style="color: #4c83ff;">with-silent-modifications</span>
      (<span style="color: #4c83ff;">unwind-protect</span>
          (<span style="color: #4c83ff;">let</span> ((input-string (pyim-start-translation key-or-string)))
            <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">(message "input-string: %s" input-string)</span>
            (<span style="color: #4c83ff;">when</span> (<span style="color: #4c83ff;">and</span> (stringp input-string)
                       (&gt; (length input-string) 0))
              (<span style="color: #4c83ff;">if</span> input-method-exit-on-first-char
                  (list (aref input-string 0))
                (mapcar 'identity input-string))))
        (pyim-dagger-delete-overlay)))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-start-translation</span> (key-or-string)
  <span style="color: #FBDE2D;">"Start translation of the typed character KEY by Chinese-pyim.</span>
<span style="color: #FBDE2D;">Return the input string."</span>
  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">Check the possibility of translating KEY.</span>
  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">If KEY is nil, we can anyway start translation.</span>
  (<span style="color: #4c83ff;">if</span> (<span style="color: #4c83ff;">or</span> (integerp key-or-string)
          (stringp key-or-string)
          (null key-or-string))
      <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">OK, we can start translation.</span>
      (<span style="color: #4c83ff;">let*</span> ((echo-keystrokes 0)
             (help-char nil)
             (overriding-terminal-local-map pyim-mode-map)
             (generated-events nil)
             (input-method-function nil)
             <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">Quail package &#29992;&#36825;&#20010;&#21464;&#37327;&#26469;&#25511;&#21046;&#26159;&#21542;&#22312; buffer &#20013;</span>
             <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#25554;&#20837; dagger string, pyim *&#24378;&#21046;* &#23558;&#20854;&#35774;&#32622;&#20026; nil</span>
             (input-method-use-echo-area nil)
             (modified-p (buffer-modified-p))
             key str last-command-event last-command this-command)

        (<span style="color: #4c83ff;">if</span> (integerp key-or-string)
            (<span style="color: #4c83ff;">setq</span> key key-or-string)
          (<span style="color: #4c83ff;">setq</span> key (string-to-char (substring key-or-string -1)))
          (<span style="color: #4c83ff;">setq</span> str (substring key-or-string 0 -1)))

        (<span style="color: #4c83ff;">setq</span> pyim-dagger-str <span style="color: #61CE3C;">""</span>
              pyim-entered-code (<span style="color: #4c83ff;">or</span> str <span style="color: #61CE3C;">""</span>)
              pyim-translating t)

        (<span style="color: #4c83ff;">when</span> key
          (<span style="color: #4c83ff;">setq</span> unread-command-events
                (cons key unread-command-events)))

        (<span style="color: #4c83ff;">while</span> pyim-translating
          (set-buffer-modified-p modified-p)
          (<span style="color: #4c83ff;">let*</span> ((keyseq (read-key-sequence nil nil nil t))
                 (cmd (lookup-key pyim-mode-map keyseq)))
            <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">(message "key: %s, cmd:%s\nlcmd: %s, lcmdv: %s, tcmd: %s"</span>
            <span style="color: #8B8989; font-style: italic;">;;          </span><span style="color: #8B8989; font-style: italic;">key cmd last-command last-command-event this-command)</span>
            (<span style="color: #4c83ff;">if</span> (<span style="color: #4c83ff;">if</span> key
                    (commandp cmd)
                  (eq cmd 'pyim-self-insert-command))
                (<span style="color: #4c83ff;">progn</span>
                  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">(message "keyseq: %s" keyseq)</span>
                  (<span style="color: #4c83ff;">setq</span> last-command-event (aref keyseq (1- (length keyseq)))
                        last-command this-command
                        this-command cmd)
                  (<span style="color: #4c83ff;">setq</span> key t)
                  (<span style="color: #4c83ff;">condition-case-unless-debug</span> err
                      (call-interactively cmd)
                    (<span style="color: #ff69b4;">error</span> (message <span style="color: #61CE3C;">"Chinese-pyim &#20986;&#29616;&#38169;&#35823;: %s , &#24320;&#21551; debug-on-error &#21518;&#21487;&#20197;&#20102;&#35299;&#35814;&#32454;&#24773;&#20917;&#12290;"</span>
                                    (cdr err)) <span style="color: #ff69b4;">(beep))))</span>
              <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">KEYSEQ is not defined in the translation keymap.</span>
              <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">Let's return the event(s) to the caller.</span>
              (<span style="color: #4c83ff;">setq</span> unread-command-events
                    (string-to-list (this-single-command-raw-keys)))
              <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">(message "unread-command-events: %s" unread-command-events)</span>
              (pyim-terminate-translation))))
        <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">(message "return: %s" pyim-dagger-str)</span>
        pyim-dagger-str)
    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">Since KEY doesn't start any translation, just return it.</span>
    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">But translate KEY if necessary.</span>
    (char-to-string key-or-string)))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-auto-switch-english-input-p</span> ()
  <span style="color: #FBDE2D;">"&#21028;&#26029;&#26159;&#21542; *&#26681;&#25454;&#29615;&#22659;&#33258;&#21160;&#20999;&#25442;* &#20026;&#33521;&#25991;&#36755;&#20837;&#27169;&#24335;&#65292;&#36825;&#20010;&#20989;&#25968;&#22788;&#29702;&#21464;&#37327;&#65306;</span>
<span style="color: #FBDE2D;">`</span><span style="color: #96CBFE;">pyim-english-input-switch-functions</span><span style="color: #FBDE2D;">'"</span>
  (<span style="color: #4c83ff;">let*</span> ((func-or-list pyim-english-input-switch-functions))
    (<span style="color: #4c83ff;">and</span> (cl-some #'(lambda (x)
                      (<span style="color: #4c83ff;">if</span> (functionp x)
                          (funcall x)
                        nil))
                  (<span style="color: #4c83ff;">cond</span> ((functionp func-or-list) (list func-or-list))
                        ((listp func-or-list) func-or-list)
                        (t nil)))
         (<span style="color: #4c83ff;">setq</span> current-input-method-title
               (concat pyim-title
                       (<span style="color: #4c83ff;">if</span> pyim-input-ascii
                           <span style="color: #61CE3C;">"-&#33521;&#25991;"</span>
                         <span style="color: #61CE3C;">"-AU&#33521;"</span>))))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-input-chinese-p</span> ()
  <span style="color: #FBDE2D;">"&#30830;&#23450; Chinese-pyim &#26159;&#21542;&#21551;&#21160;&#20013;&#25991;&#36755;&#20837;&#27169;&#24335;"</span>
  (<span style="color: #4c83ff;">let*</span> ((scheme-name pyim-default-scheme)
         (first-chars (pyim-scheme-get-option scheme-name <span style="color: #4c83ff;">:first-chars</span>))
         (rest-chars (pyim-scheme-get-option scheme-name <span style="color: #4c83ff;">:rest-chars</span>)))
    (<span style="color: #4c83ff;">and</span> (<span style="color: #4c83ff;">or</span> pyim-force-input-chinese
             (<span style="color: #4c83ff;">and</span> (not pyim-input-ascii)
                  (not (pyim-auto-switch-english-input-p))))
         (<span style="color: #4c83ff;">if</span> (pyim-string-emptyp pyim-entered-code)
             (member last-command-event
                     (mapcar 'identity first-chars))
           (member last-command-event
                   (mapcar 'identity rest-chars)))
         (<span style="color: #4c83ff;">setq</span> current-input-method-title pyim-title))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-string-emptyp</span> (str)
  (not (string&lt; <span style="color: #61CE3C;">""</span> str)))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-self-insert-command</span> ()
  <span style="color: #FBDE2D;">"&#22914;&#26524;&#22312; pyim-first-char &#21015;&#34920;&#20013;&#65292;&#21017;&#26597;&#25214;&#30456;&#24212;&#30340;&#35789;&#26465;&#65292;&#21542;&#21017;&#20572;&#27490;&#36716;&#25442;&#65292;&#25554;&#20837;&#23545;&#24212;&#30340;&#23383;&#31526;"</span>
  (<span style="color: #4c83ff;">interactive</span> <span style="color: #61CE3C;">"*"</span>)
  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">(message "%s" (current-buffer))</span>
  (<span style="color: #4c83ff;">if</span> (pyim-input-chinese-p)
      (<span style="color: #4c83ff;">progn</span> (<span style="color: #4c83ff;">setq</span> pyim-entered-code
                   (concat pyim-entered-code (char-to-string last-command-event)))
             (pyim-handle-entered-code))
    (pyim-dagger-append (pyim-translate last-command-event))
    (pyim-terminate-translation)))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-terminate-translation</span> ()
  <span style="color: #FBDE2D;">"Terminate the translation of the current key."</span>
  (<span style="color: #4c83ff;">setq</span> pyim-translating nil)
  (pyim-dagger-delete-string)
  (<span style="color: #4c83ff;">setq</span> pyim-current-choices nil)
  (<span style="color: #4c83ff;">when</span> (<span style="color: #4c83ff;">and</span> (eq pyim-page-tooltip 'pos-tip)
             (pyim-tooltip-pos-tip-usable-p))
    (pos-tip-hide)))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgab536db" class="outline-3">
<h3 id="orgab536db"><span class="section-number-3">2.6</span>处理拼音 code 字符串 `pyim-entered-code'</h3>
<div class="outline-text-3" id="text-2-6">
</div><div id="outline-container-org6f4d9dc" class="outline-4">
<h4 id="org6f4d9dc"><span class="section-number-4">2.6.1</span>拼音字符串 -&gt; 待选词列表</h4>
<div class="outline-text-4" id="text-2-6-1">
<p>
从一个拼音字符串获取其待选词列表，大致可以分成3个步骤：
</p>
<ol class="org-ol">
<li><p>
分解这个拼音字符串，得到一个拼音列表。
</p>
<pre class="example">
woaimeinv -&gt; (("w" . "o") ("" . "ai") ("m" . "ei") ("n" . "v"))
</pre></li>
<li><p>
将拼音列表排列组合，得到多个词语的拼音，并用列表表示。
</p>
<pre class="example">
(("p" . "in") ("y" . "in") ("sh" . "") ("r" . ""))
=&gt; ("pin-yin"  ;; 完整的拼音
    ("p-y-sh" ("p" . "in") ("y" . "in") ("sh" . "")) ;; 不完整的拼音
    ("p-y-sh-r" ("p" . "in") ("y" . "in") ("sh" . "") ("r" . "")) ;; 不完整的拼音
    )
</pre></li>
<li>递归的查询上述多个词语拼音，将得到的结果合并为待选词列表。</li>
</ol>
</div>
<div id="outline-container-org39410fd" class="outline-5">
<h5 id="org39410fd"><span class="section-number-5">2.6.1.1</span>分解拼音字符串</h5>
<div class="outline-text-5" id="text-2-6-1-1">
<p>
拼音字符串操作主要做两方面的工作：
</p>
<ol class="org-ol">
<li>将拼音字符串分解为拼音列表。</li>
<li>将拼音列表合并成拼音字符串。</li>
</ol>

<p>
在这之前，Chinese-pyim 定义了三个变量：
</p>
<ol class="org-ol">
<li>声母表： `pyim-pinyin-shen-mu'</li>
<li>韵母表：`pyim-pinyin-yun-mu'</li>
<li>有效韵母表： `pyim-pinyin-valid-yun-mu'</li>
</ol>

<p>
Chinese-pyim 使用函数 `pyim-code-split' 将拼音字符串分解为一个由声母和韵母组成的拼音列表，比如：
</p>

<pre class="example">
(pyim-code-split "woaimeinv" 'quanpin)
</pre>

<p>
结果为:
</p>
<pre class="example">
((("w" . "o") ("" . "ai") ("m" . "ei") ("n" . "v")))
</pre>

<p>
这个过程通过递归的调用 `pyim-pinyin-get-charpy' 来实现，整个过程类似用菜刀切黄瓜片，将一个拼音字符串逐渐切开。比如：
</p>

<pre class="example">
(pyim-pinyin-get-charpy "woaimeinv")
</pre>

<p>
结果为:
</p>
<pre class="example">
(("w" . "o") . "aimeinv")
</pre>

<p>
一个完整的递归过程类似：
</p>
<pre class="example">
"woaimeinv"
(("w" . "o") . "aimeinv")
(("w" . "o") ("" . "ai") . "meinv")
(("w" . "o") ("" . "ai") ("m" . "ei" ) . "nv")
(("w" . "o") ("" . "ai") ("m" . "ei" ) ("n" . "v"))
</pre>

<p>
`pyim-pinyin-get-charpy' 由两个基本函数配合实现：
</p>
<ol class="org-ol">
<li>pyim-pinyin-get-sm 从一个拼音字符串中提出第一个声母</li>
<li>pyim-pinyin-get-ym 从一个拼音字符串中提出第一个韵母</li>
</ol>

<pre class="example">
(pyim-pinyin-get-sm "woaimeinv")
</pre>

<p>
结果为:
</p>
<pre class="example">
("w" . "oaimeinv")
</pre>

<pre class="example">
(pyim-pinyin-get-ym "oaimeinv")
</pre>

<p>
结果为:
</p>
<pre class="example">
("o" . "aimeinv")
</pre>

<p>
当用户输入一个错误的拼音时，`pyim-code-split' 会产生一个声母为空而韵母又不正确的拼音列表 ，比如：
</p>

<pre class="example">
(pyim-code-split "ua" 'quanpin)
</pre>

<p>
结果为:
</p>
<pre class="example">
((("" . "ua")))
</pre>

<p>
这种错误可以使用函数 `pyim-scode-validp' 来检测。
</p>
<pre class="example">
(list (pyim-scode-validp (car (pyim-code-split "ua" 'quanpin)) 'quanpin)
      (pyim-scode-validp (car (pyim-code-split "a" 'quanpin)) 'quanpin)
      (pyim-scode-validp (car (pyim-code-split "wa" 'quanpin)) 'quanpin)
      (pyim-scode-validp (car (pyim-code-split "wua" 'quanpin)) 'quanpin))
</pre>

<p>
结果为:
</p>
<pre class="example">
(nil t t t)
</pre>

<p>
Chinese-pyim 使用函数 `pyim-scode-join' 将一个 scode (splited code) 合并为一个 code 字符串，这个可以认为是 `pyim-code-split' 的反向操作。构建得到的
code 字符串用于搜索词条。
</p>

<pre class="example">
(pyim-scode-join '(("w" . "o") ("" . "ai") ("m" . "ei") ("n" . "v")) 'quanpin)
</pre>

<p>
结果为:
</p>
<pre class="example">
"wo-ai-mei-nv"
</pre>

<p>
最后： `pyim-code-user-divide-pos' 和 `pyim-code-restore-user-divide' 用来处理隔音符，比如： xi'an
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#23558;&#27721;&#23383;&#30340;&#25340;&#38899;&#20998;&#25104;&#22768;&#27597;&#21644;&#20854;&#23427;</span>
(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-pinyin-get-sm</span> (py)
  <span style="color: #FBDE2D;">"&#20174;&#19968;&#20010;&#25340;&#38899;&#23383;&#31526;&#20018;&#20013;&#25552;&#20986;&#31532;&#19968;&#20010;&#22768;&#27597;&#12290;"</span>
  (<span style="color: #4c83ff;">when</span> (<span style="color: #4c83ff;">and</span> py (string&lt; <span style="color: #61CE3C;">""</span> py))
    (<span style="color: #4c83ff;">let</span> (shenmu yunmu len)
      (<span style="color: #4c83ff;">if</span> (&lt; (length py) 2)
          (<span style="color: #4c83ff;">if</span> (member py pyim-pinyin-shen-mu)
              (cons py <span style="color: #61CE3C;">""</span>)
            (cons <span style="color: #61CE3C;">""</span> py))
        (<span style="color: #4c83ff;">setq</span> shenmu (substring py 0 2))
        (<span style="color: #4c83ff;">if</span> (member shenmu pyim-pinyin-shen-mu)
            (<span style="color: #4c83ff;">setq</span> py (substring py 2))
          (<span style="color: #4c83ff;">setq</span> shenmu (substring py 0 1))
          (<span style="color: #4c83ff;">if</span> (member shenmu pyim-pinyin-shen-mu)
              (<span style="color: #4c83ff;">setq</span> py (substring py 1))
            (<span style="color: #4c83ff;">setq</span> shenmu <span style="color: #61CE3C;">""</span>)))
        (cons shenmu py)))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-pinyin-get-ym</span> (py)
  <span style="color: #FBDE2D;">"&#20174;&#19968;&#20010;&#25340;&#38899;&#23383;&#31526;&#20018;&#20013;&#25552;&#20986;&#31532;&#19968;&#20010;&#38901;&#27597;"</span>
  (<span style="color: #4c83ff;">when</span> (<span style="color: #4c83ff;">and</span> py (string&lt; <span style="color: #61CE3C;">""</span> py))
    (<span style="color: #4c83ff;">let</span> (yunmu len)
      (<span style="color: #4c83ff;">setq</span> len (min (length py) 5))
      (<span style="color: #4c83ff;">setq</span> yunmu (substring py 0 len))
      (<span style="color: #4c83ff;">while</span> (<span style="color: #4c83ff;">and</span> (not (member yunmu pyim-pinyin-yun-mu))
                  (&gt; len 0))
        (<span style="color: #4c83ff;">setq</span> yunmu (substring py 0 (<span style="color: #4c83ff;">setq</span> len (1- len)))))
      (<span style="color: #4c83ff;">setq</span> py (substring py len))
      (<span style="color: #4c83ff;">if</span> (<span style="color: #4c83ff;">and</span> (string&lt; <span style="color: #61CE3C;">""</span> py)
               (not (member (substring py 0 1) pyim-pinyin-shen-mu))
               (member (substring yunmu -1) pyim-pinyin-shen-mu)
               (member (substring yunmu 0 -1) pyim-pinyin-yun-mu)
               (not (<span style="color: #4c83ff;">and</span> (member (substring yunmu -1) '(<span style="color: #61CE3C;">"n"</span> <span style="color: #61CE3C;">"g"</span>))
                         (<span style="color: #4c83ff;">or</span> (string= (substring py 0 1) <span style="color: #61CE3C;">"o"</span>)
                             (string= (substring py 0 (min (length py) 2)) <span style="color: #61CE3C;">"er"</span>)))))
          (<span style="color: #4c83ff;">setq</span> py (concat (substring yunmu -1) py)
                yunmu (substring yunmu 0 -1)))
      (cons yunmu py))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-pinyin-get-charpy</span> (py)
  <span style="color: #FBDE2D;">"&#20998;&#35299;&#19968;&#20010;&#25340;&#38899;&#23383;&#31526;&#20018;&#25104;&#22768;&#27597;&#21644;&#38901;&#27597;&#12290;"</span>
  (<span style="color: #4c83ff;">when</span> (<span style="color: #4c83ff;">and</span> py (string&lt; <span style="color: #61CE3C;">""</span> py))
    (<span style="color: #4c83ff;">let*</span> ((sm (pyim-pinyin-get-sm py))
           (ym (pyim-pinyin-get-ym (cdr sm)))
           (charpys (mapcar #'(lambda (x)
                                (concat (car x) (cdr x)))
                            (pyim-spinyin-find-fuzzy-1
                             (cons (car sm) (car ym))))))
      (<span style="color: #4c83ff;">if</span> (<span style="color: #4c83ff;">or</span> (null ym) <span style="color: #8B8989; font-style: italic;">;</span><span style="color: #8B8989; font-style: italic;">&#22914;&#26524;&#38901;&#27597;&#20026;&#31354;</span>
              (<span style="color: #4c83ff;">and</span> (string&lt; <span style="color: #61CE3C;">""</span> (car ym))
                   (not (cl-some
                         #'(lambda (charpy)
                             (<span style="color: #4c83ff;">or</span> (pyim-pinyin2cchar-get charpy t)
                                 (pyim-dcache-get charpy)))
                         charpys))))

          (cons sm <span style="color: #61CE3C;">""</span>)
        (cons (cons (car sm) (car ym)) (cdr ym))))))

<span style="color: #8B8989; font-style: italic;">;;; </span><span style="color: #8B8989; font-style: italic;">&#22788;&#29702;&#36755;&#20837;&#30340;&#25340;&#38899;</span>
(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-scheme-get</span> (scheme-name)
  <span style="color: #FBDE2D;">"&#33719;&#21462;&#21517;&#31216;&#20026; `</span><span style="color: #96CBFE;">scheme-name</span><span style="color: #FBDE2D;">' &#30340;&#36755;&#20837;&#27861;&#26041;&#26696;&#12290;"</span>
  (assoc scheme-name pyim-schemes))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-scheme-get-option</span> (scheme-name option)
  <span style="color: #FBDE2D;">"&#33719;&#21462;&#21517;&#31216;&#20026; `</span><span style="color: #96CBFE;">scheme-name</span><span style="color: #FBDE2D;">' &#30340;&#36755;&#20837;&#27861;&#26041;&#26696;&#65292;&#24182;&#25552;&#21462;&#20854;&#23646;&#24615; `</span><span style="color: #96CBFE;">option</span><span style="color: #FBDE2D;">' &#12290;"</span>
  (<span style="color: #4c83ff;">let</span> ((scheme (pyim-scheme-get scheme-name)))
    (<span style="color: #4c83ff;">when</span> scheme
      (plist-get (cdr scheme) option))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-code-split</span> (code <span style="color: #afd8af;">&amp;optional</span> scheme-name)
  <span style="color: #FBDE2D;">"&#25353;&#29031; `</span><span style="color: #96CBFE;">scheme-name</span><span style="color: #FBDE2D;">' &#23545;&#24212;&#30340;&#36755;&#20837;&#27861;&#26041;&#26696;&#65292;&#25226;&#19968;&#20010; code &#23383;&#31526;&#20018;&#20998;&#35299;&#20026;&#19968;&#20010;&#30001; scode</span>
<span style="color: #FBDE2D;">&#32452;&#25104;&#30340;&#21015;&#34920;&#65292;&#31867;&#20284;&#65306;</span>

<span style="color: #FBDE2D;">1. pinyin:  (((\"n\" . \"i\") (\"h\" . \"ao\")))</span>

<span style="color: #FBDE2D;">&#27880;&#24847;&#65306; &#19981;&#21516;&#30340;&#36755;&#20837;&#27861;&#65292;scode &#30340;&#32467;&#26500;&#20063;&#26159;&#19981;&#19968;&#26679;&#30340;&#12290;"</span>
  (<span style="color: #4c83ff;">let</span> ((class (pyim-scheme-get-option scheme-name <span style="color: #4c83ff;">:class</span>)))
    (<span style="color: #4c83ff;">when</span> class
      (funcall (intern (concat <span style="color: #61CE3C;">"pyim-code-split:"</span>
                               (symbol-name class)))
               code scheme-name))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-code-split:quanpin</span> (py <span style="color: #afd8af;">&amp;optional</span> -)
  <span style="color: #FBDE2D;">"&#25226;&#19968;&#20010;&#25340;&#38899;&#23383;&#31526;&#20018; `</span><span style="color: #96CBFE;">py</span><span style="color: #FBDE2D;">' &#20998;&#35299;&#25104; spinyin-list (&#30001;&#22768;&#27597;&#21644;&#38901;&#27597;&#32452;&#25104;&#30340;&#22797;&#26434;&#21015;&#34920;&#65289;&#65292;</span>
<span style="color: #FBDE2D;">&#20248;&#20808;&#22788;&#29702;&#21547;&#26377; ' &#30340;&#20301;&#32622;&#12290;"</span>
  (<span style="color: #4c83ff;">when</span> (<span style="color: #4c83ff;">and</span> py (string&lt; <span style="color: #61CE3C;">""</span> py))
    (pyim-spinyin-find-fuzzy
     (list (apply 'append
                  (mapcar #'(lambda (p)
                              (<span style="color: #4c83ff;">let</span> (chpy spinyin)
                                (<span style="color: #4c83ff;">setq</span> p (replace-regexp-in-string <span style="color: #61CE3C;">"[ -]"</span> <span style="color: #61CE3C;">""</span> p))
                                (<span style="color: #4c83ff;">while</span> (<span style="color: #4c83ff;">when</span> (string&lt; <span style="color: #61CE3C;">""</span> p)
                                         (<span style="color: #4c83ff;">setq</span> chpy (pyim-pinyin-get-charpy p))
                                         (<span style="color: #4c83ff;">setq</span> spinyin (append spinyin (list (car chpy))))
                                         (<span style="color: #4c83ff;">setq</span> p (cdr chpy))))
                                spinyin))
                          (split-string py <span style="color: #61CE3C;">"'"</span>)))))))

<span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">"nihc" -&gt; (((\"n\" . \"i\") (\"h\" . \"ao\")))</span>
(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-code-split:shuangpin</span> (str <span style="color: #afd8af;">&amp;optional</span> scheme-name)
  <span style="color: #FBDE2D;">"&#25226;&#19968;&#20010;&#21452;&#25340;&#23383;&#31526;&#20018;&#20998;&#35299;&#25104;&#19968;&#20010;&#22768;&#27597;&#21644;&#38901;&#27597;&#32452;&#25104;&#30340;&#22797;&#26434;&#21015;&#34920;&#12290;"</span>
  (<span style="color: #4c83ff;">let</span> ((keymaps (pyim-scheme-get-option scheme-name <span style="color: #4c83ff;">:keymaps</span>))
        (list (string-to-list (replace-regexp-in-string <span style="color: #61CE3C;">"-"</span> <span style="color: #61CE3C;">""</span> str)))
        results)
    (<span style="color: #4c83ff;">while</span> list
      (<span style="color: #4c83ff;">let*</span> ((sp-sm (<span style="color: #4c83ff;">pop</span> list))
             (sp-ym (<span style="color: #4c83ff;">pop</span> list))
             (sp-sm (<span style="color: #4c83ff;">when</span> sp-sm (char-to-string sp-sm)))
             (sp-ym (<span style="color: #4c83ff;">when</span> sp-ym (char-to-string sp-ym)))
             (sm (nth 1 (assoc sp-sm keymaps)))
             (ym (cdr (cdr (assoc sp-ym keymaps)))))
        (<span style="color: #4c83ff;">push</span> (mapcar
               #'(lambda (x)
                   (<span style="color: #4c83ff;">let*</span> ((y (concat sp-sm (<span style="color: #4c83ff;">or</span> sp-ym <span style="color: #61CE3C;">" "</span>)))
                          (z (cadr (assoc y keymaps))))
                     (<span style="color: #4c83ff;">if</span> z (cons <span style="color: #61CE3C;">""</span> z) (cons sm x))))
               (<span style="color: #4c83ff;">or</span> ym (list <span style="color: #61CE3C;">""</span>)))
              results)))
    (pyim-spinyin-find-fuzzy
     (pyim-permutate-list (nreverse results)))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-code-split:simple</span> (code <span style="color: #afd8af;">&amp;optional</span> -)
  <span style="color: #FBDE2D;">"&#36825;&#20010;&#20989;&#25968;&#21482;&#26159;&#23545; code &#20570;&#20102;&#19968;&#28857;&#31616;&#21333;&#30340;&#21253;&#35013;&#65292;&#23454;&#38469;&#24182;&#19981;&#30495;&#27491;&#30340;</span>
<span style="color: #FBDE2D;">*&#20998;&#35299;* code, &#27604;&#22914;&#65306;</span>

<span style="color: #FBDE2D;">  \"aaaa\" -&gt; ((\"aaaa\"))</span>

<span style="color: #FBDE2D;">&#36825;&#20010;&#20989;&#25968;&#20027;&#35201;&#29992;&#20110;&#20116;&#31508;&#31561; code &#35268;&#21017;&#30456;&#23545;&#31616;&#21333;&#22266;&#23450;&#30340;&#36755;&#20837;&#27861;&#12290;"</span>
  (list (list code)))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-spinyin-find-fuzzy</span> (spinyin-list)
  <span style="color: #FBDE2D;">"&#29992;&#20110;&#22788;&#29702;&#27169;&#31946;&#38899;&#30340;&#20989;&#25968;&#12290;"</span>
  (<span style="color: #4c83ff;">let</span> (fuzzy-spinyin-list result1 result2)
    (<span style="color: #4c83ff;">dolist</span> (spinyin spinyin-list)
      (<span style="color: #4c83ff;">setq</span> fuzzy-spinyin-list
            (pyim-permutate-list
             (mapcar 'pyim-spinyin-find-fuzzy-1 spinyin)))
      (<span style="color: #4c83ff;">push</span> (car fuzzy-spinyin-list) result1)
      (<span style="color: #4c83ff;">setq</span> result2 (append result2 (cdr fuzzy-spinyin-list))))
    (append result1 result2)))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-spinyin-find-fuzzy-1</span> (pycons)
  <span style="color: #FBDE2D;">"Find all fuzzy pinyins, for example:</span>

<span style="color: #FBDE2D;">(\"f\" . \"en\") -&gt; ((\"f\" . \"en\") (\"f\" . \"eng\"))"</span>
  (<span style="color: #4c83ff;">cl-labels</span> ((find-list (str list)
                         (<span style="color: #4c83ff;">let</span> (result)
                           (<span style="color: #4c83ff;">dolist</span> (x list)
                             (<span style="color: #4c83ff;">when</span> (member str x)
                               (<span style="color: #4c83ff;">setq</span> list nil)
                               (<span style="color: #4c83ff;">setq</span> result
                                     (delete-dups
                                      `(,str ,@(cl-copy-list x))))))
                           (<span style="color: #4c83ff;">or</span> result (list str)))))
    (<span style="color: #4c83ff;">let*</span> ((fuzzy-alist pyim-fuzzy-pinyin-alist)
           (sm-list (find-list (car pycons) fuzzy-alist))
           (ym-list (find-list (cdr pycons) fuzzy-alist))
           result)
      (<span style="color: #4c83ff;">dolist</span> (a sm-list)
        (<span style="color: #4c83ff;">dolist</span> (b ym-list)
          (<span style="color: #4c83ff;">push</span> (cons a b) result)))
      (reverse result))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-scode-validp</span> (scode scheme-name)
  <span style="color: #FBDE2D;">"&#26816;&#27979;&#19968;&#20010; scode &#26159;&#21542;&#27491;&#30830;&#12290;"</span>
  (<span style="color: #4c83ff;">let</span> ((class (pyim-scheme-get-option scheme-name <span style="color: #4c83ff;">:class</span>)))
    (<span style="color: #4c83ff;">cond</span>
     ((member class '(quanpin shuangpin))
      (pyim-scode-validp:spinyin scode))
     (t t))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-scode-validp:spinyin</span> (spinyin)
  <span style="color: #FBDE2D;">"&#26816;&#26597; `</span><span style="color: #96CBFE;">spinyin</span><span style="color: #FBDE2D;">' &#26159;&#21542;&#22768;&#27597;&#20026;&#31354;&#19988;&#38901;&#27597;&#21448;&#19981;&#27491;&#30830;&#12290;"</span>
  (<span style="color: #4c83ff;">let</span> ((valid t) py)
    (<span style="color: #4c83ff;">while</span> (<span style="color: #4c83ff;">progn</span>
             (<span style="color: #4c83ff;">setq</span> py (car spinyin))
             (<span style="color: #4c83ff;">if</span> (<span style="color: #4c83ff;">and</span> (not (string&lt; <span style="color: #61CE3C;">""</span> (car py)))
                      (not (member (cdr py) pyim-pinyin-valid-yun-mu)))
                 (<span style="color: #4c83ff;">setq</span> valid nil)
               (<span style="color: #4c83ff;">setq</span> spinyin (cdr spinyin)))))
    valid))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-code-user-divide-pos</span> (code)
  <span style="color: #FBDE2D;">"&#26816;&#27979; `</span><span style="color: #96CBFE;">code</span><span style="color: #FBDE2D;">' &#20013;&#29992;&#25143;&#20998;&#21106;&#30340;&#20301;&#32622;&#65292;&#20063;&#23601;&#26159;'&#30340;&#20301;&#32622;&#65292;&#20027;&#35201;&#29992;&#20110;&#25340;&#38899;&#36755;&#20837;&#27861;&#12290;"</span>
  (<span style="color: #4c83ff;">setq</span> code (replace-regexp-in-string <span style="color: #61CE3C;">"-"</span> <span style="color: #61CE3C;">""</span> code))
  (<span style="color: #4c83ff;">let</span> (poslist (start 0))
    (<span style="color: #4c83ff;">while</span> (string-match <span style="color: #61CE3C;">"'"</span> code start)
      (<span style="color: #4c83ff;">setq</span> start (match-end 0))
      (<span style="color: #4c83ff;">setq</span> poslist (append poslist (list (match-beginning 0)))))
    poslist))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-code-restore-user-divide</span> (code pos)
  <span style="color: #FBDE2D;">"&#25353;&#26816;&#27979;&#20986;&#30340;&#29992;&#25143;&#20998;&#35299;&#30340;&#20301;&#32622;&#65292;&#37325;&#26032;&#35774;&#32622; code&#65292;&#20027;&#35201;&#29992;&#20110;&#25340;&#38899;&#36755;&#20837;&#27861;&#12290;"</span>
  (<span style="color: #4c83ff;">let</span> ((i 0) (shift 0) cur)
    (<span style="color: #4c83ff;">setq</span> cur (car pos)
          pos (cdr pos))
    (<span style="color: #4c83ff;">while</span> (<span style="color: #4c83ff;">and</span> cur (&lt; i (length code)))
      (<span style="color: #4c83ff;">if</span> (= (aref code i) ?-)
          (<span style="color: #4c83ff;">if</span> (= i (+ cur shift))
              (<span style="color: #4c83ff;">progn</span>
                (aset code i ?')
                (<span style="color: #4c83ff;">setq</span> cur (car pos)
                      pos (cdr pos)))
            (<span style="color: #4c83ff;">setq</span> shift (1+ shift))))
      (<span style="color: #4c83ff;">setq</span> i (1+ i)))
    (<span style="color: #4c83ff;">if</span> cur (<span style="color: #4c83ff;">setq</span> code (concat code <span style="color: #61CE3C;">"'"</span>)))  <span style="color: #8B8989; font-style: italic;">; </span><span style="color: #8B8989; font-style: italic;">the last char is `''</span>
    code))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-scode-join</span> (scode scheme-name <span style="color: #afd8af;">&amp;optional</span> as-search-key shou-zi-mu)
  <span style="color: #FBDE2D;">"&#25353;&#29031; `</span><span style="color: #96CBFE;">scheme</span><span style="color: #FBDE2D;">' &#23545;&#24212;&#30340;&#36755;&#20837;&#27861;&#26041;&#26696;&#65292;&#23558;&#19968;&#20010; scode (splited code)</span>
<span style="color: #FBDE2D;">&#37325;&#26032;&#21512;&#24182;&#20026; code &#23383;&#31526;&#20018;&#65292;&#29992;&#20110;&#25628;&#32034;&#12290;"</span>
  (<span style="color: #4c83ff;">let</span> ((class (pyim-scheme-get-option scheme-name <span style="color: #4c83ff;">:class</span>)))
    (<span style="color: #4c83ff;">when</span> class
      (funcall (intern (concat <span style="color: #61CE3C;">"pyim-scode-join:"</span>
                               (symbol-name class)))
               scode scheme-name as-search-key shou-zi-mu))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-scode-join:quanpin</span> (spinyin scheme-name <span style="color: #afd8af;">&amp;optional</span> as-search-key shou-zi-mu)
  <span style="color: #FBDE2D;">"&#25226;&#19968;&#20010; `</span><span style="color: #96CBFE;">spinyin</span><span style="color: #FBDE2D;">' (splited pinyin) &#21512;&#24182;&#20026;&#19968;&#20010;&#20840;&#25340;&#23383;&#31526;&#20018;&#65292;&#24403; `</span><span style="color: #96CBFE;">shou-zi-mu</span><span style="color: #FBDE2D;">'</span>
<span style="color: #FBDE2D;">&#35774;&#32622;&#20026; t &#26102;&#65292;&#29983;&#25104;&#25340;&#38899;&#39318;&#23383;&#27597;&#23383;&#31526;&#20018;&#65292;&#27604;&#22914; p-y&#12290;"</span>
  (mapconcat 'identity
             (mapcar
              #'(lambda (w)
                  (<span style="color: #4c83ff;">let</span> ((py (concat (car w) (cdr w))))
                    (<span style="color: #4c83ff;">if</span> shou-zi-mu
                        (substring py 0 1)
                      py)))
              spinyin)
             <span style="color: #61CE3C;">"-"</span>))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-scode-join:shuangpin</span> (spinyin scheme-name <span style="color: #afd8af;">&amp;optional</span> as-search-key shou-zi-mu)
  <span style="color: #FBDE2D;">"&#25226;&#19968;&#20010; `</span><span style="color: #96CBFE;">spinyin</span><span style="color: #FBDE2D;">' (splited pinyin) &#21512;&#24182;&#20026;&#19968;&#20010;&#21452;&#25340;&#23383;&#31526;&#20018;&#65292;&#24403; `</span><span style="color: #96CBFE;">shou-zi-mu</span><span style="color: #FBDE2D;">'</span>
<span style="color: #FBDE2D;">&#35774;&#32622;&#20026; t &#26102;&#65292;&#29983;&#25104;&#21452;&#25340;&#39318;&#23383;&#27597;&#23383;&#31526;&#20018;&#65292;&#27604;&#22914; p-y&#12290;"</span>
  (<span style="color: #4c83ff;">if</span> as-search-key
      <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#21452;&#25340;&#20351;&#29992;&#20840;&#25340;&#36755;&#20837;&#27861;&#30340;&#35789;&#24211;&#65292;&#25152;&#20197;&#25628;&#32034; dcache &#29992;&#30340; key &#35201;&#20351;&#29992;&#20840;&#25340;</span>
      (pyim-scode-join:quanpin spinyin scheme-name as-search-key shou-zi-mu)
    (<span style="color: #4c83ff;">when</span> scheme-name
      (<span style="color: #4c83ff;">let</span> ((keymaps (pyim-scheme-get-option scheme-name <span style="color: #4c83ff;">:keymaps</span>)))
        (mapconcat 'identity
                   (mapcar
                    #'(lambda (w)
                        (<span style="color: #4c83ff;">let</span> ((sm (car w))
                              (ym (cdr w)))
                          (<span style="color: #4c83ff;">if</span> (equal sm <span style="color: #61CE3C;">""</span>)
                              (car (rassoc (list ym) keymaps))
                            (concat (cl-some
                                     #'(lambda (x)
                                         (<span style="color: #4c83ff;">when</span> (equal sm (nth 1 x))
                                           (car x))) <span style="color: #ff69b4;">keymaps)</span>
                                    (<span style="color: #4c83ff;">unless</span> shou-zi-mu
                                      (cl-some
                                       #'(lambda (x)
                                           (<span style="color: #4c83ff;">when</span> (<span style="color: #4c83ff;">or</span> (equal ym (nth 2 x))
                                                     (equal ym (nth 3 x)))
                                             (car x))) <span style="color: #ff69b4;">keymaps))))))</span>
                    spinyin)
                   <span style="color: #61CE3C;">"-"</span>)))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-scode-join:simple</span> (scode scheme-name <span style="color: #afd8af;">&amp;optional</span> as-search-key shou-zi-mu)
  <span style="color: #FBDE2D;">"&#25226;&#19968;&#20010; `</span><span style="color: #96CBFE;">scode</span><span style="color: #FBDE2D;">' (splited code) &#21512;&#24182;&#20026;&#19968;&#20010; code &#23383;&#31526;&#20018;&#12290;</span>
<span style="color: #FBDE2D;">&#27604;&#22914;&#65306;</span>

<span style="color: #FBDE2D;">    (\"aaaa\") --&gt; \"aaaa\"   &#29992;&#20110;&#22312; dagger &#20013;&#26174;&#31034;&#12290;</span>
<span style="color: #FBDE2D;">               `-&gt; \".aaaa\"  &#29992;&#20110;&#25628;&#32034;&#35789;&#24211;&#12290;</span>

<span style="color: #FBDE2D;">&#36825;&#20010;&#20989;&#25968;&#20027;&#35201;&#29992;&#20110;&#20116;&#31508;&#31561; code &#35268;&#21017;&#27604;&#36739;&#31616;&#21333;&#30340;&#36755;&#20837;&#27861;&#12290;"</span>
  (<span style="color: #4c83ff;">when</span> scheme-name
    (<span style="color: #4c83ff;">let</span> ((code-prefix (pyim-scheme-get-option scheme-name <span style="color: #4c83ff;">:code-prefix</span>)))
      (<span style="color: #4c83ff;">if</span> as-search-key
          (concat (<span style="color: #4c83ff;">or</span> code-prefix <span style="color: #61CE3C;">""</span>) (car scode))
        (car scode)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org0e19db8" class="outline-5">
<h5 id="org0e19db8"><span class="section-number-5">2.6.1.2</span>获得词语拼音并进一步查询得到备选词列表</h5>
<div class="outline-text-5" id="text-2-6-1-2">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-choices-get</span> (scode-list scheme-name)
  <span style="color: #FBDE2D;">"&#26681;&#25454; `</span><span style="color: #96CBFE;">scode-list</span><span style="color: #FBDE2D;">', &#24471;&#21040;&#21487;&#33021;&#30340;&#35789;&#32452;&#21644;&#27721;&#23383;&#12290;"</span>
  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">scode-list &#21487;&#20197;&#21253;&#21547;&#22810;&#20010; scode, &#20174;&#32780;&#24471;&#21040;&#22810;&#20010;&#23376;&#20505;&#36873;&#35789;&#21015;&#34920;&#65292;&#22914;&#20309;&#23558;&#22810;&#20010; *&#23376;&#20505;&#36873;&#35789;&#21015;&#34920;* &#21512;&#29702;&#30340;&#21512;&#24182;&#65292;</span>
  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#26159;&#19968;&#20010;&#27604;&#36739;&#40635;&#28902;&#30340;&#20107;&#24773;&#30340;&#20107;&#24773;&#12290; &#27880;&#65306;&#36825;&#20010;&#22320;&#26041;&#38656;&#35201;&#36827;&#19968;&#27493;&#24471;&#25913;&#36827;&#12290;</span>
  (<span style="color: #4c83ff;">let*</span> (personal-words
         common-words
         pinyin-shortcode-words pinyin-znabc-words
         pinyin-chars)

    (<span style="color: #4c83ff;">dolist</span> (scode scode-list)
      (<span style="color: #4c83ff;">setq</span> personal-words
            (append personal-words
                    (car (pyim-choices-get:dcache-personal scode scheme-name))))
      (<span style="color: #4c83ff;">setq</span> common-words
            (append common-words
                    (car (pyim-choices-get:dcache-common scode scheme-name))))
      (<span style="color: #4c83ff;">setq</span> pinyin-chars
            (append pinyin-chars
                    (car (pyim-choices-get:pinyin-chars scode scheme-name)))))

    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">Pinyin shouzimu similar words</span>
    (<span style="color: #4c83ff;">let</span> ((words (pyim-choices-get:pinyin-shortcode (car scode-list) scheme-name)))
      (<span style="color: #4c83ff;">setq</span> pinyin-shortcode-words (car (cdr words))))

    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">Pinyin znabc-style similar words</span>
    (<span style="color: #4c83ff;">let</span> ((words (pyim-choices-get:pinyin-znabc (car scode-list) scheme-name)))
      (<span style="color: #4c83ff;">setq</span> pinyin-znabc-words (car (cdr words))))

    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">Debug</span>
    (<span style="color: #4c83ff;">when</span> pyim-debug
      (princ (list <span style="color: #4c83ff;">:scode-list</span> scode-list
                   <span style="color: #4c83ff;">:personal-words</span> personal-words
                   <span style="color: #4c83ff;">:common-words</span> common-words
                   <span style="color: #4c83ff;">:pinyin-shortcode-words</span> pinyin-shortcode-words
                   <span style="color: #4c83ff;">:pinyin-znabc-words</span> pinyin-znabc-words
                   <span style="color: #4c83ff;">:pinyin-chars</span> pinyin-chars)))

    (delete-dups
     (delq nil
           `(,@personal-words
             ,@common-words
             ,@pinyin-shortcode-words
             ,@pinyin-znabc-words
             ,@pinyin-chars)))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-choices-get:pinyin-znabc</span> (spinyin scheme-name)
  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#23558;&#36755;&#20837;&#30340;&#25340;&#38899;&#25353;&#29031;&#22768;&#27597;&#21644;&#38901;&#27597;&#25171;&#25955;&#65292;&#24471;&#21040;&#23613;&#21487;&#33021;&#22810;&#30340;&#25340;&#38899;&#32452;&#21512;&#65292;</span>
  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#26597;&#35810;&#36825;&#20123;&#25340;&#38899;&#32452;&#21512;&#65292;&#24471;&#21040;&#30340;&#35789;&#26465;&#20570;&#20026;&#32852;&#24819;&#35789;&#12290;</span>
  (<span style="color: #4c83ff;">when</span> (member 'pinyin-znabc pyim-backends)
    (<span style="color: #4c83ff;">let</span> ((class (pyim-scheme-get-option scheme-name <span style="color: #4c83ff;">:class</span>)))
      (<span style="color: #4c83ff;">when</span> (member class '(quanpin shuangpin))
        (list nil (pyim-possible-words
                   (pyim-possible-words-py spinyin)))))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-choices-get:pinyin-shortcode</span> (spinyin scheme-name)
  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#22914;&#26524;&#36755;&#20837; "ni-hao" &#65292;&#25628;&#32034; code &#20026; "n-h" &#30340;&#35789;&#26465;&#20570;&#20026;&#32852;&#24819;&#35789;&#12290;</span>
  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#25628;&#32034;&#39318;&#23383;&#27597;&#24471;&#21040;&#30340;&#32852;&#24819;&#35789;&#22826;&#22810;&#65292;&#36825;&#37324;&#38480;&#21046;&#32852;&#24819;&#35789;&#35201;&#22823;&#20110;&#20004;&#20010;&#27721;&#23383;&#24182;&#19988;&#21482;&#25628;&#32034;</span>
  <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#20010;&#20154;&#25991;&#20214;&#12290;</span>
  (<span style="color: #4c83ff;">when</span> (member 'pinyin-shortcode pyim-backends)
    (<span style="color: #4c83ff;">let</span> ((class (pyim-scheme-get-option scheme-name <span style="color: #4c83ff;">:class</span>)))
      (<span style="color: #4c83ff;">when</span> (<span style="color: #4c83ff;">and</span> (&gt; (length spinyin) 1)
                 (member class '(quanpin shuangpin)))
        (<span style="color: #4c83ff;">let</span> ((pyabbrev (pyim-scode-join spinyin scheme-name t t)))
          (list nil (pyim-dcache-get pyabbrev pyim-dcache-ishortcode2word)))))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-choices-get:pinyin-chars</span> (spinyin scheme-name)
  (<span style="color: #4c83ff;">when</span> (member 'pinyin-chars pyim-backends)
    (<span style="color: #4c83ff;">let</span> ((class (pyim-scheme-get-option scheme-name <span style="color: #4c83ff;">:class</span>)))
      (<span style="color: #4c83ff;">when</span> (member class '(quanpin shuangpin))
        (list (pyim-dcache-get (concat (caar spinyin) (cdar spinyin)))
              nil)))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-choices-get:dcache-personal</span> (scode scheme-name)
  (<span style="color: #4c83ff;">when</span> (member 'dcache-personal pyim-backends)
    (<span style="color: #4c83ff;">let</span> ((code (pyim-scode-join scode scheme-name t)))
      (list (pyim-dcache-get code (list pyim-dcache-icode2word
                                        pyim-dcache-ishortcode2word))
            nil))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-choices-get:dcache-common</span> (scode scheme-name)
  (<span style="color: #4c83ff;">when</span> (member 'dcache-common pyim-backends)
    (<span style="color: #4c83ff;">let</span> ((code (pyim-scode-join scode scheme-name t)))
      (list (pyim-dcache-get code (list pyim-dcache-code2word
                                        pyim-dcache-shortcode2word))
            nil))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-flatten-list</span> (my-list)
  (<span style="color: #4c83ff;">cond</span>
   ((null my-list) nil)
   ((atom my-list) (list my-list))
   (t (append (pyim-flatten-list (car my-list))
              (pyim-flatten-list (cdr my-list))))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-possible-words</span> (wordspy)
  <span style="color: #FBDE2D;">"&#26681;&#25454;&#25340;&#38899;&#24471;&#21040;&#21487;&#33021;&#30340;&#35789;&#32452;&#12290;&#20363;&#22914;&#65306;</span>
<span style="color: #FBDE2D;">  (pyim-possible-words '((\"p-y\" (\"p\" . \"in\") (\"y\" . \"\"))))</span>
<span style="color: #FBDE2D;">    =&gt; (\"&#25340;&#38899;\" \"&#36139;&#38080;\" \"&#32856;&#29992;\")</span>
<span style="color: #FBDE2D;">"</span>
  (<span style="color: #4c83ff;">let</span> (words)
    (<span style="color: #4c83ff;">dolist</span> (word (reverse wordspy))
      (<span style="color: #4c83ff;">if</span> (listp word)
          (<span style="color: #4c83ff;">setq</span> words (append words (pyim-dcache-get (car word))))
        (<span style="color: #4c83ff;">setq</span> words (append words (pyim-dcache-get word)))))
    words))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-possible-words-py</span> (spinyin)
  <span style="color: #FBDE2D;">"&#25152;&#26377;&#21487;&#33021;&#30340;&#35789;&#32452;&#25340;&#38899;&#12290;&#20174;&#31532;&#19968;&#20010;&#23383;&#24320;&#22987;&#65292;&#27599;&#20010;&#23383;&#26029;&#24320;&#24418;&#25104;&#19968;&#20010;&#25340;&#38899;&#12290;&#22914;&#26524;&#26159;</span>
<span style="color: #FBDE2D;">&#23436;&#25972;&#25340;&#38899;&#65292;&#21017;&#32473;&#20986;&#23436;&#25972;&#30340;&#25340;&#38899;&#65292;&#22914;&#26524;&#26159;&#32473;&#20986;&#22768;&#27597;&#65292;&#21017;&#20026;&#19968;&#20010; CONS CELL&#65292;CAR &#26159;</span>
<span style="color: #FBDE2D;">&#25340;&#38899;&#65292;CDR &#26159;&#25340;&#38899;&#21015;&#34920;&#12290;&#20363;&#22914;&#65306;</span>

<span style="color: #FBDE2D;"> (setq foo-spinyin (pyim-code-split \"pin-yin-sh-r\" 'quanpin))</span>
<span style="color: #FBDE2D;">  =&gt; ((\"p\" . \"in\") (\"y\" . \"in\") (\"sh\" . \"\") (\"r\" . \"\"))</span>

<span style="color: #FBDE2D;"> (pyim-possible-words-py foo-spinyin)</span>
<span style="color: #FBDE2D;">  =&gt; (\"pin-yin\" (\"p-y-sh\" (\"p\" . \"in\") (\"y\" . \"in\") (\"sh\" . \"\")) (\"p-y-sh-r\" (\"p\" . \"in\") (\"y\" . \"in\") (\"sh\" . \"\") (\"r\" . \"\")))</span>
<span style="color: #FBDE2D;"> "</span>
  (<span style="color: #4c83ff;">let</span> (pys fullpy smpy wordlist (full t))
    (<span style="color: #4c83ff;">if</span> (string&lt; <span style="color: #61CE3C;">""</span> (cdar spinyin))
        (<span style="color: #4c83ff;">setq</span> fullpy (concat (caar spinyin) (cdar spinyin))
              smpy (pyim-essential-py (car spinyin)))
      (<span style="color: #4c83ff;">setq</span> smpy (caar spinyin)
            full nil))
    (<span style="color: #4c83ff;">setq</span> wordlist (list (car spinyin)))
    (<span style="color: #4c83ff;">dolist</span> (py (cdr spinyin))
      (<span style="color: #4c83ff;">setq</span> wordlist (append wordlist (list py)))
      (<span style="color: #4c83ff;">if</span> (<span style="color: #4c83ff;">and</span> full (string&lt; <span style="color: #61CE3C;">""</span> (cdr py)))
          (<span style="color: #4c83ff;">setq</span> fullpy (concat fullpy <span style="color: #61CE3C;">"-"</span> (car py) (cdr py))
                smpy (concat smpy <span style="color: #61CE3C;">"-"</span> (pyim-essential-py py))
                pys (append pys (list fullpy)))
        (<span style="color: #4c83ff;">setq</span> full nil
              smpy (concat smpy <span style="color: #61CE3C;">"-"</span> (pyim-essential-py py))
              pys (append pys (list (cons smpy wordlist))))))
    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">(message "%s: %s" pys wordlist))</span>
    pys))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-essential-py</span> (py)
  <span style="color: #FBDE2D;">"&#19968;&#20010;&#25340;&#38899;&#20013;&#30340;&#20027;&#35201;&#37096;&#20998;&#65292;&#22914;&#26524;&#26377;&#22768;&#27597;&#36820;&#22238;&#22768;&#27597;&#65292;&#21542;&#21017;&#36820;&#22238;&#38901;&#27597;"</span>
  (<span style="color: #4c83ff;">if</span> (string&lt; <span style="color: #61CE3C;">""</span> (car py))
      (car py)
    (cdr py)))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org68275db" class="outline-4">
<h4 id="org68275db"><span class="section-number-4">2.6.2</span>核心函数：拼音字符串处理函数</h4>
<div class="outline-text-4" id="text-2-6-2">
<p>
`pyim-handle-entered-code' 这个函数是一个重要的<b>核心函数</b>，其大致工作流程为：
</p>
<ol class="org-ol">
<li>查询拼音字符串 `pyim-entered-code' 得到： 待选词列表
`pyim-current-choices' 和 当前选择的词条 `pyim-entered-code'</li>
<li>显示备选词条和选择备选词等待用户选择。</li>
</ol>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-handle-entered-code</span> ()
  (<span style="color: #4c83ff;">let</span> ((scheme-name pyim-default-scheme)
        (str pyim-entered-code))
    (<span style="color: #4c83ff;">setq</span> pyim-scode-list (pyim-code-split str scheme-name)
          pyim-code-position 0)
    (<span style="color: #4c83ff;">unless</span> (<span style="color: #4c83ff;">and</span> (pyim-scode-validp
                  (car pyim-scode-list) scheme-name)
                 (<span style="color: #4c83ff;">progn</span>
                   (<span style="color: #4c83ff;">setq</span> pyim-entered-code
                         (pyim-code-restore-user-divide
                          (pyim-scode-join (car pyim-scode-list) scheme-name)
                          (pyim-code-user-divide-pos str)))
                   (<span style="color: #4c83ff;">setq</span> pyim-current-choices
                         (list (delete-dups (pyim-choices-get pyim-scode-list scheme-name))))
                   (<span style="color: #4c83ff;">when</span> (car pyim-current-choices)
                     (<span style="color: #4c83ff;">setq</span> pyim-current-pos 1)
                     (pyim-dagger-refresh)
                     (pyim-page-refresh)
                     (pyim-page-auto-select-word scheme-name)
                     t)))
      (<span style="color: #4c83ff;">setq</span> pyim-current-choices
            (list (list (format <span style="color: #61CE3C;">"%s"</span> (replace-regexp-in-string
                                      <span style="color: #61CE3C;">"-"</span> <span style="color: #61CE3C;">" "</span> pyim-entered-code)))))
      (<span style="color: #4c83ff;">setq</span> pyim-current-pos 1)
      (pyim-dagger-refresh)
      (pyim-page-refresh))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org0ae213d" class="outline-3">
<h3 id="org0ae213d"><span class="section-number-3">2.7</span>处理当前需要插入 buffer 的 dagger 字符串： `pyim-dagger-str'</h3>
<div class="outline-text-3" id="text-2-7">
<p>
Chinese-pyim 使用变量 `pyim-dagger-str' 保存<b>需要在 buffer 光标处插入的字符串</b>。
</p>

<p>
处理 `pyim-dagger-str' 的代码分散在多个函数中，可以按照下面的方式分类：
</p>
<ol class="org-ol">
<li>英文字符串：Chinese-pyim 没有找到相应的候选词时（比如：用户输入错误的拼音），`pyim-dagger-str' 的值与 `pyim-entered-code' 大致相同。相关代码很简单，分散在 `pyim-handle-entered-code' 或者
`pyim-dagger-append' 等相关函数。</li>
<li><p>
汉字或者拼音和汉字的混合：当 Chinese-pyim 找到相应的候选词条时，
`pyim-dagger-str' 的值可以是完全的中文词条，比如：
</p>
<pre class="example">
   你好
</pre>
<p>
或者中文词条＋拼音的混合新式，比如：
</p>
<pre class="example">
   你好bj
</pre>
<p>
这部份代码相对复杂，使用 `pyim-update-current-key' 专门处理。
</p></li>
</ol>

<p>
Chinese-pyim 会使用 emacs overlay 机制在<b>待输入buffer</b>光标处高亮显示
`pyim-dagger-str'，让用户快速了解当前输入的字符串，具体方式是：
</p>
<ol class="org-ol">
<li>在 `pyim-input-method' 中调用 `pyim-dagger-setup-overlay' 创建 overlay ，并使用变量 `pyim-dagger-overlay' 保存，创建时将 overlay 的 face 属性设置为
`pyim-dagger-face' ，用户可以使用这个变量来自定义 face。</li>
<li>使用函数 `pyim-dagger-show' 高亮显示 `pyim-dagger-str'
<ol class="org-ol">
<li>清除光标处原来的字符串。</li>
<li>插入 `pyim-dagger-str'</li>
<li>使用 `move-overlay' 函数调整变量 `pyim-dagger-overlay' 中保存的 overlay，让其符合新插入的字符串。</li>
</ol></li>
<li>在 `pyim-input-method' 中调用 `pyim-dagger-delete-overlay' ，删除
`pyim-dagger-overlay' 中保存的 overlay，这个函数同时也删除了 overlay 中包含的文本 `pyim-dagger-str'。</li>
</ol>

<p>
真正在<b>待输入buffer</b>插入 `pyim-dagger-str' 字符串的函数是
`read-event'，具体见 `pyim-input-method' 相关说明。
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-dagger-setup-overlay</span> ()
  (<span style="color: #4c83ff;">let</span> ((pos (point)))
    (<span style="color: #4c83ff;">if</span> (overlayp pyim-dagger-overlay)
        (move-overlay pyim-dagger-overlay pos pos)
      (<span style="color: #4c83ff;">setq</span> pyim-dagger-overlay (make-overlay pos pos))
      (<span style="color: #4c83ff;">if</span> input-method-highlight-flag
          (overlay-put pyim-dagger-overlay 'face 'pyim-dagger-face)))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-dagger-delete-overlay</span> ()
  (<span style="color: #4c83ff;">if</span> (<span style="color: #4c83ff;">and</span> (overlayp pyim-dagger-overlay) (overlay-start pyim-dagger-overlay))
      (delete-overlay pyim-dagger-overlay)))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-dagger-append</span> (str)
  <span style="color: #FBDE2D;">"Append STR to `</span><span style="color: #96CBFE;">pyim-dagger-str</span><span style="color: #FBDE2D;">'"</span>
  (<span style="color: #4c83ff;">setq</span> pyim-dagger-str (concat pyim-dagger-str str)))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-dagger-refresh</span> ()
  <span style="color: #FBDE2D;">"&#26356;&#26032; `</span><span style="color: #96CBFE;">pyim-dagger-str</span><span style="color: #FBDE2D;">' &#30340;&#20540;&#12290;"</span>
  (<span style="color: #4c83ff;">let*</span> ((end (pyim-page-end))
         (start (1- (pyim-page-start)))
         (choices (car pyim-current-choices))
         (choice (pyim-subseq choices start end))
         (pos (1- (min pyim-current-pos (length choices))))
         rest)
    (<span style="color: #4c83ff;">setq</span> pyim-dagger-str
          (concat (substring pyim-dagger-str 0
                             pyim-code-position)
                  (pyim-choice (nth pos choices))))
    (<span style="color: #4c83ff;">setq</span> rest (mapconcat
                #'(lambda (py)
                    (concat (car py) (cdr py)))
                (nthcdr (length pyim-dagger-str) (car pyim-scode-list))
                <span style="color: #61CE3C;">"'"</span>))
    (<span style="color: #4c83ff;">if</span> (string&lt; <span style="color: #61CE3C;">""</span> rest)
        (<span style="color: #4c83ff;">setq</span> pyim-dagger-str (concat pyim-dagger-str rest)))
    (<span style="color: #4c83ff;">unless</span> enable-multibyte-characters
      (<span style="color: #4c83ff;">setq</span> pyim-entered-code nil
            pyim-dagger-str nil)
      (<span style="color: #ff69b4;">error</span> <span style="color: #61CE3C;">"Can't input characters in current unibyte buffer"</span>))
    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">Delete old dagger string.</span>
    (pyim-dagger-delete-string)
    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">Insert new dagger string.</span>
    (insert pyim-dagger-str)
    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">Hightlight new dagger string.</span>
    (move-overlay pyim-dagger-overlay
                  (overlay-start pyim-dagger-overlay) (point))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-dagger-delete-string</span> ()
  <span style="color: #FBDE2D;">"&#21024;&#38500;&#24050;&#32463;&#25554;&#20837; buffer &#30340; dagger &#23383;&#31526;&#20018;&#12290;"</span>
  (<span style="color: #4c83ff;">if</span> (overlay-start pyim-dagger-overlay)
      (delete-region (overlay-start pyim-dagger-overlay)
                     (overlay-end pyim-dagger-overlay))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org9c3044d" class="outline-3">
<h3 id="org9c3044d"><span class="section-number-3">2.8</span>显示和选择备选词条</h3>
<div class="outline-text-3" id="text-2-8">
</div><div id="outline-container-org88860a6" class="outline-4">
<h4 id="org88860a6"><span class="section-number-4">2.8.1</span>构建词条菜单字符串</h4>
<div class="outline-text-4" id="text-2-8-1">
<p>
Chinese-pyim 内建两种方式显示选词框：
</p>

<ol class="org-ol">
<li>使用 `pyim-minibuffer-message' 函数在 minibuffer 中显示选词框。</li>
<li>使用 `pyim-tooltip-show' 函数在光标处创建一个 tooltip 来显示选词框。</li>
</ol>

<p>
两种方式的基本原理相同：通过<b>待选词列表</b>构建为一个字符串，然后显示这个字符串。用户可以根据这个字符串的提示，来执行相应的动作，比如按空格确认当前选择的词条或者按数字选择这个数字对应的词条。比如：
</p>

<pre class="example">
"1. 你好 2. 倪皓 3. 你 4.泥 ..."
</pre>

<p>
Chinese-pyim 使用 `pyim-current-choices' 来保存<b>待选词列表</b>，我们以
"nihao" 对应的 `pyim-current-choices' 的值为例，来说明选词框相关的操作函数。
</p>

<pre class="example">
("你好" "倪皓" "泥" "你" "呢" "拟" "逆" "腻" "妮" "怩" "溺" "尼" "禰" "齯" "麑" "鲵" "蜺" "衵" "薿" "旎" "睨" "铌" "昵" "匿" "倪" "霓" "暱" "柅" "猊" "郳" "輗" "坭" "惄" "堄" "儗" "伲" "祢" "慝")
</pre>

<p>
选词框的格式通过变量 `pyim-page-style' 来控制。
</p>

<p>
<b>待选词列表</b>一般都很长，不可能在一行中完全显示，所以 Chinese-pyim 使用了 page 的概念，比如，上面的 “nihao” 的<b>待选词列表</b>就可以逻辑的分成5页：
</p>

<pre class="example">
("你好"  倪皓"  "泥"  "你"  "呢"  "拟"  "逆"  "腻"  "妮"   ;第1页
 "怩"    "溺"   "尼"  "禰"  "齯"  "麑"  "鲵"  "蜺"  "衵"   ;第2页
 "薿"    "旎"   "睨"  "铌"  "昵"  "匿"  "倪"  "霓"  "暱"   ;第3页
 "柅"    "猊"   "郳"  "輗"  "坭"  "惄"  "堄"  "儗"  "伲"   ;第4页
 "祢"    "慝"                                              ;第5页)
</pre>

<p>
用户可以使用变量 `pyim-page-length' 自定义每一页显示词条的数量，默认设置为9。
</p>

<p>
`pyim-current-pos' 的取值以及 `pyim-page-length' 的设定值，共同决定了
Chinese-pyim 需要显示哪一页，我们以一个表格来表示上述<b>待选词列表</b>：
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">第1页</td>
<td class="org-left">"你好"</td>
<td class="org-left">倪皓"</td>
<td class="org-left">"泥"</td>
<td class="org-left">"你"</td>
<td class="org-left">"呢"</td>
<td class="org-left">"拟"</td>
<td class="org-left">"逆"</td>
<td class="org-left">"腻"</td>
<td class="org-left">"妮"</td>
</tr>

<tr>
<td class="org-left">第2页</td>
<td class="org-left">"怩"</td>
<td class="org-left">"溺"</td>
<td class="org-left">"尼"</td>
<td class="org-left">"禰"</td>
<td class="org-left">"齯"</td>
<td class="org-left">"麑"</td>
<td class="org-left">"鲵"</td>
<td class="org-left">"蜺"</td>
<td class="org-left">"衵"</td>
</tr>

<tr>
<td class="org-left">第3页</td>
<td class="org-left">-B- "薿"</td>
<td class="org-left">"旎"</td>
<td class="org-left">-A-"睨"</td>
<td class="org-left">"铌"</td>
<td class="org-left">"昵"</td>
<td class="org-left">"匿"</td>
<td class="org-left">"倪"</td>
<td class="org-left">"霓"</td>
<td class="org-left">-E- "暱"</td>
</tr>

<tr>
<td class="org-left">第4页</td>
<td class="org-left">"柅"</td>
<td class="org-left">"猊"</td>
<td class="org-left">"郳"</td>
<td class="org-left">"輗"</td>
<td class="org-left">"坭"</td>
<td class="org-left">"惄"</td>
<td class="org-left">"堄"</td>
<td class="org-left">"儗"</td>
<td class="org-left">"伲"</td>
</tr>

<tr>
<td class="org-left">第5页</td>
<td class="org-left">"祢"</td>
<td class="org-left">"慝"</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
假设 `pyim-current-pos' 为 A 所在的位置。那么：
</p>
<ol class="org-ol">
<li>函数 `pyim-page-current-page' 返回值为3， 说明当前 page 为第3页。</li>
<li>函数 `pyim-page-total-page'  返回值为5，说明 page 共有5页。</li>
<li>函数 `pyim-page-start' 返回 B 所在的位置。</li>
<li>函数 `pyim-page-end' 返回 E 所在的位置。</li>
<li><p>
函数 `pyim-page-refresh' 用于刷新显示 page
它会从 `pyim-current-choices' 中提取一个 sublist:
</p>
<pre class="example">
("薿" "旎" "睨" "铌" "昵" "匿" "倪" "霓" "暱")
</pre>
<p>
这个 sublist 的起点为  `pyim-page-start' 的返回值，终点为
`pyim-page-end' 的返回值。然后使用这个 sublist 来构建类似下面的字符串，并保存到一个 hashtable 的 :words 关键字对应的位置，这个 hastable
最终会做为参数传递给 `pyim-page-style' 相关的函数，用于生成 page。
</p>
<pre class="example">
"1. 薿 2.旎 3.睨 4.铌 5.昵 6.匿 7.倪 8.霓 9.暱"
</pre></li>
</ol>

<p>
`pyim-page-next-page' 这个命令用来翻页，其原理是：改变 `pyim-current-pos'的取值，假设一次只翻一页，那么这个函数所做的工作就是：
</p>
<ol class="org-ol">
<li>首先将 `pyim-current-pos' 增加 `pyim-page-length' ，确保其指定的位置在下一页。</li>
<li>然后将 `pyim-current-pos' 的值设定为 `pyim-page-start' 的返回值，确保 `pyim-current-pos' 的取值为下一页第一个词条的位置。</li>
<li>最后调用 `pyim-page-refresh' 来重新刷新页面。</li>
</ol>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #8B8989; font-style: italic;">;;;  </span><span style="color: #8B8989; font-style: italic;">page format</span>
(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-subseq</span> (list from <span style="color: #afd8af;">&amp;optional</span> to)
  (<span style="color: #4c83ff;">if</span> (null to) (nthcdr from list)
    (butlast (nthcdr from list) (- (length list) to))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-mod</span> (x y)
  <span style="color: #FBDE2D;">"like `</span><span style="color: #96CBFE;">mod</span><span style="color: #FBDE2D;">', but when result is 0, return Y"</span>
  (<span style="color: #4c83ff;">let</span> ((base (mod x y)))
    (<span style="color: #4c83ff;">if</span> (= base 0)
        y
      base)))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-choice</span> (choice)
  (<span style="color: #4c83ff;">let</span> ((output
         (<span style="color: #4c83ff;">if</span> (consp choice)
             (car choice)
           choice)))
    (<span style="color: #4c83ff;">if</span> (stringp output)
        (car (split-string output <span style="color: #61CE3C;">":"</span>))
     output)))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-page-current-page</span> ()
  (1+ (/ (1- pyim-current-pos) pyim-page-length)))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-page-total-page</span> ()
  (1+ (/ (1- (length (car pyim-current-choices))) pyim-page-length)))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-page-start</span> ()
  <span style="color: #FBDE2D;">"&#35745;&#31639;&#24403;&#21069;&#25152;&#22312;&#39029;&#30340;&#31532;&#19968;&#20010;&#35789;&#26465;&#30340;&#20301;&#32622;"</span>
  (<span style="color: #4c83ff;">let</span> ((pos (min (length (car pyim-current-choices)) pyim-current-pos)))
    (1+ (- pos (pyim-mod pos pyim-page-length)))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-page-end</span> (<span style="color: #afd8af;">&amp;optional</span> finish)
  <span style="color: #FBDE2D;">"&#35745;&#31639;&#24403;&#21069;&#25152;&#22312;&#39029;&#30340;&#26368;&#21518;&#19968;&#20010;&#35789;&#26465;&#30340;&#20301;&#32622;&#65292;&#22914;&#26524; pyim-current-choices &#29992;</span>
<span style="color: #FBDE2D;">&#23436;&#65292;&#21017;&#26816;&#26597;&#26159;&#21542;&#26377;&#34917;&#20840;&#12290;&#22914;&#26524; FINISH &#20026; non-nil&#65292;&#35828;&#26126;&#65292;&#34917;&#20840;&#24050;&#32463;&#29992;&#23436;&#20102;"</span>
  (<span style="color: #4c83ff;">let*</span> ((whole (length (car pyim-current-choices)))
         (len pyim-page-length)
         (pos pyim-current-pos)
         (last (+ (- pos (pyim-mod pos len)) len)))
    (<span style="color: #4c83ff;">if</span> (&lt; last whole)
        last
      (<span style="color: #4c83ff;">if</span> finish
          whole
        (pyim-page-end t)))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-page-refresh</span> (<span style="color: #afd8af;">&amp;optional</span> hightlight-current)
  <span style="color: #FBDE2D;">"&#25353;&#24403;&#21069;&#20301;&#32622;&#65292;&#29983;&#25104;&#20505;&#36873;&#35789;&#26465;"</span>
  (<span style="color: #4c83ff;">let*</span> ((end (pyim-page-end))
         (start (1- (pyim-page-start)))
         (choices (car pyim-current-choices))
         (choice
          (mapcar #'(lambda (x)
                      (<span style="color: #4c83ff;">if</span> (stringp x)
                          (replace-regexp-in-string <span style="color: #61CE3C;">":"</span> <span style="color: #61CE3C;">""</span> x)
                        x))
                  (pyim-subseq choices start end)))
         (pos (- (min pyim-current-pos (length choices)) start))
         (page-info (make-hash-table))
         (i 0))
    (puthash <span style="color: #4c83ff;">:key</span> (replace-regexp-in-string <span style="color: #61CE3C;">"-"</span> <span style="color: #61CE3C;">" "</span> pyim-entered-code)
             page-info)
    (puthash <span style="color: #4c83ff;">:current-page</span> (pyim-page-current-page) page-info)
    (puthash <span style="color: #4c83ff;">:total-page</span> (pyim-page-total-page) page-info)
    (puthash <span style="color: #4c83ff;">:words</span>
             (mapconcat 'identity
                        (mapcar
                         (<span style="color: #4c83ff;">lambda</span> (c)
                           (<span style="color: #4c83ff;">setq</span> i (1+ i))
                           (<span style="color: #4c83ff;">let</span> (str)
                             (<span style="color: #4c83ff;">setq</span> str (<span style="color: #4c83ff;">if</span> (consp c)
                                           (concat (car c) (cdr c))
                                         c))
                             <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#39640;&#20142;&#24403;&#21069;&#36873;&#25321;&#30340;&#35789;&#26465;&#65292;&#29992;&#20110; `</span><span style="color: #96CBFE; font-style: italic;">pyim-page-next-word</span><span style="color: #8B8989; font-style: italic;">'</span>
                             (<span style="color: #4c83ff;">if</span> (<span style="color: #4c83ff;">and</span> hightlight-current
                                      (= i pos))
                                 (format <span style="color: #61CE3C;">"%d[%s]"</span> i
                                         (propertize str 'face 'pyim-page-selected-word-face))
                               (format <span style="color: #61CE3C;">"%d.%s "</span> i str))))
                         choice) <span style="color: #61CE3C;">""</span>)
             page-info)
    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">Show page.</span>
    (<span style="color: #4c83ff;">when</span> (<span style="color: #4c83ff;">and</span> (<span style="color: #4c83ff;">if</span> (pyim-scheme-get-option pyim-default-scheme <span style="color: #4c83ff;">:auto-select</span>)
                   (&gt;= (length (car pyim-current-choices)) 2)
                 t)
               (null unread-command-events)
               (null unread-post-input-method-events))
      (<span style="color: #4c83ff;">if</span> (eq (selected-window) (minibuffer-window))
          <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">Show the guidance in the next line of the currrent</span>
          <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">minibuffer.</span>
          (pyim-minibuffer-message
           (format <span style="color: #61CE3C;">"  [%s]\n%s"</span>
                   current-input-method-title
                   (gethash <span style="color: #4c83ff;">:words</span> page-info)))
        <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">Show the guidance in echo area without logging.</span>
        (<span style="color: #4c83ff;">let</span> ((message-log-max nil))
          (<span style="color: #4c83ff;">if</span> pyim-page-tooltip
              (pyim-tooltip-show
               (<span style="color: #4c83ff;">let</span> ((func (intern (format <span style="color: #61CE3C;">"pyim-page-style:%S"</span> pyim-page-style))))
                 (<span style="color: #4c83ff;">if</span> (functionp func)
                     (funcall func page-info)
                   (pyim-page-style:two-lines page-info)))
               (overlay-start pyim-dagger-overlay))
            (message <span style="color: #61CE3C;">"%s"</span> (pyim-page-style:minibuffer page-info))))))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-page-next-page</span> (arg)
  (<span style="color: #4c83ff;">interactive</span> <span style="color: #61CE3C;">"p"</span>)
  (<span style="color: #4c83ff;">if</span> (= (length pyim-entered-code) 0)
      (<span style="color: #4c83ff;">progn</span>
        (pyim-dagger-append (pyim-translate last-command-event))
        (pyim-terminate-translation))
    (<span style="color: #4c83ff;">let</span> ((new (+ pyim-current-pos (* pyim-page-length arg) 1)))
      (<span style="color: #4c83ff;">setq</span> pyim-current-pos (<span style="color: #4c83ff;">if</span> (&gt; new 0) new 1)
            pyim-current-pos (pyim-page-start))
      (pyim-dagger-refresh)
      (pyim-page-refresh))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-page-previous-page</span> (arg)
  (<span style="color: #4c83ff;">interactive</span> <span style="color: #61CE3C;">"p"</span>)
  (pyim-page-next-page (- arg)))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-page-next-word</span> (arg)
  (<span style="color: #4c83ff;">interactive</span> <span style="color: #61CE3C;">"p"</span>)
  (<span style="color: #4c83ff;">if</span> (= (length pyim-entered-code) 0)
      (<span style="color: #4c83ff;">progn</span>
        (pyim-dagger-append (pyim-translate last-command-event))
        (pyim-terminate-translation))
    (<span style="color: #4c83ff;">let</span> ((new (+ pyim-current-pos arg)))
      (<span style="color: #4c83ff;">setq</span> pyim-current-pos (<span style="color: #4c83ff;">if</span> (&gt; new 0) new 1))
      (pyim-dagger-refresh)
      (pyim-page-refresh t))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-page-previous-word</span> (arg)
  (<span style="color: #4c83ff;">interactive</span> <span style="color: #61CE3C;">"p"</span>)
  (pyim-page-next-word (- arg)))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-page-style:two-lines</span> (page-info)
  <span style="color: #FBDE2D;">"&#23558; page-info &#26684;&#24335;&#21270;&#20026;&#31867;&#20284;&#19979;&#38754;&#26684;&#24335;&#30340;&#23383;&#31526;&#20018;&#65292;&#36825;&#20010;&#23383;&#31526;&#20018;&#23558;&#22312;</span>
<span style="color: #FBDE2D;">tooltip &#36873;&#35789;&#26694;&#20013;&#26174;&#31034;&#12290;</span>

<span style="color: #FBDE2D;">+----------------------------+</span>
<span style="color: #FBDE2D;">| ni hao [1/9]               |</span>
<span style="color: #FBDE2D;">| 1.&#20320;&#22909; 2.&#20320;&#21495; ...          |</span>
<span style="color: #FBDE2D;">+----------------------------+"</span>
  (format <span style="color: #61CE3C;">"=&gt; %s [%s/%s]: \n%s"</span>
          (gethash <span style="color: #4c83ff;">:key</span> page-info)
          (gethash <span style="color: #4c83ff;">:current-page</span> page-info)
          (gethash <span style="color: #4c83ff;">:total-page</span> page-info)
          (gethash <span style="color: #4c83ff;">:words</span> page-info)))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-page-style:one-line</span> (page-info)
  <span style="color: #FBDE2D;">"&#23558; page-info &#26684;&#24335;&#21270;&#20026;&#31867;&#20284;&#19979;&#38754;&#26684;&#24335;&#30340;&#23383;&#31526;&#20018;&#65292;&#36825;&#20010;&#23383;&#31526;&#20018;&#23558;&#22312;</span>
<span style="color: #FBDE2D;">tooltip &#36873;&#35789;&#26694;&#20013;&#26174;&#31034;&#12290;</span>

<span style="color: #FBDE2D;">+-----------------------------------+</span>
<span style="color: #FBDE2D;">| [ni hao]: 1.&#20320;&#22909; 2.&#20320;&#21495; ... (1/9) |</span>
<span style="color: #FBDE2D;">+-----------------------------------+"</span>
  (format <span style="color: #61CE3C;">"[%s]: %s(%s/%s)"</span>
          (replace-regexp-in-string
           <span style="color: #61CE3C;">" +"</span> <span style="color: #61CE3C;">""</span>
           (gethash <span style="color: #4c83ff;">:key</span> page-info))
          (gethash <span style="color: #4c83ff;">:words</span> page-info)
          (gethash <span style="color: #4c83ff;">:current-page</span> page-info)
          (gethash <span style="color: #4c83ff;">:total-page</span> page-info)))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-page-style:vertical</span> (page-info)
  <span style="color: #FBDE2D;">"&#23558; page-info &#26684;&#24335;&#21270;&#20026;&#31867;&#20284;&#19979;&#38754;&#26684;&#24335;&#30340;&#23383;&#31526;&#20018;&#65292;&#36825;&#20010;&#23383;&#31526;&#20018;&#23558;&#22312;</span>
<span style="color: #FBDE2D;">tooltip &#36873;&#35789;&#26694;&#20013;&#26174;&#31034;&#12290;</span>

<span style="color: #FBDE2D;">+--------------+</span>
<span style="color: #FBDE2D;">| ni hao [1/9] |</span>
<span style="color: #FBDE2D;">| 1.&#20320;&#22909;       |</span>
<span style="color: #FBDE2D;">| 2.&#20320;&#21495; ...   |</span>
<span style="color: #FBDE2D;">+--------------+"</span>
  (format <span style="color: #61CE3C;">"=&gt; %s [%s/%s]: \n%s"</span>
          (gethash <span style="color: #4c83ff;">:key</span> page-info)
          (gethash <span style="color: #4c83ff;">:current-page</span> page-info)
          (gethash <span style="color: #4c83ff;">:total-page</span> page-info)
          (replace-regexp-in-string
           <span style="color: #61CE3C;">"]"</span> <span style="color: #61CE3C;">"]\n"</span>
           (replace-regexp-in-string
            <span style="color: #61CE3C;">" +"</span> <span style="color: #61CE3C;">"\n"</span>
            (gethash <span style="color: #4c83ff;">:words</span> page-info)))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-page-style:minibuffer</span> (page-info)
  <span style="color: #FBDE2D;">"&#23558; page-info &#26684;&#24335;&#21270;&#20026;&#31867;&#20284;&#19979;&#38754;&#26684;&#24335;&#30340;&#23383;&#31526;&#20018;&#65292;&#36825;&#20010;&#23383;&#31526;&#20018;</span>
<span style="color: #FBDE2D;">&#23558;&#22312; minibuffer &#20013;&#26174;&#31034;&#12290;</span>

<span style="color: #FBDE2D;">+----------------------------------+</span>
<span style="color: #FBDE2D;">| ni hao [1/9] 1.&#20320;&#22909; 2.&#20320;&#21495; ...   |</span>
<span style="color: #FBDE2D;">+----------------------------------+"</span>
  (format <span style="color: #61CE3C;">"%s [%s/%s]: %s"</span>
          (gethash <span style="color: #4c83ff;">:key</span> page-info)
          (gethash <span style="color: #4c83ff;">:current-page</span> page-info)
          (gethash <span style="color: #4c83ff;">:total-page</span> page-info)
          (gethash <span style="color: #4c83ff;">:words</span> page-info)))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-tooltip-show</span> (string position)
  <span style="color: #FBDE2D;">"&#22312; `</span><span style="color: #96CBFE;">position</span><span style="color: #FBDE2D;">' &#20301;&#32622;&#65292;&#20351;&#29992; pos-tip &#25110;&#32773; popup &#26174;&#31034;&#23383;&#31526;&#20018; `</span><span style="color: #96CBFE;">string</span><span style="color: #FBDE2D;">' &#12290;"</span>
  (<span style="color: #4c83ff;">let</span> ((frame (window-frame (selected-window)))
        (length (* pyim-page-length 10))
        (tooltip pyim-page-tooltip)
        (pos-tip-usable-p (pyim-tooltip-pos-tip-usable-p)))
    (<span style="color: #4c83ff;">cond</span> ((<span style="color: #4c83ff;">or</span> (eq tooltip t)
               (eq tooltip 'popup)
               (<span style="color: #4c83ff;">and</span> (eq tooltip 'pos-tip)
                    (not pos-tip-usable-p)))
           (popup-tip string <span style="color: #4c83ff;">:point</span> position <span style="color: #4c83ff;">:margin</span> 1))
          ((<span style="color: #4c83ff;">and</span> pos-tip-usable-p
                (eq tooltip 'pos-tip))
           (pos-tip-show-no-propertize string
                                       nil
                                       position nil 15
                                       (round (* (pos-tip-tooltip-width length (frame-char-width frame))
                                                 pyim-page-tooltip-width-adjustment))
                                       (pos-tip-tooltip-height 2 (frame-char-height frame) frame)
                                       nil nil 35))
          ((eq tooltip 'minibuffer)
           (<span style="color: #4c83ff;">let</span> ((max-mini-window-height (+ pyim-page-length 2)))
             (message string)))
          (t (<span style="color: #ff69b4;">error</span> <span style="color: #61CE3C;">"`</span><span style="color: #96CBFE;">pyim-page-tooltip</span><span style="color: #61CE3C;">' &#35774;&#32622;&#19981;&#23545;&#65292;&#35831;&#37325;&#26032;&#35774;&#32622;&#12290;"</span>)))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-minibuffer-message</span> (string)
  (message nil)
  (<span style="color: #4c83ff;">let</span> ((point-max (point-max))
        (inhibit-quit t))
    (<span style="color: #4c83ff;">save-excursion</span>
      (goto-char point-max)
      (insert string))
    (sit-for 1000000)
    (delete-region point-max (point-max))
    (<span style="color: #4c83ff;">when</span> quit-flag
      (<span style="color: #4c83ff;">setq</span> quit-flag nil
            unread-command-events '(7)))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-tooltip-pos-tip-usable-p</span> ()
  <span style="color: #FBDE2D;">"&#27979;&#35797;&#24403;&#21069;&#29615;&#22659;&#19979; pos-tip &#26159;&#21542;&#21487;&#29992;&#12290;"</span>
  (not (<span style="color: #4c83ff;">or</span> noninteractive
           emacs-basic-display
           (not (display-graphic-p))
           (not (fboundp 'x-show-tip)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc4c00d5" class="outline-4">
<h4 id="orgc4c00d5"><span class="section-number-4">2.8.2</span>选择备选词</h4>
<div class="outline-text-4" id="text-2-8-2">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-page-auto-select-word</span> (scheme-name)
  <span style="color: #FBDE2D;">"&#24403;&#21482;&#26377;&#19968;&#20010;&#35789;&#26465;&#26102;&#65292;&#20381;&#25454; `</span><span style="color: #96CBFE;">scheme-name</span><span style="color: #FBDE2D;">' &#30340;&#35774;&#32622;&#65292;&#33258;&#21160;&#36873;&#25321;&#24403;&#21069;&#35789;&#26465;&#65292;</span>
<span style="color: #FBDE2D;">&#36825;&#20010;&#20989;&#25968;&#20027;&#35201;&#29992;&#20110;&#20116;&#31508;&#36755;&#20837;&#27861;&#12290;"</span>
  (<span style="color: #4c83ff;">when</span> (<span style="color: #4c83ff;">and</span> (= 1 (length (car pyim-current-choices)))
             (pyim-scheme-get-option scheme-name <span style="color: #4c83ff;">:auto-select</span>)
             (&gt;= (length pyim-entered-code)
                 (pyim-scheme-get-option scheme-name <span style="color: #4c83ff;">:auto-select-minimum-input</span>)))
    (call-interactively 'pyim-page-select-word)))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-page-select-word</span> ()
  <span style="color: #FBDE2D;">"&#20174;&#36873;&#35789;&#26694;&#20013;&#36873;&#25321;&#24403;&#21069;&#35789;&#26465;&#12290;"</span>
  (<span style="color: #4c83ff;">interactive</span>)
  (<span style="color: #4c83ff;">if</span> (null (car pyim-current-choices))  <span style="color: #8B8989; font-style: italic;">; </span><span style="color: #8B8989; font-style: italic;">&#22914;&#26524;&#27809;&#26377;&#36873;&#39033;&#65292;&#36755;&#20837;&#31354;&#26684;</span>
      (<span style="color: #4c83ff;">progn</span>
        (<span style="color: #4c83ff;">setq</span> pyim-dagger-str (pyim-translate last-command-event))
        (pyim-terminate-translation))
    (<span style="color: #4c83ff;">let</span> ((str (pyim-choice (nth (1- pyim-current-pos) (car pyim-current-choices))))
          scode-list)
      (pyim-create-or-rearrange-word str t)
      (<span style="color: #4c83ff;">setq</span> pyim-code-position (+ pyim-code-position (length str)))
      (<span style="color: #4c83ff;">if</span> (&gt;= pyim-code-position (length (car pyim-scode-list)))
                                        <span style="color: #8B8989; font-style: italic;">; </span><span style="color: #8B8989; font-style: italic;">&#22914;&#26524;&#26159;&#26368;&#21518;&#19968;&#20010;&#65292;&#26816;&#26597;</span>
                                        <span style="color: #8B8989; font-style: italic;">; </span><span style="color: #8B8989; font-style: italic;">&#26159;&#19981;&#26159;&#22312;&#25991;&#20214;&#20013;&#65292;&#27809;&#26377;&#30340;&#35805;&#65292;&#21019;</span>
                                        <span style="color: #8B8989; font-style: italic;">; </span><span style="color: #8B8989; font-style: italic;">&#24314;&#36825;&#20010;&#35789;</span>
          (<span style="color: #4c83ff;">progn</span>
            (<span style="color: #4c83ff;">if</span> (not (member pyim-dagger-str (car pyim-current-choices)))
                (pyim-create-or-rearrange-word pyim-dagger-str))
            (pyim-terminate-translation)
            <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">Chinese-pyim &#20351;&#29992;&#36825;&#20010; hook &#26469;&#22788;&#29702;&#32852;&#24819;&#35789;&#12290;</span>
            (run-hooks 'pyim-page-select-finish-hook))
        (<span style="color: #4c83ff;">setq</span> scode-list
              (delete-dups (mapcar
                            #'(lambda (scode)
                                (nthcdr pyim-code-position scode))
                            pyim-scode-list)))
        (<span style="color: #4c83ff;">setq</span> pyim-current-choices (list (pyim-choices-get scode-list pyim-default-scheme))
              pyim-current-pos 1)
        (pyim-dagger-refresh)
        (pyim-page-refresh)))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-page-select-word-by-number</span> ()
  <span style="color: #FBDE2D;">"&#20351;&#29992;&#25968;&#23383;&#32534;&#21495;&#26469;&#36873;&#25321;&#23545;&#24212;&#30340;&#35789;&#26465;&#12290;"</span>
  (<span style="color: #4c83ff;">interactive</span>)
  (<span style="color: #4c83ff;">if</span> (car pyim-current-choices)
      (<span style="color: #4c83ff;">let</span> ((index (- last-command-event ?1))
            (end (pyim-page-end)))
        (<span style="color: #4c83ff;">if</span> (&gt; (+ index (pyim-page-start)) end)
            (pyim-page-refresh)
          (<span style="color: #4c83ff;">setq</span> pyim-current-pos (+ pyim-current-pos index))
          (<span style="color: #4c83ff;">setq</span> pyim-dagger-str
                (concat (substring pyim-dagger-str 0
                                   pyim-code-position)
                        (pyim-choice
                         (nth (1- pyim-current-pos)
                              (car pyim-current-choices)))))
          (pyim-page-select-word)))
    (pyim-dagger-append (char-to-string last-command-event))
    (pyim-terminate-translation)))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org3073455" class="outline-3">
<h3 id="org3073455"><span class="section-number-3">2.9</span>处理标点符号</h3>
<div class="outline-text-3" id="text-2-9">
<p>
常用的标点符号数量不多，所以 Chinese-pyim 没有使用文件而是使用一个变量
`pyim-punctuation-dict' 来设置标点符号对应表，这个变量是一个 alist 列表。
</p>

<p>
Chinese-pyim 在运行过程中调用函数 `pyim-translate' 进行标点符号格式的转换。
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-translate-get-trigger-char</span> ()
  <span style="color: #FBDE2D;">"&#26816;&#26597; `</span><span style="color: #96CBFE;">pyim-translate-trigger-char</span><span style="color: #FBDE2D;">' &#26159;&#21542;&#20026;&#19968;&#20010;&#21512;&#29702;&#30340; trigger char &#12290;</span>

<span style="color: #FBDE2D;">Chinese-pyim &#30340; translate-trigger-char &#35201;&#21344;&#29992;&#19968;&#20010;&#38190;&#20301;&#65292;&#20026;&#20102;&#38450;&#27490;&#29992;&#25143;</span>
<span style="color: #FBDE2D;">&#33258;&#23450;&#20041;&#35774;&#32622;&#19982;&#36755;&#20837;&#27861;&#20914;&#31361;&#65292;&#36825;&#37324;&#38656;&#35201;&#26816;&#26597;&#19968;&#19979;&#36825;&#20010;&#38190;&#20301;&#35774;&#32622;&#30340;&#26159;&#21542;&#21512;&#29702;&#65292;</span>
<span style="color: #FBDE2D;">&#22914;&#26524;&#19981;&#21512;&#29702;&#65292;&#23601;&#36820;&#22238;&#36755;&#20837;&#27861;&#40664;&#35748;&#35774;&#23450;&#12290;"</span>
  (<span style="color: #4c83ff;">let*</span> ((user-trigger-char pyim-translate-trigger-char)
         (user-trigger-char
          (<span style="color: #4c83ff;">if</span> (characterp user-trigger-char)
              (char-to-string user-trigger-char)
            (<span style="color: #4c83ff;">when</span> (= (length user-trigger-char) 1)
              user-trigger-char)))
         (first-char (pyim-scheme-get-option
                      pyim-default-scheme
                      <span style="color: #4c83ff;">:first-chars</span>))
         (prefer-trigger-chars (pyim-scheme-get-option
                                pyim-default-scheme
                                <span style="color: #4c83ff;">:prefer-trigger-chars</span>)))
    (<span style="color: #4c83ff;">if</span> (pyim-string-match-p user-trigger-char first-char)
        (<span style="color: #4c83ff;">progn</span>
          <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">(message "&#27880;&#24847;&#65306;pyim-translate-trigger-char &#35774;&#32622;&#21644;&#24403;&#21069;&#36755;&#20837;&#27861;&#20914;&#31361;&#65292;&#20351;&#29992;&#25512;&#33616;&#35774;&#32622;&#65306;\"%s\""</span>
          <span style="color: #8B8989; font-style: italic;">;;          </span><span style="color: #8B8989; font-style: italic;">prefer-trigger-chars)</span>
          prefer-trigger-chars)
      user-trigger-char)))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-translate</span> (char)
  (<span style="color: #4c83ff;">let*</span> ((str (char-to-string char))
         <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#27880;&#24847;&#65306;`</span><span style="color: #96CBFE; font-style: italic;">str</span><span style="color: #8B8989; font-style: italic;">' &#26159; *&#24453;&#36755;&#20837;* &#30340;&#23383;&#31526;&#23545;&#24212;&#30340;&#23383;&#31526;&#20018;&#12290;</span>
         (str-before-1 (pyim-char-before-to-string 0))
         (str-before-2 (pyim-char-before-to-string 1))
         (str-before-3 (pyim-char-before-to-string 2))
         (str-before-4 (pyim-char-before-to-string 3))
         <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#20174;&#26631;&#28857;&#35789;&#24211;&#20013;&#25628;&#32034;&#19982; `</span><span style="color: #96CBFE; font-style: italic;">str</span><span style="color: #8B8989; font-style: italic;">' &#23545;&#24212;&#30340;&#26631;&#28857;&#21015;&#34920;&#12290;</span>
         (punc-list (assoc str pyim-punctuation-dict))
         <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#20174;&#26631;&#28857;&#35789;&#24211;&#20013;&#25628;&#32034;&#19982; `</span><span style="color: #96CBFE; font-style: italic;">str-before-1</span><span style="color: #8B8989; font-style: italic;">' &#23545;&#24212;&#30340;&#26631;&#28857;&#21015;&#34920;&#12290;</span>
         (punc-list-before-1
          (cl-some (<span style="color: #4c83ff;">lambda</span> (x)
                     (<span style="color: #4c83ff;">when</span> (member str-before-1 x) x))
                   pyim-punctuation-dict))
         <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">`</span><span style="color: #96CBFE; font-style: italic;">str-before-1</span><span style="color: #8B8989; font-style: italic;">' &#22312;&#20854;&#23545;&#24212;&#30340;&#26631;&#28857;&#21015;&#34920;&#20013;&#30340;&#20301;&#32622;&#12290;</span>
         (punc-posit-before-1
          (cl-position str-before-1 punc-list-before-1
                       <span style="color: #4c83ff;">:test</span> #'equal))
         (trigger-str (pyim-translate-get-trigger-char)))
    (<span style="color: #4c83ff;">cond</span>
     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#31354;&#26684;&#20043;&#21069;&#30340;&#23383;&#31526;&#20160;&#20040;&#20063;&#19981;&#36755;&#20837;&#12290;</span>
     ((&lt; char ? ) <span style="color: #61CE3C;">""</span>)

     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#36825;&#20010;&#37096;&#20221;&#19982;&#26631;&#28857;&#31526;&#21495;&#22788;&#29702;&#26080;&#20851;&#65292;&#20027;&#35201;&#29992;&#26469;&#24555;&#36895;&#20445;&#23384;&#29992;&#25143;&#33258;&#23450;&#20041;&#35789;&#26465;&#12290;</span>
     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#27604;&#22914;&#65306;&#22312;&#19968;&#20010;&#20013;&#25991;&#23383;&#31526;&#20018;&#21518;&#36755;&#20837; 2v&#65292;&#21487;&#20197;&#23558;&#20809;&#26631;&#21069;&#20004;&#20010;&#20013;&#25991;&#23383;&#31526;</span>
     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#32452;&#25104;&#30340;&#23383;&#31526;&#20018;&#65292;&#20445;&#23384;&#21040;&#20010;&#20154;&#35789;&#24211;&#12290;</span>
     ((<span style="color: #4c83ff;">and</span> (member (char-before) (number-sequence ?2 ?9))
           (pyim-string-match-p <span style="color: #61CE3C;">"\\cc"</span> str-before-2)
           (equal str trigger-str))
      (delete-char -1)
      (pyim-create-word-at-point
       (string-to-number str-before-1))
      <span style="color: #61CE3C;">""</span>)

     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#20809;&#26631;&#21069;&#38754;&#30340;&#23383;&#31526;&#20026;&#20013;&#25991;&#23383;&#31526;&#26102;&#65292;&#25353; v &#28165;&#27927;&#24403;&#21069;&#34892;&#30340;&#20869;&#23481;&#12290;</span>
     ((<span style="color: #4c83ff;">and</span> (not (numberp punc-posit-before-1))
           (pyim-string-match-p <span style="color: #61CE3C;">"\\cc"</span> str-before-1)
           (equal str trigger-str))
      (funcall pyim-wash-function)
      <span style="color: #61CE3C;">""</span>)

     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#20851;&#38381;&#26631;&#28857;&#36716;&#25442;&#21151;&#33021;&#26102;&#65292;&#21482;&#25554;&#20837;&#33521;&#25991;&#26631;&#28857;&#12290;</span>
     ((not (pyim-punctuation-full-width-p))
      str)

     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#24403;&#21069;&#23383;&#31526;&#23646;&#20110; `</span><span style="color: #96CBFE; font-style: italic;">pyim-punctuation-escape-list</span><span style="color: #8B8989; font-style: italic;">'&#26102;&#65292;</span>
     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#25554;&#20837;&#33521;&#25991;&#26631;&#28857;&#12290;</span>
     ((member (char-before)
              pyim-punctuation-escape-list)
      str)

     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#24403; `</span><span style="color: #96CBFE; font-style: italic;">pyim-punctuation-half-width-functions</span><span style="color: #8B8989; font-style: italic;">' &#20013;</span>
     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#20219;&#24847;&#19968;&#20010;&#20989;&#25968;&#36820;&#22238;&#20540;&#20026; t &#26102;&#65292;&#25554;&#20837;&#33521;&#25991;&#26631;&#28857;&#12290;</span>
     ((cl-some #'(lambda (x)
                   (<span style="color: #4c83ff;">if</span> (functionp x)
                       (funcall x char)
                     nil))
               pyim-punctuation-half-width-functions)
      str)

     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#24403;&#20809;&#26631;&#21069;&#38754;&#20026;&#33521;&#25991;&#26631;&#28857;&#26102;&#65292; &#25353; `</span><span style="color: #96CBFE; font-style: italic;">pyim-translate-trigger-char</span><span style="color: #8B8989; font-style: italic;">'</span>
     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#23545;&#24212;&#30340;&#23383;&#31526;&#21518;&#65292; &#33258;&#21160;&#23558;&#20854;&#36716;&#25442;&#20026;&#23545;&#24212;&#30340;&#20013;&#25991;&#26631;&#28857;&#12290;</span>
     ((<span style="color: #4c83ff;">and</span> (numberp punc-posit-before-1)
           (= punc-posit-before-1 0)
           (equal str trigger-str))
      (pyim-punctuation-translate-last-n-puncts 'full-width)
      <span style="color: #61CE3C;">""</span>)

     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#24403;&#20809;&#26631;&#21069;&#38754;&#20026;&#20013;&#25991;&#26631;&#28857;&#26102;&#65292; &#25353; `</span><span style="color: #96CBFE; font-style: italic;">pyim-translate-trigger-char</span><span style="color: #8B8989; font-style: italic;">'</span>
     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#23545;&#24212;&#30340;&#23383;&#31526;&#21518;&#65292; &#33258;&#21160;&#23558;&#20854;&#36716;&#25442;&#20026;&#23545;&#24212;&#30340;&#33521;&#25991;&#26631;&#28857;&#12290;</span>
     ((<span style="color: #4c83ff;">and</span> (numberp punc-posit-before-1)
           (&gt; punc-posit-before-1 0)
           (equal str trigger-str))
      (pyim-punctuation-translate-last-n-puncts 'half-width)
      <span style="color: #61CE3C;">""</span>)

     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#27491;&#24120;&#36755;&#20837;&#26631;&#28857;&#31526;&#21495;&#12290;</span>
     (punc-list
      (pyim-punctuation-return-proper-punct punc-list))

     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#24403;&#36755;&#20837;&#30340;&#23383;&#31526;&#19981;&#26159;&#26631;&#28857;&#31526;&#21495;&#26102;&#65292;&#21407;&#26679;&#25554;&#20837;&#12290;</span>
     (t str))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-char-before-to-string</span> (num)
  <span style="color: #FBDE2D;">"&#24471;&#21040;&#20809;&#26631;&#21069;&#31532; `</span><span style="color: #96CBFE;">num</span><span style="color: #FBDE2D;">' &#20010;&#23383;&#31526;&#65292;&#24182;&#23558;&#20854;&#36716;&#25442;&#20026;&#23383;&#31526;&#20018;&#12290;"</span>
  (<span style="color: #4c83ff;">let*</span> ((point (point))
         (point-before (- point num)))
    (<span style="color: #4c83ff;">when</span> (<span style="color: #4c83ff;">and</span> (&gt; point-before 0)
               (char-before point-before))
      (char-to-string (char-before point-before)))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-wash-current-line-function</span> ()
  <span style="color: #FBDE2D;">"&#28165;&#29702;&#24403;&#21069;&#34892;&#30340;&#20869;&#23481;&#65292;&#27604;&#22914;&#65306;&#21024;&#38500;&#19981;&#24517;&#35201;&#30340;&#31354;&#26684;&#65292;&#31561;&#12290;"</span>
  (<span style="color: #4c83ff;">interactive</span>)
  (<span style="color: #4c83ff;">let*</span> ((begin (line-beginning-position))
         (end (point))
         (string (buffer-substring-no-properties begin end))
         new-string)
    (<span style="color: #4c83ff;">when</span> (&gt; (length string) 0)
      (delete-region begin end)
      (<span style="color: #4c83ff;">setq</span> new-string
            (<span style="color: #4c83ff;">with-temp-buffer</span>
              (insert string)
              (goto-char (point-min))
              (<span style="color: #4c83ff;">while</span> (re-search-forward <span style="color: #61CE3C;">"</span><span style="color: #E9C062;">\\</span><span style="color: #ff0000;">(</span><span style="color: #61CE3C;">[&#65292;&#12290;&#65307;&#65311;&#65281;&#65307;&#12289;&#65289;&#12305;]</span><span style="color: #E9C062;">\\</span><span style="color: #ff0000;">)</span><span style="color: #61CE3C;">  +</span><span style="color: #E9C062;">\\</span><span style="color: #ff0000;">(</span><span style="color: #61CE3C;">[[:ascii:]]</span><span style="color: #E9C062;">\\</span><span style="color: #ff0000;">)</span><span style="color: #61CE3C;">"</span> nil t)
                (replace-match (concat (match-string 1) (match-string 2))  nil t))
              (goto-char (point-min))
              (<span style="color: #4c83ff;">while</span> (re-search-forward <span style="color: #61CE3C;">"</span><span style="color: #E9C062;">\\</span><span style="color: #ff0000;">(</span><span style="color: #61CE3C;">[[:ascii:]]</span><span style="color: #E9C062;">\\</span><span style="color: #ff0000;">)</span><span style="color: #61CE3C;">  +</span><span style="color: #E9C062;">\\</span><span style="color: #ff0000;">(</span><span style="color: #61CE3C;">[&#65288;&#12304;]</span><span style="color: #E9C062;">\\</span><span style="color: #ff0000;">)</span><span style="color: #61CE3C;">"</span> nil t)
                (replace-match (concat (match-string 1) (match-string 2))  nil t))
              (goto-char (point-min))
              (<span style="color: #4c83ff;">while</span> (re-search-forward <span style="color: #61CE3C;">"</span><span style="color: #E9C062;">\\</span><span style="color: #ff0000;">(</span><span style="color: #61CE3C;">[[:ascii:]]</span><span style="color: #E9C062;">\\</span><span style="color: #ff0000;">)</span><span style="color: #61CE3C;">  +</span><span style="color: #E9C062;">\\</span><span style="color: #ff0000;">(</span><span style="color: #61CE3C;">\\cc</span><span style="color: #E9C062;">\\</span><span style="color: #ff0000;">)</span><span style="color: #61CE3C;">"</span> nil t)
                (replace-match (concat (match-string 1) <span style="color: #61CE3C;">" "</span> (match-string 2))  nil t))
              (goto-char (point-min))
              (<span style="color: #4c83ff;">while</span> (re-search-forward <span style="color: #61CE3C;">"</span><span style="color: #E9C062;">\\</span><span style="color: #ff0000;">(</span><span style="color: #61CE3C;">\\cc</span><span style="color: #E9C062;">\\</span><span style="color: #ff0000;">)</span><span style="color: #61CE3C;">  +</span><span style="color: #E9C062;">\\</span><span style="color: #ff0000;">(</span><span style="color: #61CE3C;">[[:ascii:]]</span><span style="color: #E9C062;">\\</span><span style="color: #ff0000;">)</span><span style="color: #61CE3C;">"</span> nil t)
                (replace-match (concat (match-string 1) <span style="color: #61CE3C;">" "</span> (match-string 2))  nil t))
              (buffer-string)))
      (insert new-string))))
</pre>
</div>

<p>
当用户使用 org-mode 以及 markdown 等轻量级标记语言撰写文档时，常常需要输入数字列表，比如：
</p>

<pre class="example">
1. item1
2. item2
3. item3
</pre>

<p>
在这种情况下，数字后面输入句号必须是半角句号而不是全角句号，Chinese-pyim 调用 `pyim-translate' 时，会检测光标前面的字符，如果这个字符属于 `pyim-punctuation-escape-list' ，Chinese-pyim 将输入半角标点，具体细节见：`pyim-translate'
</p>

<p>
输入标点的样式的改变（全角或者半角）受三个方面影响：
</p>

<ol class="org-ol">
<li>用户是否手动切换了标点样式？</li>
</ol>
<p>
2  用户是否手动切换到英文输入模式？
</p>
<ol class="org-ol">
<li>Chinese-pyim 是否根据环境自动切换到英文输入模式？</li>
</ol>

<p>
三方面的综合结果为： 只要当前的输入模式是英文输入模式，那么输入的标点符号<b>必定</b>是半角标点，如果当前输入模式是中文输入模式，那么，输入标点的样式用户可以使用 `pyim-punctuation-toggle'
手动控制，具体请参考 `pyim-punctuation-full-width-p'。
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #8B8989; font-style: italic;">;;; </span><span style="color: #8B8989; font-style: italic;">&#20999;&#25442;&#20013;&#33521;&#25991;&#26631;&#28857;&#31526;&#21495;</span>
(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-punctuation-full-width-p</span> ()
  <span style="color: #FBDE2D;">"&#21028;&#26029;&#26159;&#21542;&#38656;&#35201;&#20999;&#25442;&#21040;&#20840;&#35282;&#26631;&#28857;&#36755;&#20837;&#27169;&#24335;"</span>
  (<span style="color: #4c83ff;">cl-case</span> (car pyim-punctuation-translate-p)
    (yes t)
    (no nil)
    (auto
     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#22914;&#26524;&#29992;&#25143;&#25163;&#21160;&#25110;&#32773;&#26681;&#25454;&#29615;&#22659;&#33258;&#21160;&#20999;&#25442;&#20026;&#33521;&#25991;&#36755;&#20837;&#27169;&#24335;&#65292;</span>
     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#37027;&#20040;&#26631;&#28857;&#31526;&#21495;&#20063;&#35201;&#20999;&#25442;&#20026;&#21322;&#35282;&#27169;&#24335;&#12290;</span>
     (<span style="color: #4c83ff;">and</span> (not pyim-input-ascii)
          (not (pyim-auto-switch-english-input-p))))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-punctuation-toggle</span> ()
  (<span style="color: #4c83ff;">interactive</span>)
  (<span style="color: #4c83ff;">setq</span> pyim-punctuation-translate-p
        `(,@(cdr pyim-punctuation-translate-p)
          ,(car pyim-punctuation-translate-p)))
  (message
   (<span style="color: #4c83ff;">cl-case</span> (car pyim-punctuation-translate-p)
     (yes <span style="color: #61CE3C;">"&#24320;&#21551;&#20840;&#35282;&#26631;&#28857;&#36755;&#20837;&#27169;&#24335;&#12290;"</span>)
     (no <span style="color: #61CE3C;">"&#24320;&#21551;&#21322;&#35282;&#26631;&#28857;&#36755;&#20837;&#27169;&#24335;&#12290;"</span>)
     (auto <span style="color: #61CE3C;">"&#24320;&#21551;&#20840;&#21322;&#35282;&#26631;&#28857;&#33258;&#21160;&#36716;&#25442;&#27169;&#24335;&#12290;"</span>))))
</pre>
</div>

<p>
每次运行 `pyim-punctuation-toggle' 命令，都会调整变量 `pyim-punctuation-translate-p'
的取值，`pyim-translate' 根据 `pyim-punctuation-full-width-p' 函数的返回值，来决定是否转换标点符号：
</p>

<ol class="org-ol">
<li>当返回值为 'yes 时，`pyim-translate' 转换标点符号，从而输入全角标点。</li>
<li>当返回值为 'no 时，`pyim-translate' 忽略转换，从而输入半角标点。</li>
<li>当返回值为 'auto 时，根据中英文环境，自动切换。</li>
</ol>

<p>
用户也可以使用命令 `pyim-punctuation-translate-at-point' 来切换<b>光标前</b>标点符号的样式。
</p>


<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-punctuation-translate-at-point</span> ()
  <span style="color: #FBDE2D;">"&#20999;&#25442;&#20809;&#26631;&#22788;&#26631;&#28857;&#30340;&#26679;&#24335;&#65288;&#20840;&#35282; or &#21322;&#35282;&#65289;&#12290;"</span>
  (<span style="color: #4c83ff;">interactive</span>)
  (<span style="color: #4c83ff;">let*</span> ((current-char (char-to-string (preceding-char)))
         (punc-list
          (cl-some (<span style="color: #4c83ff;">lambda</span> (x)
                     (<span style="color: #4c83ff;">when</span> (member current-char x) x))
                   pyim-punctuation-dict)))
    (<span style="color: #4c83ff;">when</span> punc-list
      (delete-char -1)
      (<span style="color: #4c83ff;">if</span> (equal current-char (car punc-list))
          (insert (pyim-punctuation-return-proper-punct punc-list))
        (insert (car punc-list))))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-punctuation-translate-last-n-puncts</span> (<span style="color: #afd8af;">&amp;optional</span> punct-style)
  <span style="color: #FBDE2D;">"&#23558;&#20809;&#26631;&#21069;&#38754;&#36830;&#32493;&#30340;n&#20010;&#26631;&#28857;&#31526;&#21495;&#36827;&#34892;&#20840;&#35282;/&#21322;&#35282;&#36716;&#25442;&#65292;&#24403; `</span><span style="color: #96CBFE;">punct-style</span><span style="color: #FBDE2D;">' &#35774;&#32622;&#20026; `</span><span style="color: #96CBFE;">full-width</span><span style="color: #FBDE2D;">' &#26102;&#65292;</span>
<span style="color: #FBDE2D;">&#25152;&#26377;&#30340;&#26631;&#28857;&#31526;&#21495;&#36716;&#25442;&#20026;&#20840;&#35282;&#31526;&#21495;&#65292;&#35774;&#32622;&#20026; `</span><span style="color: #96CBFE;">half-width</span><span style="color: #FBDE2D;">' &#26102;&#65292;&#36716;&#25442;&#20026;&#21322;&#35282;&#31526;&#21495;&#12290;"</span>
  (<span style="color: #4c83ff;">interactive</span>)
  (<span style="color: #4c83ff;">let</span> ((punc-list (pyim-flatten-list pyim-punctuation-dict))
        (punct-style
         (<span style="color: #4c83ff;">or</span> punct-style
             (intern (completing-read
                      <span style="color: #61CE3C;">"&#23558;&#20809;&#26631;&#21069;&#30340;&#26631;&#28857;&#36716;&#25442;&#20026;"</span> '(<span style="color: #61CE3C;">"full-width"</span> <span style="color: #61CE3C;">"half-width"</span>)))))
        (count 0)
        number last-puncts result)
    (<span style="color: #4c83ff;">while</span> count
      (<span style="color: #4c83ff;">let</span> ((str (pyim-char-before-to-string count)))
        (<span style="color: #4c83ff;">if</span> (member str punc-list)
            (<span style="color: #4c83ff;">progn</span>
              (<span style="color: #4c83ff;">push</span> str last-puncts)
              (<span style="color: #4c83ff;">setq</span> count (+ count 1)))
          (<span style="color: #4c83ff;">setq</span> number count)
          (<span style="color: #4c83ff;">setq</span> count nil))))
    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#21024;&#38500;&#26087;&#30340;&#26631;&#28857;&#31526;&#21495;</span>
    (delete-char (- 0 number))
    (<span style="color: #4c83ff;">dolist</span> (punct last-puncts)
      (<span style="color: #4c83ff;">dolist</span> (puncts pyim-punctuation-dict)
        (<span style="color: #4c83ff;">let</span> ((position (cl-position punct puncts <span style="color: #4c83ff;">:test</span> #'equal)))
          (<span style="color: #4c83ff;">when</span> position
            (<span style="color: #4c83ff;">cond</span>
             ((eq punct-style 'full-width)
              (<span style="color: #4c83ff;">if</span> (= position 0)
                  (<span style="color: #4c83ff;">push</span> (pyim-punctuation-return-proper-punct puncts) result)
                (<span style="color: #4c83ff;">push</span> punct result)))
             ((eq punct-style 'half-width)
              (<span style="color: #4c83ff;">if</span> (= position 0)
                  (<span style="color: #4c83ff;">push</span> punct result)
                (<span style="color: #4c83ff;">push</span> (car puncts) result))))))))
    (insert (mapconcat #'identity (reverse result) <span style="color: #61CE3C;">""</span>))))
</pre>
</div>

<p>
使用上述命令切换光标前标点符号的样式时，我们使用函数 `pyim-punctuation-return-proper-punct'
来处理成对的全角标点符号， 比如：
</p>

<pre class="example">
“”‘’
</pre>
<p>
这个函数的参数是一个标点符号对应表，类似：
</p>

<pre class="example">
("." "。")
</pre>

<p>
第一个元素为半角标点，第二个和第三个元素（如果有）为对应的全角标点。
</p>

<pre class="example">
(list (pyim-punctuation-return-proper-punct '("'" "‘" "’"))
      (pyim-punctuation-return-proper-punct '("'" "‘" "’")))
</pre>

<p>
结果为:
</p>
<pre class="example">
("’" "‘")
</pre>

<p>
简单来说，定义这个函数的目的是为了实现类似的功能：如果第一次输入的标点是：（‘）时，那么下一次输入的标点就是（’）。
</p>


<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#22788;&#29702;&#26631;&#28857;&#31526;&#21495;</span>
(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-punctuation-return-proper-punct</span> (punc-list <span style="color: #afd8af;">&amp;optional</span> before)
  <span style="color: #FBDE2D;">"&#36820;&#22238;&#21512;&#36866;&#30340;&#26631;&#28857;&#31526;&#21495;&#65292;`</span><span style="color: #96CBFE;">punc-list</span><span style="color: #FBDE2D;">'&#20026;&#26631;&#28857;&#31526;&#21495;&#21015;&#34920;&#65292;&#20854;&#26684;&#24335;&#31867;&#20284;&#65306;</span>
<span style="color: #FBDE2D;">      `(\",\" \"&#65292;\") &#25110;&#32773;&#65306;`(\"'\" \"&#8216;\" \"&#8217;\")</span>
<span style="color: #FBDE2D;">&#24403; `</span><span style="color: #96CBFE;">before</span><span style="color: #FBDE2D;">' &#20026; t &#26102;&#65292;&#21482;&#36820;&#22238;&#20999;&#25442;&#20043;&#21069;&#30340;&#32467;&#26524;&#65292;&#36825;&#20010;&#29992;&#26469;&#33719;&#21462;&#20999;&#25442;&#20043;&#21069;</span>
<span style="color: #FBDE2D;">&#30340;&#26631;&#28857;&#31526;&#21495;&#12290;"</span>
  (<span style="color: #4c83ff;">let*</span> ((str (car punc-list))
         (punc (cdr punc-list))
         (switch-p (cdr (assoc str pyim-punctuation-pair-status))))
    (<span style="color: #4c83ff;">if</span> (= (safe-length punc) 1)
        (car punc)
      (<span style="color: #4c83ff;">if</span> before
          (<span style="color: #4c83ff;">setq</span> switch-p (not switch-p))
        (<span style="color: #4c83ff;">setf</span> (cdr (assoc str pyim-punctuation-pair-status))
              (not switch-p)))
      (<span style="color: #4c83ff;">if</span> switch-p
          (car punc)
        (nth 1 punc)))))
</pre>
</div>

<p>
函数 `pyim-punctuation-return-proper-punct' 内部，我们使用变量 `pyim-punctuation-pair-status'
来记录“成对”中文标点符号的状态。
</p>
</div>
</div>

<div id="outline-container-org63b8669" class="outline-3">
<h3 id="org63b8669"><span class="section-number-3">2.10</span>处理特殊功能触发字符（单字符快捷键）</h3>
<div class="outline-text-3" id="text-2-10">
<p>
输入中文的时候，我们需要快速频繁的执行一些特定的命令，最直接的方法就是将上述命令绑定到一个容易按的快捷键上，但遗憾的是 emacs 大多数容易按的快捷键都<b>名花有主</b>了，甚至找一个 “Ctrl＋单字符”的快捷键都不太容易，特殊功能触发字符，可以帮助我们实现“单字符”快捷键，类似 org-mode 的 speed key。
</p>

<p>
默认情况下，我们可以使用特殊功能触发字符执行下面两个操作：
</p>
<ol class="org-ol">
<li><p>
快速切换中英文标点符号的样式：当光标前的字符是一个标点符号时，按"v"可以切换这个标点的样式。比如：光标在A处的时候，按 "v" 可以将A前面的全角逗号转换为半角逗号。
</p>
<pre class="example">
   你好，-A-
</pre>
<p>
按 "v" 后
</p>
<pre class="example">
   你好,-A-
</pre></li>
<li><p>
快速将光标前的词条添加到词库：当光标前的字符是中文字符时，按 "num" + "v" 可以将光标前 num 个中文汉字组成的词条添加到个人词频文件中，比如：当光标在A处时，按"4v"可以将“的红烧肉”这个词条加入个人词频文件，默认
num不超过9。
</p>
<pre class="example">
   我爱吃美味的红烧肉-A-
</pre></li>
</ol>

<p>
值得注意的是，这种方式如果添加的功能太多，会造成许多潜在的冲突。
</p>

<p>
用户可以使用变量 `pyim-translate-trigger-char' 来设置触发字符，默认的触发字符是："v", 选择这个字符的理由是：
</p>

<ol class="org-ol">
<li>"v" 不是有效的声母，不会对中文输入造成太大的影响。</li>
<li>"v" 字符很容易按。</li>
</ol>

<p>
Chinese-pyim 使用函数 `pyim-translate' 来处理特殊功能触发字符。当待输入的字符是触发字符时，`pyim-translate' 根据光标前的字符的不同来调用不同的功能，具体见 `pyim-translate' ：
</p>
</div>
</div>


<div id="outline-container-orgef70737" class="outline-3">
<h3 id="orgef70737"><span class="section-number-3">2.11</span>与拼音输入相关的用户命令</h3>
<div class="outline-text-3" id="text-2-11">
</div><div id="outline-container-org521481e" class="outline-4">
<h4 id="org521481e"><span class="section-number-4">2.11.1</span>删除拼音字符串最后一个字符</h4>
<div class="outline-text-4" id="text-2-11-1">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-delete-last-char</span> ()
  (<span style="color: #4c83ff;">interactive</span>)
  (<span style="color: #4c83ff;">if</span> (&gt; (length pyim-entered-code) 1)
      (<span style="color: #4c83ff;">progn</span>
        (<span style="color: #4c83ff;">setq</span> pyim-entered-code (substring pyim-entered-code 0 -1))
        (pyim-handle-entered-code))
    (<span style="color: #4c83ff;">setq</span> pyim-dagger-str <span style="color: #61CE3C;">""</span>)
    (pyim-terminate-translation)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orge98a9f4" class="outline-4">
<h4 id="orge98a9f4"><span class="section-number-4">2.11.2</span>删除拼音字符串最后一个拼音</h4>
<div class="outline-text-4" id="text-2-11-2">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-backward-kill-py</span> ()
  (<span style="color: #4c83ff;">interactive</span>)
  (<span style="color: #4c83ff;">if</span> (string-match <span style="color: #61CE3C;">"['-][</span><span style="color: #61CE3C;">^</span><span style="color: #61CE3C;">'-]+$"</span> pyim-entered-code)
      (<span style="color: #4c83ff;">progn</span> (<span style="color: #4c83ff;">setq</span> pyim-entered-code
                   (replace-match <span style="color: #61CE3C;">""</span> nil nil pyim-entered-code))
             (pyim-handle-entered-code))
    (<span style="color: #4c83ff;">setq</span> pyim-entered-code <span style="color: #61CE3C;">""</span>)
    (<span style="color: #4c83ff;">setq</span> pyim-dagger-str <span style="color: #61CE3C;">""</span>)
    (pyim-terminate-translation)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orge4ca8d9" class="outline-4">
<h4 id="orge4ca8d9"><span class="section-number-4">2.11.3</span>将光标前的 code 字符串转换为中文</h4>
<div class="outline-text-4" id="text-2-11-3">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-convert-code-at-point</span> ()
  (<span style="color: #4c83ff;">interactive</span>)
  (<span style="color: #4c83ff;">unless</span> (equal input-method-function 'pyim-input-method)
    (toggle-input-method))
  (<span style="color: #4c83ff;">let*</span> ((case-fold-search nil)
         (pyim-force-input-chinese t)
         (string (<span style="color: #4c83ff;">if</span> mark-active
                     (buffer-substring-no-properties
                      (region-beginning) (region-end))
                   (buffer-substring (point) (line-beginning-position))))
         code length)
    (<span style="color: #4c83ff;">if</span> (pyim-string-match-p <span style="color: #61CE3C;">"[[:punct:]]"</span> (pyim-char-before-to-string 0))
        <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#24403;&#20809;&#26631;&#21069;&#30340;&#19968;&#20010;&#23383;&#31526;&#26159;&#26631;&#28857;&#31526;&#21495;&#26102;&#65292;&#21322;&#35282;/&#20840;&#35282;&#20999;&#25442;&#12290;</span>
        (call-interactively 'pyim-punctuation-translate-at-point)
      (<span style="color: #4c83ff;">and</span> (string-match <span style="color: #61CE3C;">"[a-z'-]+ *$"</span> string)
           (<span style="color: #4c83ff;">setq</span> code (match-string 0 string))
           (<span style="color: #4c83ff;">setq</span> length (length code))
           (<span style="color: #4c83ff;">setq</span> code (replace-regexp-in-string <span style="color: #61CE3C;">" +"</span> <span style="color: #61CE3C;">""</span> code)))
      (<span style="color: #4c83ff;">when</span> (<span style="color: #4c83ff;">and</span> length (&gt; length 0))
        (delete-char (- 0 length))
        (insert (mapconcat #'char-to-string
                           (pyim-input-method code) <span style="color: #61CE3C;">""</span>))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org51e5547" class="outline-4">
<h4 id="org51e5547"><span class="section-number-4">2.11.4</span>取消当前输入</h4>
<div class="outline-text-4" id="text-2-11-4">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-quit-clear</span> ()
  (<span style="color: #4c83ff;">interactive</span>)
  (<span style="color: #4c83ff;">setq</span> pyim-dagger-str <span style="color: #61CE3C;">""</span>)
  (pyim-terminate-translation))
</pre>
</div>
</div>
</div>
<div id="outline-container-org74eb93d" class="outline-4">
<h4 id="org74eb93d"><span class="section-number-4">2.11.5</span>字母上屏</h4>
<div class="outline-text-4" id="text-2-11-5">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-quit-no-clear</span> ()
  (<span style="color: #4c83ff;">interactive</span>)
  (<span style="color: #4c83ff;">setq</span> pyim-dagger-str
        (replace-regexp-in-string <span style="color: #61CE3C;">"-"</span> <span style="color: #61CE3C;">""</span> pyim-entered-code))
  (pyim-terminate-translation))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb39504e" class="outline-4">
<h4 id="orgb39504e"><span class="section-number-4">2.11.6</span> Chinese-pyim 取消激活</h4>
<div class="outline-text-4" id="text-2-11-6">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-inactivate</span> ()
  (<span style="color: #4c83ff;">interactive</span>)
  (mapc 'kill-local-variable pyim-local-variable-list))
</pre>
</div>
</div>
</div>

<div id="outline-container-orga650279" class="outline-4">
<h4 id="orga650279"><span class="section-number-4">2.11.7</span>切换中英文输入模式</h4>
<div class="outline-text-4" id="text-2-11-7">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-toggle-input-ascii</span> ()
  <span style="color: #FBDE2D;">"Chinese-pyim &#20999;&#25442;&#20013;&#33521;&#25991;&#36755;&#20837;&#27169;&#24335;&#12290;&#21516;&#26102;&#35843;&#25972;&#26631;&#28857;&#31526;&#21495;&#26679;&#24335;&#12290;"</span>
  (<span style="color: #4c83ff;">interactive</span>)
  (<span style="color: #4c83ff;">setq</span> pyim-input-ascii
        (not pyim-input-ascii)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf6837d4" class="outline-4">
<h4 id="orgf6837d4"><span class="section-number-4">2.11.8</span>为 isearch 添加拼音搜索功能</h4>
<div class="outline-text-4" id="text-2-11-8">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-isearch-build-search-regexp</span> (pystr)
  <span style="color: #FBDE2D;">"&#36825;&#20010;&#20989;&#25968;&#29992;&#20110; isearch &#20013;&#25991; *&#25340;&#38899;* &#25628;&#32034;&#65292;</span>
<span style="color: #FBDE2D;">&#26681;&#25454; str &#26500;&#24314;&#19968;&#20010; regexp, &#27604;&#22914;&#65306;</span>

<span style="color: #FBDE2D;">\"nihao\" -&gt; \"[&#20320;&#21602;...][&#22909;&#21495;...] \\| nihao\""</span>
  (<span style="color: #4c83ff;">let*</span> ((scheme-name pyim-default-scheme)
         (class (pyim-scheme-get-option scheme-name <span style="color: #4c83ff;">:class</span>)))
    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#30830;&#20445; pyim &#35789;&#24211;&#21152;&#36733;</span>
    (pyim-dcache-init-variables)
    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">pyim &#26242;&#26102;&#21482;&#25903;&#25345;&#20840;&#25340;&#21644;&#21452;&#25340;&#25628;&#32034;</span>
    (<span style="color: #4c83ff;">when</span> (not (member class '(quanpin shuangpin)))
      (<span style="color: #4c83ff;">setq</span> scheme-name 'quanpin))
    (<span style="color: #4c83ff;">if</span> (<span style="color: #4c83ff;">or</span> (pyim-string-match-p <span style="color: #61CE3C;">"[</span><span style="color: #61CE3C;">^</span><span style="color: #61CE3C;">a-z']+"</span> pystr))
        pystr
      (<span style="color: #4c83ff;">let*</span> ((spinyin-list
              <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">Slowly operating, need to improve.</span>
              (pyim-code-split pystr scheme-name))
             (regexp-list
              (mapcar
               #'(lambda (spinyin)
                   (pyim-spinyin-build-cregexp spinyin))
               spinyin-list))
             (regexp
              (<span style="color: #4c83ff;">when</span> regexp-list
                (mapconcat #'identity
                           (delq nil regexp-list)
                           <span style="color: #61CE3C;">"</span><span style="color: #E9C062;">\\</span><span style="color: #ff0000;">|</span><span style="color: #61CE3C;">"</span>)))
             (regexp
              (<span style="color: #4c83ff;">if</span> (&gt; (length regexp) 0)
                  (concat pystr <span style="color: #61CE3C;">"</span><span style="color: #E9C062;">\\</span><span style="color: #ff0000;">|</span><span style="color: #61CE3C;">"</span> regexp)
                pystr)))
        regexp))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-spinyin-build-cregexp</span> (spinyin <span style="color: #afd8af;">&amp;optional</span> match-beginning
                                           first-equal all-equal)
  <span style="color: #FBDE2D;">"&#36825;&#20010;&#20989;&#25968;&#29983;&#25104;&#19968;&#20010; regexp &#65292;&#29992;&#36825;&#20010; regexp &#21487;&#20197;&#25628;&#32034;&#21040;</span>
<span style="color: #FBDE2D;">&#25340;&#38899;&#21305;&#37197; `</span><span style="color: #96CBFE;">spinyin</span><span style="color: #FBDE2D;">' &#30340;&#20013;&#25991;&#23383;&#31526;&#20018;&#12290;"</span>
  (<span style="color: #4c83ff;">let*</span> ((spinyin (mapcar
                   #'(lambda (x)
                       (concat (car x) (cdr x)))
                   spinyin))
         (cchar-list
          (<span style="color: #4c83ff;">let</span> ((n 0) results)
            (<span style="color: #4c83ff;">dolist</span> (py spinyin)
              (<span style="color: #4c83ff;">push</span>
               (mapconcat #'identity
                          (pyim-pinyin2cchar-get
                           py
                           (<span style="color: #4c83ff;">or</span> all-equal
                               (<span style="color: #4c83ff;">and</span> first-equal
                                    (= n 0)))) <span style="color: #61CE3C;">""</span>)
               results)
              (<span style="color: #4c83ff;">setq</span> n (+ 1 n)))
            (nreverse results)))
         (regexp
          (mapconcat
           #'(lambda (x)
               (<span style="color: #4c83ff;">when</span> (pyim-string-match-p <span style="color: #61CE3C;">"\\cc"</span> x)
                 (format <span style="color: #61CE3C;">"[%s]"</span> x)))
           cchar-list
           <span style="color: #61CE3C;">""</span>)))
    (<span style="color: #4c83ff;">unless</span> (equal regexp <span style="color: #61CE3C;">""</span>)
      (concat (<span style="color: #4c83ff;">if</span> match-beginning <span style="color: #61CE3C;">"^"</span> <span style="color: #61CE3C;">""</span>)
              regexp))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-isearch-pinyin-search-function</span> ()
  <span style="color: #FBDE2D;">"&#36825;&#20010;&#20989;&#25968;&#20026; isearch &#30456;&#20851;&#21629;&#20196;&#28155;&#21152;&#20013;&#25991;&#25340;&#38899;&#25628;&#32034;&#21151;&#33021;&#65292;</span>
<span style="color: #FBDE2D;">&#29992;&#20110; `</span><span style="color: #96CBFE;">isearch-search-fun-function</span><span style="color: #FBDE2D;">' &#12290;"</span>
  (<span style="color: #4c83ff;">if</span> pyim-isearch-enable-pinyin-search
      <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">Return the function to use for pinyin search</span>
      `(<span style="color: #4c83ff;">lambda</span> (string <span style="color: #afd8af;">&amp;optional</span> bound noerror count)
         (<span style="color: #4c83ff;">if</span> (pyim-string-match-p <span style="color: #61CE3C;">"[</span><span style="color: #61CE3C;">^</span><span style="color: #61CE3C;">a-z]+"</span> string)
             (funcall (isearch-search-fun-default) string bound noerror count)
           (funcall (<span style="color: #4c83ff;">if</span> ,isearch-forward
                        're-search-forward
                      're-search-backward)
                    (pyim-isearch-build-search-regexp string) bound noerror count)))
    <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">Return default function</span>
    (isearch-search-fun-default)))

(<span style="color: #4c83ff;">setq</span> isearch-search-fun-function 'pyim-isearch-pinyin-search-function)
</pre>
</div>
</div>
</div>
</div>
</div>

</div>
</div>
    <div>
      <div class="post-meta">
        <span title="post date" class="post-info">2017-02-06</span>
        <span title="last modification date" class="post-info">2017-02-06</span>
        <span title="tags" class="post-info">N/A</span>
        <span title="author" class="post-info">Feng Shu</span>
      </div>
      <section>
        <h1>Comments</h1>
        <div class="ds-thread"></div>
        <script type="text/javascript">
          var duoshuoQuery = {short_name:'tumashu-website'};
          (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = 'http://static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
          || document.getElementsByTagName('body')[0]).appendChild(ds);
          })();
        </script>
      </section>
      <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
          Copyright &copy; <span id="footerYear"></span> <a href="mailto:tumashu &lt;at&gt; 163 &lt;dot&gt; com">Feng Shu</a>
          &nbsp;&nbsp;-&nbsp;&nbsp;
          Powered by <a href="https://github.com/tumashu/org-webpage" target="_blank">org-webpage</a>
          <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
      </div>
    </div>

</div>
</body>
</html>
