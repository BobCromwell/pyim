<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>chinese-pyim-company - Chinese-pyim</title>
    <meta charset="utf-8" />
    <meta name="author" content="Feng Shu" />
    <link rel="stylesheet" href="http://tumashu.github.com/chinese-pyim/media/css/main.css" type="text/css">
  </head>
<body class="container">
    <div>
      <header class="masthead">
        <h1 class="masthead-title"><a href="http://tumashu.github.com/chinese-pyim/">Chinese-pyim</a> <span class="subtitle">(一个 emacs 环境下的中文拼音输入法)</span></h1>
        <ul>
          <li><a href="http://tumashu.github.com/chinese-pyim/documents/">Documents</a></li>
          <li><a href="http://tumashu.github.com/chinese-pyim/snapshots/">Snapshots</a></li>
          <li><a href="http://tumashu.github.com/chinese-pyim/tags/">Tags</a></li>
          <li><a href="http://tumashu.github.com/chinese-pyim/about/">About</a></li>
          <li><a href="https://github.com/tumashu/chinese-pyim">GitHub</a></li>
          <li><a href="http://tumashu.github.com/chinese-pyim/rss.xml">RSS</a></li>
        </ul>
        <form method="get" id="searchform" action="http://www.google.com/search">
          <input type="text" class="field" name="q" id="s" placeholder="Search">
          <input type="hidden" name="as_sitesearch" value="tumashu.github.com/chinese-pyim">
        </form>
        <img class="avatar" src="http://tumashu.github.com/chinese-pyim/media/img/horse.jpg" />
      </header>
    </div>

<div class="content-and-footer">
<div>
<div class="post">
<h1 class="post-title">chinese-pyim-company</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgheadline1">1. 说明文档</a></li>
<li><a href="#orgheadline6">2. 代码</a>
<ul>
<li><a href="#orgheadline2">2.1. Require + defcustom</a></li>
<li><a href="#orgheadline3">2.2. 让 company-grab-word 正确的处理中文</a></li>
<li><a href="#orgheadline4">2.3. 让 pyim-company-dabbrev&#x2013;make-regexp 生成合适中文搜索的 regexp</a></li>
<li><a href="#orgheadline5">2.4. <span class="todo TODO">TODO</span> 让 pyim-company-dabbrev&#x2013;search 更好的处理中文</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-orgheadline1" class="outline-2">
<h2 id="orgheadline1"><span class="section-number-2">1</span> 说明文档</h2>
<div class="outline-text-2" id="text-1">
<p>
通过 Chinese-pyim 让 Company-dabbrev 更好的处理中文。
</p>

<ol class="org-ol">
<li>配置 company-mode, 具体可以参考：<a href="https://github.com/tumashu/emacs-helper/blob/master/eh-complete.el">emacs-helper's company configure</a></li>
<li><p>
配置 chinese-pyim-company
</p>
<pre class="example">
(require 'chinese-pyim-company)
(setq pyim-company-max-length 6)
</pre></li>
</ol>
</div>
</div>



<div id="outline-container-orgheadline6" class="outline-2">
<h2 id="orgheadline6"><span class="section-number-2">2</span> 代码</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-orgheadline2" class="outline-3">
<h3 id="orgheadline2"><span class="section-number-3">2.1</span> Require + defcustom</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">require</span> '<span style="color: #96CBFE;">chinese-pyim</span>)
(<span style="color: #4c83ff;">require</span> '<span style="color: #96CBFE;">company</span>)
(<span style="color: #4c83ff;">require</span> '<span style="color: #96CBFE;">company-dabbrev</span>)

(<span style="color: #4c83ff;">defcustom</span> <span style="color: #ff69b4;">pyim-company-complete-chinese-enable</span> t
  <span style="color: #FBDE2D;">"&#35774;&#32622; Company &#26159;&#21542;&#34917;&#20840;&#20013;&#25991;"</span>
  <span style="color: #4c83ff;">:group</span> 'chinese-pyim)

(<span style="color: #4c83ff;">defcustom</span> <span style="color: #ff69b4;">pyim-company-max-length</span> 6
  <span style="color: #FBDE2D;">"&#36825;&#20010;&#29992;&#26469;&#35774;&#32622; Company &#34917;&#20840;&#20013;&#25991;&#26102;&#65292;&#20505;&#36873;&#20013;&#25991;&#35789;&#26465;&#30340;&#26368;&#22823;&#38271;&#24230;&#12290;"</span>
  <span style="color: #4c83ff;">:group</span> 'chinese-pyim)
</pre>
</div>

<p>
判断 Company-mode 是否在补全中文，如果光标前的一个字符为中文字符则返回 `t', 反之，返回 nil.
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-company-chinese-complete-p</span> ()
  (<span style="color: #4c83ff;">let</span> ((string (pyim-char-before-to-string 0)))
    (pyim-string-match-p <span style="color: #61CE3C;">"\\cc"</span> string)))
</pre>
</div>

<p>
`company-dabbrev' 补全命令的简单流程是：
</p>
<ol class="org-ol">
<li>提取光标前的一个字符串，作为搜索的 `prefix',
具体细节见： `company-grab-word'</li>
<li>对 `prefix' 进行进一步处理，生成一个搜索用的 `regexp'.
具体细节见： `company-dabbrev&#x2013;make-regexp'</li>
<li>使用生成的 `regexp' 搜索特定的 buffer.</li>
<li>将搜索得到的结果进行处理，生成一个候选词条的 `list'.
具体细节见： `company-dabbrev&#x2013;search'</li>
<li>使用菜单显示</li>
</ol>

<p>
中文和英文的书写习惯有很大的不同，对 company-mode 影响最大的一条是：
</p>

<pre class="example">
中文的词语与词语之间没有 *强制* 的用空格隔开，
</pre>

<p>
这个书写习惯影响上面三个函数的<b>正常</b>运行。
</p>
</div>
</div>

<div id="outline-container-orgheadline3" class="outline-3">
<h3 id="orgheadline3"><span class="section-number-3">2.2</span> 让 company-grab-word 正确的处理中文</h3>
<div class="outline-text-3" id="text-2-2">
<p>
`company-grab-word' 可以获取光标处的一个英文词语，但只能获取光标处的一个<b>中文句子</b>，使用一个句子来搜索，得到的备选词条往往很少，并且用处不大（很少人在一篇文章中重复的写一个句子）。
</p>

<p>
这里为 `company-grab-word' 添加了一个 advice: 当 company-dabbrev 补全中文时，用 `pyim-grab-chinese-word' 函数获取光标前的一个<b>中文词条</b>，如果获取失败，则返回光标前的<b>中文字符</b>。
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-company-grab-word</span> (orig-fun)
  (<span style="color: #4c83ff;">if</span> (pyim-company-chinese-complete-p)
      (<span style="color: #4c83ff;">when</span> pyim-company-complete-chinese-enable
        (<span style="color: #4c83ff;">or</span> (pyim-grab-chinese-word)
            (pyim-char-before-to-string 0)))
    (funcall orig-fun)))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-grab-chinese-word</span> (<span style="color: #afd8af;">&amp;optional</span> backward-char-number return-possible-words)
  <span style="color: #FBDE2D;">"&#33719;&#21462;&#20809;&#26631;&#22788;&#19968;&#20010; *&#26377;&#25928;&#30340;* &#20013;&#25991;&#35789;&#35821;&#65292;&#36739;&#38271;&#30340;&#35789;&#35821;&#20248;&#20808;&#12290;"</span>
  (<span style="color: #4c83ff;">unless</span> (<span style="color: #4c83ff;">featurep</span> '<span style="color: #96CBFE;">chinese-pyim-utils</span>)
    (<span style="color: #4c83ff;">require</span> '<span style="color: #96CBFE;">chinese-pyim-utils</span>))
  (<span style="color: #4c83ff;">let*</span> ((backward-char-number (<span style="color: #4c83ff;">or</span> backward-char-number 0))
         (string (replace-regexp-in-string
                  <span style="color: #61CE3C;">".*\\CC"</span> <span style="color: #61CE3C;">""</span>
                  (buffer-substring
                   (<span style="color: #4c83ff;">save-excursion</span>
                     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#22312;&#36755;&#20837;&#20013;&#25991;&#30340;&#26102;&#20505;&#65292;`</span><span style="color: #96CBFE; font-style: italic;">pyim-current-str</span><span style="color: #8B8989; font-style: italic;">' &#20063;&#20250;</span>
                     <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#25554;&#20837;&#21040;&#20809;&#26631;&#22788;&#65292;&#36339;&#36807;&#12290;&#12290;&#12290;</span>
                     (backward-char backward-char-number)
                     (point))
                   (<span style="color: #4c83ff;">save-excursion</span>
                     (backward-char backward-char-number)
                     (skip-syntax-backward <span style="color: #61CE3C;">"w"</span>)
                     (point)))))
         (string
          <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#25105;&#20204;&#20808;&#25552;&#21462;&#19968;&#20010;&#20013;&#25991;&#23383;&#31526;&#20018;&#65292;&#28982;&#21518;&#23558;&#36825;&#20010;&#23383;&#31526;&#20018;&#20998;&#35789;&#65292;&#24471;&#21040;&#25152;&#38656;&#35789;&#35821;&#12290;</span>
          <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#22240;&#20026;&#38271;&#23383;&#31526;&#20018;&#20998;&#35789;&#28040;&#32791;&#30340;&#26102;&#38388;&#36739;&#38271;&#65292;&#24433;&#21709;&#36755;&#20837;&#27861;&#21709;&#24212;&#36895;&#24230;&#65292;&#25152;&#20197;&#36825;&#37324;&#38480;&#21046;</span>
          <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#23383;&#31526;&#20018;&#38271;&#24230;&#20026;6&#65292;&#32463;&#39564;&#25968;&#20540;&#12290;</span>
          (<span style="color: #4c83ff;">if</span> (&gt; (length string) 6)
              (substring string -6)
            string))
         (length (length string)))
    (<span style="color: #4c83ff;">if</span> return-possible-words
        (<span style="color: #4c83ff;">when</span> (stringp string)
          (<span style="color: #4c83ff;">let</span> (results)
            (<span style="color: #4c83ff;">dotimes</span> (i length)
              (<span style="color: #4c83ff;">push</span> (substring string i) results))
            results))
      (cl-some #'(lambda (x)
                   (<span style="color: #4c83ff;">if</span> (= (nth 2 x) (+ 1 length))
                       (car x)))
               (nreverse (pyim-split-chinese-string string))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline4" class="outline-3">
<h3 id="orgheadline4"><span class="section-number-3">2.3</span> 让 pyim-company-dabbrev&#x2013;make-regexp 生成合适中文搜索的 regexp</h3>
<div class="outline-text-3" id="text-2-3">
<p>
用 `pyim-company-dabbrev&#x2013;make-regexp' 得到的 regexp, 搜索中文时，会搜索到一个
<b>中文句子</b>， 不太实用，这里添加了一个 advice:
</p>

<p>
当 company-dabbrev 补全中文时，将搜索得到的结果截取前 `pyim-company-max-length' 个字符，默认为6个，这对中文而言应该够用了。
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-company-dabbrev--make-regexp</span> (orig-fun)
  (<span style="color: #4c83ff;">if</span> (pyim-company-chinese-complete-p)
      (format <span style="color: #61CE3C;">"[</span><span style="color: #61CE3C;">^</span><span style="color: #61CE3C;">[:punct:][:blank:]\n]\\{1,%s\\}"</span> pyim-company-max-length)
    (funcall orig-fun)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline5" class="outline-3">
<h3 id="orgheadline5"><span class="section-number-3">2.4</span> <span class="todo TODO">TODO</span> 让 pyim-company-dabbrev&#x2013;search 更好的处理中文</h3>
<div class="outline-text-3" id="text-2-4">
<p>
本来打算在这个地方对<b>候选词条列表</b>做一些筛选，比如，用 Chinese-pyim 自带的分词函数对候选词条进行分词，然后只提取第一个<b>有效</b>的中文词语，但由于分词函数速度太慢，导致补全时卡顿明显，所以暂时没有这么处理。
</p>


<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-company-dabbrev--search</span> (orig-fun regexp <span style="color: #afd8af;">&amp;optional</span> limit other-buffer-modes
                                              ignore-comments)
  (<span style="color: #4c83ff;">if</span> (pyim-company-chinese-complete-p)
      (<span style="color: #4c83ff;">when</span> pyim-company-complete-chinese-enable
        (funcall orig-fun regexp limit other-buffer-modes ignore-comments))
    (funcall orig-fun regexp limit other-buffer-modes ignore-comments)))
</pre>
</div>


<div class="org-src-container">

<pre class="src src-emacs-lisp">(advice-add 'company-grab-word <span style="color: #4c83ff;">:around</span> #'pyim-company-grab-word)
(advice-add 'company-dabbrev--make-regexp <span style="color: #4c83ff;">:around</span> #'pyim-company-dabbrev--make-regexp)
(advice-add 'company-dabbrev--search <span style="color: #4c83ff;">:around</span> #'pyim-company-dabbrev--search)
</pre>
</div>
</div>
</div>
</div>

</div>
</div>
    <div>
      <div class="post-meta">
        <span title="post date" class="post-info">2016-08-11</span>
        <span title="last modification date" class="post-info">2016-07-04</span>
        <span title="tags" class="post-info">N/A</span>
        <span title="author" class="post-info">Feng Shu</span>
      </div>
      <section>
        <h1>Comments</h1>
        <div class="ds-thread"></div>
        <script type="text/javascript">
          var duoshuoQuery = {short_name:'tumashu-website'};
          (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = 'http://static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
          || document.getElementsByTagName('body')[0]).appendChild(ds);
          })();
        </script>
      </section>
      <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.x(<a href="http://orgmode.org">Org mode</a> 8.x)</p>
        <p>
          Copyright &copy; <span id="footerYear"></span> <a href="mailto:tumashu &lt;at&gt; 163 &lt;dot&gt; com">Feng Shu</a>
          &nbsp;&nbsp;-&nbsp;&nbsp;
          Powered by <a href="https://github.com/tumashu/org-webpage" target="_blank">org-webpage</a>
          <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
      </div>
    </div>

</div>
</body>
</html>
