<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>chinese-pyim-probe - Chinese-pyim</title>
    <meta charset="utf-8" />
    <meta name="author" content="Feng Shu" />
    <link rel="stylesheet" href="http://tumashu.github.com/chinese-pyim/media/css/main.css" type="text/css">
  </head>
<body class="container">
    <div>
      <header class="masthead">
        <h1 class="masthead-title"><a href="http://tumashu.github.com/chinese-pyim/">Chinese-pyim</a> <span class="subtitle">(一个 emacs 环境下的中文拼音输入法)</span></h1>
        <ul>
          <li><a href="http://tumashu.github.com/chinese-pyim/documents/">Documents</a></li>
          <li><a href="http://tumashu.github.com/chinese-pyim/snapshots/">Snapshots</a></li>
          <li><a href="http://tumashu.github.com/chinese-pyim/tags/">Tags</a></li>
          <li><a href="http://tumashu.github.com/chinese-pyim/about/">About</a></li>
          <li><a href="https://github.com/tumashu/chinese-pyim">GitHub</a></li>
          <li><a href="http://tumashu.github.com/chinese-pyim/rss.xml">RSS</a></li>
        </ul>
        <form method="get" id="searchform" action="http://www.google.com/search">
          <input type="text" class="field" name="q" id="s" placeholder="Search">
          <input type="hidden" name="as_sitesearch" value="tumashu.github.com/chinese-pyim">
        </form>
        <img class="avatar" src="http://tumashu.github.com/chinese-pyim/media/img/horse.jpg" />
      </header>
    </div>

<div class="content-and-footer">
<div>
<div class="post">
<h1 class="post-title">chinese-pyim-probe</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org41f6521">1. 使用说明&#xa0;&#xa0;&#xa0;<span class="tag"><span class="doc">doc</span></span></a>
<ul>
<li><a href="#org7c5f7d3">1.1. 简介</a></li>
<li><a href="#org36f0f61">1.2. 设置</a>
<ul>
<li><a href="#org98a4631">1.2.1. 根据环境自动切换到英文输入模式</a></li>
<li><a href="#org6f080f4">1.2.2. 根据环境自动切换到半角标点输入模式</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgae79d4e">2. 代码&#xa0;&#xa0;&#xa0;<span class="tag"><span class="code">code</span></span></a>
<ul>
<li><a href="#orgff3a499">2.1. 根据环境自动切换到英文输入模式</a></li>
<li><a href="#org240b0d6">2.2. 根据环境自动切换到半角标点输入模式</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org41f6521" class="outline-2">
<h2 id="org41f6521"><span class="section-number-2">1</span> 使用说明&#xa0;&#xa0;&#xa0;<span class="tag"><span class="doc">doc</span></span></h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-org7c5f7d3" class="outline-3">
<h3 id="org7c5f7d3"><span class="section-number-3">1.1</span> 简介</h3>
<div class="outline-text-3" id="text-1-1">
<p>
这个文件包含了许多探针函数，用于实现两个功能：
</p>

<ol class="org-ol">
<li>根据环境自动切换到英文输入模式</li>
<li>根据环境自动切换到半角标点输入模式</li>
</ol>
</div>
</div>

<div id="outline-container-org36f0f61" class="outline-3">
<h3 id="org36f0f61"><span class="section-number-3">1.2</span> 设置</h3>
<div class="outline-text-3" id="text-1-2">
</div><div id="outline-container-org98a4631" class="outline-4">
<h4 id="org98a4631"><span class="section-number-4">1.2.1</span> 根据环境自动切换到英文输入模式</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
用户将探针函数添加到 `pyim-english-input-switch-functions' 后, 就可以激活这个探针函数，比如：
</p>

<pre class="example">
(setq-default pyim-english-input-switch-functions
              '(pyim-probe-dynamic-english
                pyim-probe-isearch-mode
                pyim-probe-program-mode))
</pre>

<p>
只要上述<b>函数列表</b>中，任意一个函数返回值为 t, Chinese-pyim 就自动切换到英文输入模式。
</p>
</div>
</div>

<div id="outline-container-org6f080f4" class="outline-4">
<h4 id="org6f080f4"><span class="section-number-4">1.2.2</span> 根据环境自动切换到半角标点输入模式</h4>
<div class="outline-text-4" id="text-1-2-2">
<p>
用户将探针函数添加到 `pyim-punctuation-half-width-functions' 后, 就可以激活这个探针函数。
</p>
</div>
</div>
</div>
</div>


<div id="outline-container-orgae79d4e" class="outline-2">
<h2 id="orgae79d4e"><span class="section-number-2">2</span> 代码&#xa0;&#xa0;&#xa0;<span class="tag"><span class="code">code</span></span></h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-orgff3a499" class="outline-3">
<h3 id="orgff3a499"><span class="section-number-3">2.1</span> 根据环境自动切换到英文输入模式</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-probe-program-mode</span> ()
  <span style="color: #FBDE2D;">"&#28608;&#27963;&#36825;&#20010; Chinese-pyim &#25506;&#38024;&#20989;&#25968;&#21518;&#65292;&#21482;&#33021;&#22312;&#23383;&#31526;&#20018;&#21644; comment &#20013;&#36755;&#20837;&#20013;&#25991;&#12290;</span>
<span style="color: #FBDE2D;">&#27880;&#65306;&#20165;&#20165;&#24433;&#21709; `</span><span style="color: #96CBFE;">prog-mode</span><span style="color: #FBDE2D;">' &#34893;&#29983;&#30340; mode &#12290;</span>

<span style="color: #FBDE2D;">&#29992;&#20110;&#65306;`</span><span style="color: #96CBFE;">pyim-english-input-switch-functions</span><span style="color: #FBDE2D;">' &#12290;"</span>
  (<span style="color: #4c83ff;">interactive</span>)
  (<span style="color: #4c83ff;">when</span> (derived-mode-p 'prog-mode)
    (<span style="color: #4c83ff;">let*</span> ((pos (point))
           (ppss (syntax-ppss pos)))
      (not
       (<span style="color: #4c83ff;">or</span> (car (<span style="color: #4c83ff;">setq</span> ppss (nthcdr 3 ppss)))
           (car (<span style="color: #4c83ff;">setq</span> ppss (cdr ppss)))
           (nth 3 ppss))))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-probe-org-speed-commands</span> ()
  <span style="color: #FBDE2D;">"&#28608;&#27963;&#36825;&#20010; Chinese-pyim &#25506;&#38024;&#20989;&#25968;&#21518;&#65292;&#21487;&#20197;&#35299;&#20915; org-speed-commands &#19982; Chinese-pyim &#20914;&#31361;&#38382;&#39064;&#12290;</span>

<span style="color: #FBDE2D;">&#29992;&#20110;&#65306;`</span><span style="color: #96CBFE;">pyim-english-input-switch-functions</span><span style="color: #FBDE2D;">' &#12290;"</span>
  (<span style="color: #4c83ff;">and</span> (string= major-mode <span style="color: #61CE3C;">"org-mode"</span>)
       (bolp)
       (looking-at org-heading-regexp)
       org-use-speed-commands))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-probe-isearch-mode</span> ()
  <span style="color: #FBDE2D;">"&#28608;&#27963;&#36825;&#20010; Chinese-pyim &#25506;&#38024;&#20989;&#25968;&#21518;&#65292;&#20351;&#29992; isearch &#25628;&#32034;&#26102;&#65292;&#31105;&#29992;&#20013;&#25991;&#36755;&#20837;&#65292;&#24378;&#21046;&#33521;&#25991;&#36755;&#20837;&#12290;</span>

<span style="color: #FBDE2D;">&#29992;&#20110;&#65306;`</span><span style="color: #96CBFE;">pyim-english-input-switch-functions</span><span style="color: #FBDE2D;">' &#12290;"</span>
  (<span style="color: #4c83ff;">and</span> pyim-isearch-enable-pinyin-search
       <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">isearch &#21551;&#21160;&#30340;&#26102;&#20505;&#65292;&#20250;&#35774;&#32622;&#19968;&#20010; buffer variable: `</span><span style="color: #96CBFE; font-style: italic;">isearch-mode</span><span style="color: #8B8989; font-style: italic;">'</span>
       <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#26816;&#27979;&#25152;&#26377; buffer &#20013; `</span><span style="color: #96CBFE; font-style: italic;">isearch-mode</span><span style="color: #8B8989; font-style: italic;">' &#30340;&#21462;&#20540;&#65292;&#22914;&#26524;&#20219;&#20309;&#19968;&#20010;</span>
       <span style="color: #8B8989; font-style: italic;">;; </span><span style="color: #8B8989; font-style: italic;">&#21462;&#20540;&#20026; t, &#23601;&#35828;&#26126; isearch &#24050;&#32463;&#21551;&#21160;&#12290;</span>
       (cl-some #'(lambda (buf)
                    (buffer-local-value 'isearch-mode buf))
                (buffer-list))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-probe-org-structure-template</span> ()
  <span style="color: #FBDE2D;">"&#28608;&#27963;&#36825;&#20010; Chinese-pyim &#25506;&#38024;&#20989;&#25968;&#21518;&#65292;&#36755;&#20837; org-structure-template &#26102;&#65292;&#19981;&#20250;&#24320;&#21551;&#20013;&#25991;&#36755;&#20837;&#12290;</span>

<span style="color: #FBDE2D;">&#29992;&#20110;&#65306;`</span><span style="color: #96CBFE;">pyim-english-input-switch-functions</span><span style="color: #FBDE2D;">' &#12290;"</span>
  (<span style="color: #4c83ff;">when</span> (eq major-mode 'org-mode)
    (<span style="color: #4c83ff;">let</span> ((line-string (buffer-substring (point-at-bol) (point))))
      (<span style="color: #4c83ff;">and</span> (looking-at <span style="color: #61CE3C;">"[ \t]*$"</span>)
           (string-match <span style="color: #61CE3C;">"^[ \t]*&lt;</span><span style="color: #E9C062;">\\</span><span style="color: #ff0000;">(</span><span style="color: #61CE3C;">[a-zA-Z]*</span><span style="color: #E9C062;">\\</span><span style="color: #ff0000;">)</span><span style="color: #61CE3C;">$"</span> line-string)))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-probe-dynamic-english</span> ()
  <span style="color: #FBDE2D;">"&#28608;&#27963;&#36825;&#20010; Chinese-pyim &#25506;&#38024;&#20989;&#25968;&#21518;&#65292;&#20351;&#29992;&#19979;&#38754;&#30340;&#35268;&#21017;&#21160;&#24577;&#20999;&#25442;&#20013;&#33521;&#25991;&#36755;&#20837;&#65306;</span>

<span style="color: #FBDE2D;">1. &#24403;&#21069;&#23383;&#31526;&#20026;&#20013;&#25991;&#23383;&#31526;&#26102;&#65292;&#36755;&#20837;&#19979;&#19968;&#20010;&#23383;&#31526;&#26102;&#40664;&#35748;&#24320;&#21551;&#20013;&#25991;&#36755;&#20837;</span>
<span style="color: #FBDE2D;">2. &#24403;&#21069;&#23383;&#31526;&#20026;&#20854;&#20182;&#23383;&#31526;&#26102;&#65292;&#36755;&#20837;&#19979;&#19968;&#20010;&#23383;&#31526;&#26102;&#40664;&#35748;&#24320;&#21551;&#33521;&#25991;&#36755;&#20837;</span>
<span style="color: #FBDE2D;">3. &#20351;&#29992; `</span><span style="color: #96CBFE;">pyim-convert-pinyin-at-point</span><span style="color: #FBDE2D;">' &#21487;&#20197;&#23558;&#20809;&#26631;&#21069;&#30340;&#25340;&#38899;&#23383;&#31526;&#20018;&#36716;&#25442;&#20026;&#20013;&#25991;&#65292;</span>
<span style="color: #FBDE2D;">   &#25152;&#20197;&#29992;&#25143;&#38656;&#35201;&#32473; `</span><span style="color: #96CBFE;">pyim-convert-pinyin-at-point</span><span style="color: #FBDE2D;">' &#32465;&#23450;&#19968;&#20010;&#24555;&#25463;&#38190;&#65292;&#27604;&#22914;&#65306;</span>

<span style="color: #FBDE2D;">   #+BEGIN_SRC elisp</span>
<span style="color: #FBDE2D;">   (global-set-key (kbd \"M-i\") 'pyim-convert-pinyin-at-point)</span>
</pre>
</div>

<p>
这个函数用于：`pyim-english-input-switch-functions' 。"
  (let ((str-before-1 (pyim-char-before-to-string 0)))
    (unless (string= (buffer-name) " <b>temp</b>") ; Make sure this probe can work with exim of exwm.
      (if (&lt;= (point) (save-excursion (back-to-indentation)
				      (point)))
	  (not (or (pyim-string-match-p "\\cc" (save-excursion
						 ;; 查找前一个非空格字符。
						 (if (re-search-backward "[^[:space:]\n]" nil t)
						     (char-to-string (char-after (point))))))
		   (&gt; (length pyim-current-key) 0)))
	(not (or (pyim-string-match-p "\\cc" str-before-1)
		 (&gt; (length pyim-current-key) 0)))))))
#+END_SRC
</p>
</div>
</div>

<div id="outline-container-org240b0d6" class="outline-3">
<h3 id="org240b0d6"><span class="section-number-3">2.2</span> 根据环境自动切换到半角标点输入模式</h3>
<div class="outline-text-3" id="text-2-2">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-probe-punctuation-line-beginning</span> (char)
  <span style="color: #FBDE2D;">"&#28608;&#27963;&#36825;&#20010; Chinese-pyim &#25506;&#38024;&#20989;&#25968;&#21518;&#65292;&#34892;&#39318;&#36755;&#20837;&#26631;&#28857;&#26102;&#65292;&#24378;&#21046;&#36755;&#20837;&#21322;&#35282;&#26631;&#28857;&#12290;</span>

<span style="color: #FBDE2D;">&#29992;&#20110;&#65306;`</span><span style="color: #96CBFE;">pyim-punctuation-half-width-functions</span><span style="color: #FBDE2D;">' &#12290;"</span>
  (<span style="color: #4c83ff;">let</span> ((line-string (buffer-substring (point-at-bol) (point))))
    (<span style="color: #4c83ff;">unless</span> (string= (buffer-name) <span style="color: #61CE3C;">" *temp*"</span>) <span style="color: #8B8989; font-style: italic;">; </span><span style="color: #8B8989; font-style: italic;">Make sure this probe can work with exim of exwm.</span>
      (<span style="color: #4c83ff;">and</span> (member (char-to-string char)
                   (mapcar 'car pyim-punctuation-dict))
           (string-match <span style="color: #61CE3C;">"^[ \t]*$"</span> line-string)))))

(<span style="color: #4c83ff;">defun</span> <span style="color: #ff1493;">pyim-probe-punctuation-after-punctuation</span> (char)
  <span style="color: #FBDE2D;">"&#28608;&#27963;&#36825;&#20010; Chinese-pyim &#25506;&#38024;&#20989;&#25968;&#21518;&#65292;&#21322;&#35282;&#26631;&#28857;&#21518;&#20877;&#36755;&#20837;&#19968;&#20010;&#26631;&#28857;&#31526;&#21495;&#26102;&#65292;&#24378;&#21046;&#36755;&#20837;&#21322;&#35282;&#26631;&#28857;&#12290;</span>

<span style="color: #FBDE2D;">&#29992;&#20110;&#65306;`</span><span style="color: #96CBFE;">pyim-punctuation-half-width-functions</span><span style="color: #FBDE2D;">' &#12290;"</span>
  (<span style="color: #4c83ff;">let</span> ((str-before-1 (pyim-char-before-to-string 0))
        (puncts (mapcar 'car pyim-punctuation-dict)))
    (<span style="color: #4c83ff;">and</span> (member str-before-1 puncts)
         (member (char-to-string char) puncts))))
</pre>
</div>
</div>
</div>
</div>

</div>
</div>
    <div>
      <div class="post-meta">
        <span title="post date" class="post-info">2016-06-19</span>
        <span title="last modification date" class="post-info">2016-06-19</span>
        <span title="tags" class="post-info">N/A</span>
        <span title="author" class="post-info">Feng Shu</span>
      </div>
      <section>
        <h1>Comments</h1>
        <div class="ds-thread"></div>
        <script type="text/javascript">
          var duoshuoQuery = {short_name:'tumashu-website'};
          (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = 'http://static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
          || document.getElementsByTagName('body')[0]).appendChild(ds);
          })();
        </script>
      </section>
      <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.x(<a href="http://orgmode.org">Org mode</a> 8.x)</p>
        <p>
          Copyright &copy; <span id="footerYear"></span> <a href="mailto:tumashu &lt;at&gt; 163 &lt;dot&gt; com">Feng Shu</a>
          &nbsp;&nbsp;-&nbsp;&nbsp;
          Powered by <a href="https://github.com/tumashu/org-webpage" target="_blank">org-webpage</a>
          <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
      </div>
    </div>

</div>
</body>
</html>
